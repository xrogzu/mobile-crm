function getAddAcctountDesc(t){$.ajax({url:apppath+"/wx/account/getDetail.action",dataType:"json",data:{scene:t},type:"GET",beforeSend:function(){},success:function(t){if(0==t.success&&(myAlert("加载数据失败，请稍后再试"),$(".load-shadow").hide()),1==t.success){$(".load-shadow").hide();var e=JSON.stringify(t);console.log(e);var n=t.entity.structure.components;$.each(n,function(t,e){customizItem($("#basic_info"),e,selectitmeObj)});var a=$("#dimDepart").find("button");a.html(userDepartName),a.attr("value",userDepartId);var i=$('<div class="footer"></div>');if(i.append('<button id="confirm" class="confirm">保存</button>'),i.append('<button id="add_contact" class="confirm">保存并添加联系人</button>'),$("body").append(i),confirm(),SelectItemPost(),textarea_num(),DummyItemPost(),checkboxItemPost(),dimdepart_choose(),parentAccountChoose(),ownerChoose(),$("textarea").autoHeight(),region(),btn_color_adjust(),btn_touch_style(),input_color_adjust(),input_adjust(),"set"==GetQueryString("type")){set_info();$("#accountName").find("input");$("#add_contact").remove(),$("#confirm").html("保存")}else setPost=!0;businessInfoQuery(),enterpriseinfoBack(),enterpriseinfoWrite(),enterpriseBack()}},complete:function(){},error:function(t){alert(t)}})}function region(){$("#region1").cityPicker({title:"省市区"})}function parentAccountChoose(){$("#parentAccountId").on("click",function(){checkTable("选择上级客户"),$.ajax({type:"get",url:apppath+"/wx/account/dolist.action",async:!0,dataType:"json",success:function(t){console.log("上级客户"+t),0==t.success?myAlert("网络不给力，请重新加载"):(accountData=t,create_parentAccount_list(t),$("#parentAccountId").attr("value",accountData.entity.records[0].id),$("#parentAccountId  button").html(accountData.entity.records[0].accountName))},error:function(){myAlert("网络不给力，请重新加载")}})})}function create_parentAccount_list(t){for(var e=$('<div class="container"></div>'),n=0,a=t.entity.records.length;a>n;n++){var i=$('<div class="item boxSizing"><em class="radio"><i></i></em><span>'+t.entity.records[n].accountName+"</span></div>");i.attr("value",t.entity.records[n].id),e.append(i)}$(".ct").append(e);for(var n=0,a=$(".ct .item").length;a>n;n++)$("#parentAccountId button").html()==$(".ct .item").eq(n).find("span").text()&&$(".ct .item").eq(n).find("em").addClass("active");$(".ct .item").each(function(e){$(this).on("click",function(){$(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active");var e=t.entity.records[$(this).index()].id,n=($(this).index(),t.entity.records[$(this).index()].accountName);$("#parentAccountId button").html(n),btn_color_adjust(),$("#parentAccountId button").attr("value",e),$(".ct").remove(),$("body").css({overflow:"scroll",height:"auto"})})})}function ownerChoose(){$("#ownerId").on("click",function(){checkTable("选择客户所有人"),$.ajax({type:"get",url:apppath+"/wx/xsyuser/pager.action",async:!0,dataType:"json",success:function(t){console.log("客户所有人"+t),0==t.success?myAlert("网络不给力，请重新加载"):(ownerData=t,create_owner_list(t),ownerPost&&($("#parentAccountId").attr("value",accountData.entity.records[0].id),$("#parentAccountId  button").html(accountData.entity.records[0].name)))},error:function(){myAlert("网络不给力，请重新加载")}})})}function create_owner_list(t){for(var e=$('<div class="container"></div>'),n=0,a=t.entity.records.length;a>n;n++){var i=$('<div class="item boxSizing"><em class="radio"><i></i></em><span>'+t.entity.records[n].name+"</span></div>");i.attr("value",t.entity.records[n].id),e.append(i)}$(".ct").append(e);for(var n=0,a=$(".ct .item").length;a>n;n++)$("#ownerId button").html()==$(".ct .item").eq(n).find("span").text()&&$(".ct .item").eq(n).find("em").addClass("active");$(".ct .item").each(function(e){$(this).on("click",function(){$(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active");var e=t.entity.records[$(this).index()].id,n=($(this).index(),t.entity.records[$(this).index()].name);$("#ownerId button").html(n),btn_color_adjust(),$("#ownerId button").attr("value",e),$(".ct").remove(),$("body").css({overflow:"scroll",height:"auto"})})})}function confirm(){function t(t){regingData()&&info_submit(t)}$("#confirm").on("click",function(){t()}),$("#add_contact").on("click",function(){t("add_contact")})}function info_submit(t){var e="";if("set"==GetQueryString("type")){e=apppath+"/wx/account/doupdate.action",console.log("更新接口");var n={id:GetQueryString("accountId")};$("#basic_info .item").each(function(){var t,e=$(this);if(e.find("input").size()){if("region"==e.attr("id")){var a=e.find("input").val(),i=a.split(" ");return n.state=i[0],n.city=i[1],void(n.region=i[2])}var s=e.attr("btype");if("ITEM_TYPE_INTEGER"==s&&""==e.find("input").val()||"ITEM_TYPE_REAL"==s&&""==e.find("input").val())return;t=e.find("input").val()}if(e.find("button").size()){var r=e.find("button");if(""==r.html()||"点击选择"==r.html())t=null;else if("ITEM_TYPE_CHECKBOX"==e.attr("btype")){var o=e.find("button").attr("value").split(",");t=0==o.length?[]:o,console.log(o)}else t=e.find("button").attr("value")}e.find("textarea").size()&&(t=e.find("textarea").val()),n[e.attr("id")]=t})}else{e=apppath+"/wx/account/docreate.action",console.log("创建接口");var n={};$("#basic_info .item").each(function(){var t,e=$(this);if(e.find("input").size()){if("region"==e.attr("id")){var a=e.find("input").val(),i=a.split(" ");return n.state=i[0],n.city=i[1],void(n.region=i[2])}t=e.find("input").val()}if(e.find("button").size()){var s=e.find("button");if(""==s.html()||"点击选择"==s.html())t=null;else if("ITEM_TYPE_CHECKBOX"==e.attr("btype")){var r=e.find("button").attr("value").split(",");t=0==r.length?[]:r,console.log(r)}else t=e.find("button").attr("value")}e.find("textarea").size()&&(t=e.find("textarea").val()),n[e.attr("id")]=t})}$.ajax({type:"post",url:e,data:{account:JSON.stringify(n)},dataType:"json",async:!0,beforeSend:function(){$(".confirm").attr("disabled","true"),loader()},success:function(e){$(".loaderArea").remove(),1==e.success?(myDialog("保存成功"),setTimeout(function(){if("add_contact"==t){var a=n.accountName,i=encodeURIComponent(a);location.replace(apppath+"/wx/contact/add.action?"+ddcommparams+"&from=acc_add&type=add&accountId="+e.entity.id+"&accountName="+i)}else{if("set"==GetQueryString("type"))var s=GetQueryString("accountId");else var s=e.entity.id;location.replace(apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+s)}},2e3)):0==e.success&&($(".confirm").removeAttr("disabled"),e.entity&&e.entity.status&&"0000001"==e.entity.status?myAlert("保存失败，客户名称已存在"):e.entity&&e.entity.status&&"0000002"==e.entity.status?myAlert("保存失败，不能包含表情符"):e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("保存失败，请检查输入信息"))},error:function(){$(".loaderArea").remove(),$(".confirm").removeAttr("disabled"),myAlert("网络不给力，请重新加载")}})}function set_info(){$.ajax({url:apppath+"/wx/account/getDetail.action",data:{accountId:GetQueryString("accountId"),scene:"UPDATE"},dataType:"json",success:function(t){$("#basic_info .item").each(function(){var e,n,a=$(this),i=set_infoSup(a.attr("id"),t);if("object"==typeof i?(e=i.text,n=i.value):e=n=i,a.find("input").size()){if("region"==a.attr("id")){var s=t.entity.data.state,r=t.entity.data.city,o=t.entity.data.region,c=s+" "+r+" "+o;return void(2==c.length?a.find("input").attr("placeholder","点击输入"):a.find("input").val(c))}a.find("input").val(n)}a.find("button").size()&&(a.find("button").attr("value",n),""===e?a.find("button").html("点击选择"):a.find("button").html(e)),a.find("textarea").size()&&a.find("textarea").val(n)}),btn_color_adjust(),$("textarea").autoHeight(),textarea_num()}})}function businessInfoQuery(){$(".entity-search").on("click",function(){var t=$("#accountName").find("input").val();""==t?myAlert("请输入查询客户名称"):($(".business-query-wrap").show(),$("html").css("overflow","hidden"),$("#search").find("input").val(t),create_word_list(t))})}function businessInfoBack(){$(".back").on("click",function(){$(".business-query-wrap").hide(),$("html").css("overflow","auto"),$("#search").find("input").val(""),$(".business-query-wrap .business-query-content").children().remove()})}function create_word_list(t){$.ajax({type:"get",url:apppath+"/wx/enterpriseinfo/dolist.action",async:!0,data:{enterpriseName:t},dataType:"json",success:function(e){console.log(e),0==e.success?myAlert("网络不给力，请重新加载"):($(".dialog").remove(),build_word_list(e,t))},error:function(){myAlert("网络不给力，请重新加载")}})}function build_word_list(t,e){if($(".business-query-content>.list").remove(),accLength=t.entity.length,accLength>0)var n=$('<div id="acc_area" class="boxSizing"></div>');if($("#acc_area").length>0&&$("#acc_area").remove(),$(".business-query-content").append(n),create_acc_list(e),0==accLength){$(".business-query-content>.list").remove();var a=document.createElement("div");a.style.cssText="width:100%;padding-left:10px;line-height:88px;font-size:30px;text-align:center;",a.className="list",a.innerHTML="无相关客户",$(".business-query-content").append(a)}}function create_acc_list(t){$.ajax({type:"get",url:apppath+"/wx/enterpriseinfo/dolist.action",async:!0,data:{enterpriseName:t},dataType:"json",success:function(e){0==e.success?myAlert("网络不给力，请重新加载"):($(".dialog").remove(),build_acc_list(e,t))},error:function(){myAlert("网络不给力，请重新加载")}})}function build_acc_list(t,e){for(var n=0,a=t.entity.length;a>n;n++){var i=document.createElement("div"),s=t.entity[n].name,r=new RegExp(e,"g"),o=t.entity[n].id;i.href=o,i.name=s,s=s.replace(r,"<span class='blue'>"+e+"</span><span class="+t.entity[n].type+"></span>"),i.innerHTML=s,i.className="boxSizing word_list",i.addEventListener("click",function(){$(".business-querydetail-wrap").show(),getBusinessInfo(this.name),$(".business-query-wrap").hide(),$("#search").find("input").val(""),$(".business-query-wrap .business-query-content").children().remove(),$("#basic_info").hide(),$("#confirm").hide(),$("add_contact").hide(),$("html,body").css("overflow","hidden")}),$("#acc_area").append(i)}}function getBusinessInfo(t){$.ajax({type:"get",url:apppath+"/wx/enterpriseinfo/get.action",async:!0,data:{enterpriseName:t},dataType:"json",success:function(t){0==t.success?myAlert("网络不给力，请重新加载"):($(".dialog").remove(),bulidEnterpriseinfo(t))},error:function(){myAlert("网络不给力，请重新加载")}})}function bulidEnterpriseinfo(t){if(console.log(t),t.entity.orgNo){enterpriseaccountName=t.entity.accountName,$(".business-search-name").html(enterpriseaccountName),$("#search-fddbr").html(t.entity.legalUser),$("#search-zczb").html(t.entity.registerFunds),detailAddress=t.entity.detailAddress,""==detailAddress?$("#detail_bgdz").html("暂无信息"):$("#detail_bgdz").html(detailAddress),phone=t.entity.phone,""==phone?$("#detail_tel").html("暂无信息"):$("#detail_tel").html(phone),$("#detail_fax").html("暂无信息");var e=t.entity.email;""==e?$("#detail_email").html("暂无信息"):$("#detail_email").html(e),website=t.entity.website,""==website?$("#detail_website").html("暂无信息"):$("#detail_website").html(website),$("#detail_weibo").html("暂无信息");var n=t.entity.regNo;""==n?$("#detail_regNo").html("暂无信息"):$("#detail_regNo").html(n);var a=t.entity.orgNo;""==a?$("#detail_orgNo").html("暂无信息"):$("#detail_orgNo").html(a);var i=t.entity.creditNo;""==i?$("#detail_creditNo").html("暂无信息"):$("#detail_creditNo").html(i);var s=t.entity.regiAuth;""==s?$("#detail_regiAuth").html("暂无信息"):$("#detail_regiAuth").html(s);var r=t.entity.regiStatus;""==r?$("#detail_regiStatus").html("暂无信息"):$("#detail_regiStatus").html(r);var o=t.entity.busiStartDate;""==o?$("#detail_busiStartDate").html("暂无信息"):$("#detail_busiStartDate").html(o);var c=t.entity.busiEndDate;""==c?$("#detail_busiEndDate").html("暂无信息"):$("#detail_busiEndDate").html(c);var d=t.entity.busiStartDate;""==d?$("#detail_busiBuildDate").html("暂无信息"):$("#detail_busiBuildDate").html(d);var l=t.entity.checkDate;""==l?$("#detail_checkDate").html("暂无信息"):$("#detail_checkDate").html(l),$("#detail_postcode").html("暂无信息");var u=t.entity.employees;$(".querydetail-parter-body").empty();for(var p=0,f=u.length;f>p;p++){var m=$('<div class="querydetail-parter-item"></div>'),h=$("<span>"+u[p].contactName+"</span>"),y=$("<span>"+u[p].contactPost+"</span>");m.append(y),m.append(h),$(".querydetail-parter-body").append(m)}var v=t.entity.changeRecords;$(".querydetail-changeRecords-body").empty();for(var p=0,f=v.length;f>p;p++){var m=$('<div class="querydetail-changeRecords-item"></div>'),b=v[p].changeDate,g=v[p].changeItem,_=v[p].beforeContent,w=v[p].afterContent,x=$("<span>"+b+"</span>"),A=$("<span>"+g+"</span><span>变更</span>"),D=$("<span>"+_+"</span>"),I=$("<span>"+w+"</span>");m.append(x),m.append(A),m.append(D),m.append(I),$(".querydetail-changeRecords-body").append(m)}}else{$(".business-querydetail-wrap").children().remove();var N=$('<div class="content-reminder"><div class="ico"><p>暂无信息</p></div></div>');$(".business-querydetail-wrap").append(N)}}function enterpriseinfoBack(){$(".querydetail-back").on("click",function(){$(".business-querydetail-wrap").hide(),$(".business-query-wrap").hide(),$("#search").find("input").val(""),$("#basic_info").show(),$("#confirm").show(),$("add_contact").show(),$("html,body").css("overflow","")})}function enterpriseinfoWrite(){$(".querydetail-write").on("click",function(){$(".business-querydetail-wrap").hide(),$(".business-query-wrap").hide(),$("#search").find("input").val(""),$("#basic_info").show(),$("#confirm").show(),$("add_contact").show(),$("html,body").css("overflow",""),$("#accountName").find("input").val(enterpriseaccountName),$("#address").find("input").val(detailAddress),$("#phone").find("input").val(phone),$("#url").find("input").val(website);var t=detailAddress.substring(0,10);$("#region").find("input").val(t)})}function enterpriseBack(){$("#back").on("click",function(){$(".business-query-wrap").hide(),$("html").css("overflow","")}),$(".querydetail-back").on("click",function(){$(".business-querydetail-wrap").hide(),$("#basic_info").show()})}$(document).on("ready",function(){"add"==GetQueryString("type")?getAddAcctountDesc("ADD"):"set"==GetQueryString("type")&&(document.title="修改客户",getAddAcctountDesc("UPDATE")),$("textarea").autoHeight(),xsyUser||alert("获取当前用户失败"),$("input").each(function(){$(this).on("click",function(){$(this).hasClass("warn")&&remove_warn($(this))})})});var reg_accountName=/^.{1,50}$/,reg_tel=/^\d+|[-#*]{0,30}$/,reg_address=/^.{0,250}$/,reg_fax=/^.{0,30}$/,selectitmeObj={},userDepartId=xsyUser.departId,userDepartName=xsyUser.departmentName,postData,setPost=!1,accountData,accountPost=!1,ownerData,ownerPost=!1,ownerId=xsyUser.id,searchAccountName,accLength,enterpriseaccountName,detailAddress,phone,website;