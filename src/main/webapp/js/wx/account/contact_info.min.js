function linkMore(){$(".link_more").on("click",function(){$(".options").toggle()})}function toContactList(){$(".ct").length>0?memberChange?myChoose("",ctRemove):ctRemove():"opp_info"==GetQueryString("from")?location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId"):"con_info"==GetQueryString("from")?location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId"):"acc_info"==GetQueryString("from")?location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId"):"index"==GetQueryString("from")?GetQueryString("page")?location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page"):location.href=apppath+"/wx/statics/index.action?"+ddcommparams:location.href=apppath+"/wx/contact/list.action?"+ddcommparams}function ctRemove(){$("body").css("height",""),$("body").css("overflow",""),top_nav(),$(".ct").remove(),set_title("客户信息"),set_right("更多",more)}function more(){$("#area").length>0?$("#area").remove():($("#new_business").on("click",function(){console.log("跳转到新建商机页面"),location.href=apppath+"/wx/opportunity/add.action?"+ddcommparams+"&from=con_info&type=add&accountId="+accountId+"&contactId="+GetQueryString("contactId")}),$("#set_contact").on("click",function(){location.href=apppath+"/wx/contact/add.action?"+ddcommparams+"&type=set&from=con_info&contactId="+GetQueryString("contactId")}),$("#delete_contact").on("click",function(){delete_dialog()}))}function delete_dialog(){var t=$('<div class="delShadow"><div class="dia"><p class="boxSizing">确定删除吗?</p><div class="confirm"><div class="no">取消</div><div class="yes boxSizing">确认</div></div></div></div>');$("body").append(t),$(".dia").css({top:"200px",left:($(window).width()-$(".dia").width())/2}),$(".yes").on("click",function(){$(".delShadow").remove(),delete_contact(),$(".delShadow").remove()}),$(".no").on("click",function(){$(".delShadow").remove()})}function delete_contact(){$.ajax({url:apppath+"/wx/contact/dodel.action",data:{contactId:GetQueryString("contactId")},async:!1,dataType:"json",success:function(t){t.success?($(".shadow").remove(),myDialog("删除成功"),location.href=apppath+"/wx/contact/list.action?"+ddcommparams):myAlert("删除失败")},error:function(){myAlert("网络不给力，请重新加载")}})}function top_nav(){$(window).on("scroll",function(){ceilingJudge()})}function ceilingJudge(){$("body").scrollTop()>=nav_top+120?($(".common").css("marginBottom",nav_height+20+"px"),$("#topNav").css({position:"fixed",top:0})):($(".common").css("marginBottom",0),$("#topNav").css({position:"static"}))}function nav(){$("#nav li").each(function(){$(this).on("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active"),tab($(this).attr("href"))})})}function tab(t){if($("html, body").animate({scrollTop:0},300),$("#topNav").css({position:"",top:"",bottom:""}),$(".common").css({paddingBottom:"",position:"relative"}),$(".info_tab").fadeOut(300),"记录"==t){if(0==$("#record_tab").length){$(".tab").length>0&&$(".tab").remove();var o=$('<ul id="record_tab" class="tab record"><div class="main boxSizing"></div></ul>');$("body").append(o),recordPageNo=0,get_record($("#record_tab > .main"),20,"tab"),$("#record_tab").fadeIn(300)}}else if("商机"==t){if(0==$("#opportunity_tab").length){$(".tab").length>0&&$(".tab").remove();var o=$('<ul id="opportunity_tab" class="tab opportunity"><div class="main boxSizing"></div></ul>');$("body").append(o),opportunityPageNo=0,get_opportunity($("#opportunity_tab > .main"),20,"tab"),$("#opportunity_tab").fadeIn(300)}}else if("详情"==t&&0==$("#info_tab").length){$(".tab").length>0&&$(".tab").remove();var o=$('<ul id="info_tab" class="tab details"><div class="main boxSizing"></div></ul>');$("body").append(o),get_info($("#info_tab > .main")),$("#info_tab").fadeIn(300)}}function get_record(t,o,e){$.ajax({url:apppath+"/wx/activityrecord/dolist.action",data:{belongId:2,objectId:GetQueryString("contactId"),pagesize:o,pageNo:recordPageNo},dataType:"json",success:function(o){if(console.log("跟进记录："+o),1==o.success)if(0==o.entity.records.length)t.css("border",0),t.append(reminderHtml),console.log("该对象暂无跟进记录");else{if(o.entity.totalSize>5){if(0==$("#recordList .more").length){var a=$('<a class="more"></a>');$("#recordList > .top").append(a)}$("#recordList .more").on("click",function(){$("#nav > .record").addClass("active"),$("#nav > .record").siblings().removeClass("active"),tab($("#nav > .record").attr("href"))})}var n=o.entity.totalSize;build_record_list(t,o),t.find("li").length<n&&"tab"==e?($("#loading").remove(),build_end(t,"加载更多","load_more"),recordPageNo++,scroll_load(t,get_record)):$("#loading").remove()}else o.entity&&o.entity.status&&"0000003"==o.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("网络不给力，请重新加载")},error:function(){myAlert("网络不给力，请重新加载")}})}function build_record_list(t,o){for(var e=o.entity.records,a=0,n=e.length;n>a;a++){var i=e[a].user.userName,c=e[a].typeName,r=e[a].objectName,s=e[a].belongId,d=e[a].objectId,l=e[a].startTime.substr(-5),p=e[a].startTime.substr(0,11),m=e[a].recordType.type;if(0==a||e[a].startTime.substr(0,11)!=e[a-1].startTime.substr(0,11)){var u=$('<div class="day"><em></em><p class="startDate">'+p+'</p><div class="ban"></div></div>');t.append(u)}var f=$('<li class="boxSizing"><div class="info"><span class="userName">'+i+'</span><span class="typeName">'+c+':</span><span class="objectName">'+r+'</span><span class="startTime">'+l+"</span></div></li>");if(f.find(".objectName").attr({belongId:s,objectId:d}),d!=GetQueryString("contactId")&&f.find(".objectName").on("click",function(){var t;1==$(this).attr("belongId")?t=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=con_info&rcontactId="+GetQueryString("contactId"):2==$(this).attr("belongId")?t=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=con_info&rcontactId="+GetQueryString("contactId"):3==$(this).attr("belongId")&&(t=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=con_info&rcontactId="+GetQueryString("contactId")),location.href=t}),"TEL"==m?f.addClass("phone_bg"):"SIGN_IN"==m?f.addClass("sign_in_bg"):"RECORD"==m&&f.addClass("record_bg"),e[a].content){var y=e[a].content,g=$('<span class="content_span">'+y+"</span>"),h=$('<div class="content"></div>'),v=$('<em class="triangle"></em>');if(h.append(g),h.append(v),y.length>32){var _=y.substr(0,30)+"...",b=$('<span class="short_content_span">'+_+"</span>");h.append(b),g.css("display","none");var I=0,x=$('<em class="more"></em>');x.on("click",function(){I++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*I)+"deg)")}),h.append(x)}f.append(h)}if(e[a].location){var w=$('<div class="location">'+e[a].location+"</div>");f.append(w)}var S=$('<div class="bottom_border"></div>');f.append(S),t.append(f)}}function get_opportunity(t,o,e){var a=setInterval(function(){null!=accountId&&($.ajax({url:apppath+"/wx/opportunity/dolist.action",data:{accountId:accountId,pageNo:opportunityPageNo,pagesize:o},dataType:"json",success:function(o){if(console.log("商机："+o),1==o.success)if(0==o.entity.records.length)t.css("border",0),t.append(reminderHtml),console.log("该对象暂无商机信息");else{if(o.entity.totalSize>3){if(0==$("#opportunityList .more").length){var a=$('<a class="more"></a>');$("#opportunityList > .top").append(a)}$("#opportunityList .more").on("click",function(){$("#nav > .chance").addClass("active"),$("#nav > .chance").siblings().removeClass("active"),tab($("#nav > .chance").attr("href"))})}var n=o.entity.totalSize;$("#opportunityList > .top > .title").text("商机("+n+")"),$("#opportunity_tab > .top").length>0&&$("#opportunity_tab > .top").text("商机("+n+")"),$("#nav > .chance").text("商机("+n+")"),build_opportunity(t,o),t.find("li").length<n&&"tab"==e?($("#loading").remove(),build_end(t,"加载更多","load_more"),opportunityPageNo++,scroll_load(t,get_opportunity)):$("#loading").remove()}else 0==o.success&&(o.entity&&o.entity.status&&"0000003"==o.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("网络不给力，请重新加载"))},error:function(t,o){myAlert("网络不给力，请重新加载")}}),clearInterval(a))},30)}function build_opportunity(t,o){for(var e=0,a=o.entity.records.length;a>e;e++){var n=o.entity.records[e],i=n.saleStageText,c=n.opportunityName,r=n.money,s=n.accountName,d=n.id,l=n.saleStageOrder,p=n.saleStagePercentage,m=$('<li class="boxSizing"><em class="icon jieduan'+l+'"></em><div class="info"><div class="top"><span class="opportunityName">'+c+'</span><span class="Money">'+r+'元</span></div><div class="bot"><p class="accountName">'+s+'</p><p class="jieduan">阶段：'+i+'</p><span class="jieduan_p">'+p+"%</span></div></div></li>");m.attr("value",d),m.on("click",function(){location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("value")+"&from=con_info&rcontactId="+GetQueryString("contactId")}),t.append(m)}}function icon_word(t){return/^[\u4e00-\u9fa5]+$/.test(t.substr(0,1))?t.substr(-2):t.substr(0,2)}function get_info(t){$.ajax({url:apppath+"/wx/contact/getDetail.action",data:{contactId:GetQueryString("contactId"),scene:"DETAIL"},dataType:"json",success:function(o){$(".load-shadow").hide(),console.log(o),1==o.success?(dataPermission=o.entity.expandPro.dataPermission,build_info(t,o),ownerName=o.entity.data.contactName,accountName=o.entity.expandPro.accountIdText,post=o.entity.data.post,$(".common .head_pic").html(icon_word(ownerName)),$(".common .contactName").html(ownerName),$(".common .accountName").html(accountName),$(".common .post").text(post),accountId=o.entity.data.accountId,dataPermission.transfer?change_owner():$(".owner").css("background","none"),dataPermission.update||$(".member").css("background","none"),"false"==dataPermission["delete"]&&($("#set_contact").parent().hide(),$("#delete_contact").parent().hide()),accountName=o.entity.data.accountName,null!=o.entity.data.phone?$("footer > .tel").attr("href","tel:"+o.entity.data.phone):$("footer > .tel").attr("href","")):"300032"==o.errorCode?"opp_info"==GetQueryString("from")?location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=con_deleted":"con_info"==GetQueryString("from")?location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=con_deleted":"acc_info"==GetQueryString("from")?location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=con_deleted":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=con_deleted":location.href=apppath+"/wx/statics/index.action?"+ddcommparams):o.entity&&o.entity.status&&"0000003"==o.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:o.entity&&o.entity.status&&"0000004"==o.entity.status?"opp_info"==GetQueryString("from")?location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=con_noright":"con_info"==GetQueryString("from")?location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=con_noright":"acc_info"==GetQueryString("from")?location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=con_noright":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=con_noright":location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&err=con_noright"):myAlert("网络不给力，请重新加载")},error:function(){myAlert("网络不给力，请重新加载")}})}function build_info(t,o){t.children().remove();for(var e,a='<span style="color:#8fa1b2">未填写</span>',n=o.entity.structure.components,i=0,c=n.length;c>i;i++){e=set_infoSup(n[i].propertyName,o);var r,s;"ownerId"==n[i].propertyName||"createdBy"==n[i].propertyName||"updatedBy"==n[i].propertyName?(r=e.text,s=e.value,""==s?info_atom_build(t,n[i].label,a,n[i].propertyName,n[i].type):info_atom_build(t,n[i].label,r,n[i].propertyName,n[i].type)):"object"==typeof e?(r=e.text,s=e.value,""==s?info_atom_build(t,n[i].label,a,n[i].propertyName,n[i].type):"gender"==n[i].propertyName?(1==s&&info_atom_build(t,n[i].label,"男",n[i].propertyName,n[i].type),2==s&&info_atom_build(t,n[i].label,"女",n[i].propertyName,n[i].type)):info_atom_build(t,n[i].label,r,n[i].propertyName,n[i].type)):(r=s=e,""==s?info_atom_build(t,n[i].label,a,n[i].propertyName,n[i].type):info_atom_build(t,n[i].label,e,n[i].propertyName,n[i].type))}if(""!=e){var d=e;if(d.length>32){var l=d.substr(0,30)+"...",p=$('<span class="short_content_span">'+l+"</span>");content.append(p),content_span.css("display","none");var m=0,u=$('<em class="more"></em>');u.on("click",function(){m++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*m)+"deg)")}),content.append(u)}$(".staff .commentAtom").remove()}}function info_atom_build(t,o,e,a,n){var i='<span style="color:#8fa1b2">未填写</span>';if(""!=a){if("mobile"==a){if(e==i)var c=$('<li class="atom boxSizing" id='+a+'><span class="label">'+o+'：</span><span class="value blue"><a href="tel:"> '+e+"</a></span></li>");else var c=$('<li class="atom boxSizing" id='+a+'><span class="label">'+o+'：</span><span class="value blue"><a href="tel:'+e+'"> '+e+"</a></span></li>");c.on("click",function(){location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=con_info&contactId="+GetQueryString("contactId")})}else if("phone"==a){if(e==i)var c=$('<li class="atom boxSizing" id='+a+'><span class="label">'+o+'：</span><span class="value blue"><a href="tel:"> '+e+"</a></span></li>");else var c=$('<li class="atom boxSizing" id='+a+'><span class="label">'+o+'：</span><span class="value blue"><a href="tel:'+e+'"> '+e+"</a></span></li>");c.on("click",function(){location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=con_info&contactId="+GetQueryString("contactId")})}else if("accountId"==a){console.log(accountId);var c=$('<li class="atom boxSizing" id='+a+'><span class="label">'+o+'：</span><span class="value blue">'+e+"</span></li>");c.find(".value").on("click",function(){location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+accountId+"&from=con_info&rcontactId="+GetQueryString("contactId")})}else var c=$('<li class="atom boxSizing" id='+a+'><span class="label">'+o+'：</span><span class="value">'+e+"</span></li>");t.append(c)}}function change_owner(){$(".staff .owner").on("click",function(){get_owner_list()})}function get_owner_list(){$.ajax({type:"get",url:apppath+"/wx/xsyuser/pager.action",async:!0,dataType:"json",success:function(t){if($(".load-shadow").hide(),0==t.success)myAlert("数据加载出错");else if(1==t.entity.records.length){var o=$('<div class="no_contact">您的客户下暂时没有其他员工</div>');$("body").append(o),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("转移给他人");var e=$('<ul id="container" class="container ownerContainer"></ul>');$(".ct").append(e),build_owner_list(e,t)}}})}function build_owner_list(t,o){for(var e=0,a=o.entity.records.length;a>e;e++){if(o.entity.records[e].name==$("#infoList .owner > .value").text())var n=$('<div class="item"><em class="radio active"><i></i></em><span>'+o.entity.records[e].name+"</span></div>");else var n=$('<div class="item"><em class="radio"><i></i></em><span>'+o.entity.records[e].name+"</span></div>");t.append(n)}radio_click(o)}function radio_click(t){$(".ct .item").each(function(o){$(this).on("click",function(){function o(){$.ajax({url:apppath+"/wx/contact/trans.action",data:{contactId:GetQueryString("contactId"),ownerid:e},beforeSend:function(){loader()},dataType:"json",success:function(t){$(".loaderArea").remove(),setTimeout(function(){ctRemove()},2e3),1==t.success?($(".owner > .value").text(a),myDialog("负责人更改成功"),ownerId=e):myAlert("负责人更改失败")},error:function(){$(".loaderArea").remove(),myAlert("请检查网络")}})}$(this).find("em").hasClass("active")||($(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active"));var e=t.entity.records[$(this).index()].id,a=t.entity.records[$(this).index()].name;doChangeOwner(a,o)})})}function create_confirm(t){var o=$('<button id="confirm" class="confirm">确定</button>');$(".ct").append(o),o.on("touchstart",function(){$(this).addClass("touching")}),o.on("touchend",function(){$(this).removeClass("touching")}),o.on("click",function(){var t=[];$(".item").each(function(){$(this).find("em").hasClass("active")&&t.push($(this).attr("value"))}),console.log("团队成员提交"+t.join(",")),$.ajax({type:"post",url:apppath+"/wx/group/setrelateowner.action",data:{businessId:GetQueryString("contactId"),belongs:2,setOwnerIds:t.join(",")},async:!0,dataType:"json",success:function(t){setTimeout(function(){$(".ct").remove(),$("body").css({height:"",overflow:""}),set_title("客户信息")},2e3),1==t.success?(console.log("团队成员提交成功："+t),myDialog("更改成功")):myAlert("更改失败")},error:function(t){myAlert("网络不给力，请重新加载")}})})}function footer_phone(){$("footer > .tel").on("click",function(){$.ajax({url:apppath+"/wx/contact/getDetail.action",data:{contactId:GetQueryString("contactId"),scene:"DETAIL"},dataType:"json",success:function(t){if(""==t.entity.data.mobile&&""==t.entity.data.phone){var o=$('<div class="no_contact">联系人无联系方式，请添加联系方式</div>');$("body").append(o),setTimeout(function(){$(".no_contact").remove(),$(".tel_bg").remove()},2e3)}else{$(window).scrollTop(0);var e=$('<div class="tel_bg"></div>');e.on("click",function(){$(".tel_bg").remove(),$("#tel_list").remove()}),$("body").append(e),$(".tel_bg").css("top",$(document).scrollTop()),$(".tel_bg").fadeIn(200);var a=$('<div id="tel_list"></div>');add_atom(a,t.entity.data.mobile,"手机"),add_atom(a,t.entity.data.phone,"家庭电话");var n=$('<div id="rtn_btn">取消</div>');n.on("click",function(){$("body").css({overflow:"",height:""}),$(".tel_bg").remove(),$("#tel_list").animate({bottom:-$("#tel_list").height()},300),setTimeout(function(){$("#tel_list").remove()},300)}),a.append(n),$("body").append(a),$("body").css({overflow:"hidden",height:"100%"}),$("#tel_list").on("touchmove",function(t){t.stopPropagation()}),$("#tel_list").css({bottom:-$("#tel_list").height()}),$("#tel_list").animate({bottom:"0"},300)}}})})}function add_atom(t,o,e){if(o&&""!=o){var a=$('<a href="tel:'+o+'" class="tel_atom"><span class="label">'+e+'</span><span class="value">'+o+"</span></a>");a.on("click",function(){location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=con_info&contactId="+GetQueryString("contactId")}),t.append(a)}}function footer_signin(){$("footer > .signin").on("click",function(){location.href=apppath+"/wx/activityrecord/qiandao.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.SIGN_IN+"&from=con_info&contactId="+GetQueryString("contactId")})}function footer_create_record(){$("footer > .record").on("click",function(){location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.RECORD+"&from=con_info&contactId="+GetQueryString("contactId")})}function build_end(t,o,e){var a=$('<div id="'+e+'" class="end_info">'+o+"</div>");t.append(a)}function scroll_load(t,o){var e=document.body.clientHeight;$(window).on("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=e-$("#load_more").height()-50&&($("#load_more").remove(),build_end(t,"加载中…","loading"),o(t,20),$(this).unbind("scroll"),top_nav())})}$(function(){$("body").on("click",function(){$("#area").length>0&&$("#area").remove()}),$("body").on("touchmove",function(){$("#area").length>0&&$("#area").remove()}),change_owner(),linkMore(),more(),set_cir_color($("header .head_pic")),top_nav(),nav(),get_record($("#recordList > .main"),5),get_opportunity($("#opportunityList > .main"),3),get_info($("#infoList > .main")),footer_phone(),footer_signin(),footer_create_record();var t=$('<ul id="info_tab" class="tab details"><div class="main boxSizing"></div></ul>');$("body").append(t),get_info($("#info_tab > .main")),$("#info_tab").fadeIn(300)});var reminderHtml='<div class="content-reminder"><div class="ico"><p>暂无数据</p></div></div>';$(document).on("touchstart",function(t){$(t.target).closest(".link_more").size()||$(".options").hide()}),$(document).on("click",function(t){$(t.target).closest(".link_more").size()||$(".options").hide()});var nav_top=$("#topNav").offset().top,nav_top=$("#topNav").offset().top,nav_height=$("#topNav").height(),recordPageNo=0,accountId,opportunityPageNo=0,ownerId,dataPermission,ownerName,memberChange=!1;