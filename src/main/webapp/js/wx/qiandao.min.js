function use_map(){$("#my_position").bind("click",function(){wx.ready(function(){wx.getLocation({type:"gcj02",success:function(t){lon=t.longitude,lat=t.latitude,accuracy=t.accuracy;var a=new AMap.Map("container",{resizeEnable:!0,center:[116.397428,39.90923],zoom:15});a.setZoomAndCenter(14,[116.205467,39.907761]);new AMap.Marker({map:a,position:[116.205467,39.907761]});a.plugin(["AMap.ToolBar"],function(){var t=new AMap.ToolBar;a.addControl(t)}),AMap.service(["AMap.PlaceSearch"],function(){var t=new AMap.PlaceSearch({pageSize:10,pageIndex:1,map:a,panel:"panel"}),e=[lon,lat];t.searchNearBy("",e,200,function(t,a){var e=a.poiList.pois[0].address;console.log(e),$(".poi-more").remove(),confirm(),$("#my_position .value").text(e),poibox_fix(),console.log(a)})})},cancel:function(t){alert("用户拒绝请求地理定位")}})}),$("#container").show(),$("#panel").show()})}function closeMap(){$("#container").hide(),$("#panel").hide()}function back(){"block"==$("#panel").css("display")?closeMap():"acc_list"==GetQueryString("from")?location.replace(apppath+"/wx/account/list.action?"+ddcommparams):"acc_info"==GetQueryString("from")?location.replace(apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("accountId")):"con_info"==GetQueryString("from")?location.replace(apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("contactId")):history.back()}function poibox_fix(){$("#panel .poibox").bind("click",function(){closeMap(),$("#my_position .value").text($(this).find(".poi-addr").text().substr(3)),$(this).css("background","#eee"),$(this).siblings().css("background","#fff")})}function get_date(){var t=new Date,a=t.getFullYear(),e=t.getMonth()+1,o=t.getDate(),n=t.getHours(),c=t.getMinutes();10>e&&(e="0"+String(e)),10>o&&(o="0"+String(o)),10>n&&(n="0"+String(n)),10>c&&(c="0"+String(c)),$("#current_time > .value").text(a+"年"+e+"月"+o+"日  "+n+":"+c)}function getObjectName(){switch(belongId){case 1:$.ajax({url:apppath+"/wx/account/getDetail.action",data:{accountId:objectId,scene:"DETAIL"},dataType:"json",success:function(t){console.log("详情"+t);var a=t.entity.data.accountName;$("#account .value").text(a)}});break;case 2:$.ajax({url:apppath+"/wx/contact/getDetail.action",data:{contactId:objectId,scene:"DETAIL"},dataType:"json",success:function(t){console.log(t);var a=t.entity.data.contactName;$("#account .value").text(a)}});break;case 3:$.ajax({url:apppath+"/wx/opportunity/getDetail.action",data:{opportunityId:objectId,scene:"DETAIL"},dataType:"json",success:function(t){var a=t.entity.data.opportunityName;$("#account .value").text(a)}})}}function confirm(){$("#confirm").unbind("click").bind("click",function(){var t=$("#textarea").val();if(""==t)myAlert("请填写备注");else{var a={content:t,belongId:belongId,activityTypeId:activityTypeId,objectId:objectId};a.position={longitude:lon,latitude:lat,location:$("#my_position .value").text(),locationDetail:$("#my_position .value").text()},create_record({activityRecordDtoString:JSON.stringify(a)},$("#confirm"))}})}$(window).bind("load",function(){use_map(),$("textarea").autoHeight(),remove_rTop(),get_date(),getObjectName(),textarea_num(),btn_touch_style()});var lon,lat,accuracy;wx.ready(function(){control_back(back);var t=$('<div class="waiting">定位中，请稍后...</div>');$("body").append(t),wx.getLocation({type:"gcj02",success:function(t){lon=t.longitude,lat=t.latitude,accuracy=t.accuracy,$(".waiting").remove();var a=new AMap.Map("container",{resizeEnable:!0,center:[116.397428,39.90923],zoom:15});a.setZoomAndCenter(14,[116.205467,39.907761]);new AMap.Marker({map:a,position:[116.205467,39.907761]});a.plugin(["AMap.ToolBar"],function(){var t=new AMap.ToolBar;a.addControl(t)}),AMap.service(["AMap.PlaceSearch"],function(){var t=new AMap.PlaceSearch({pageSize:10,pageIndex:1,map:a,panel:"panel"}),e=[lon,lat];t.searchNearBy("",e,200,function(t,a){var e=a.poiList.pois[0].address;console.log(e),$(".poi-more").remove(),confirm(),$("#my_position .value").text(e),poibox_fix(),console.log(a)})})},cancel:function(t){alert("用户拒绝请求地理定位")}})});var belongId=Number(GetQueryString("belongId")),objectId=GetQueryString("objectId"),activityTypeId=GetQueryString("activityTypeId"),source=0,u=navigator.userAgent,isAndroid=u.indexOf("Android")>-1||u.indexOf("Adr")>-1,isiOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);isAndroid?source=1:isiOS&&(source=2);