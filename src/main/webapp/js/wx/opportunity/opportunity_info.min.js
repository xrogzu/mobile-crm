function linkMore(){$(".link_more").on("click",function(){$(".options").toggle()})}function more(){$("#saleStage").hide(),$(".shadow").hide(),$("#area").length>0?$("#area").remove():($("#relevance_contact").on("click",function(){$("#area").remove(),relevance_contact()}),$("#set_opportunity").on("click",function(){$("#area").remove(),location.href=apppath+"/wx/opportunity/add.action?"+ddcommparams+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")+"&type=set"}),$("#delete_opportunity").on("click",function(){$("#area").remove(),delete_dialog()}))}function relevance_contact(){$.ajax({url:apppath+"/wx/contact/dolist.action",data:{pageNo:0,pogesize:20,accountId:accountId},dataType:"json",success:function(t){if(0==t.success)myAlert("网络不给力，请重新加载");else if(console.log("关联联系人："+t),0==t.entity.records.length){var e=$('<div class="no_contact">暂无联系人可关联，请添加联系人</div>');$("body").append(e),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("关联联系人");var o=$('<div id="container" class="container"></div>');$(".ct").addClass("staff-warp"),$(".ct").append(o),build_member_list(o,t,apppath+"/wx/opportunity/setcontacts.action")}}})}function delete_dialog(){var t=$('<div class="delShadow"><div class="dia"><p class="boxSizing">确定删除吗?</p><div class="confirm"><div class="no">取消</div><div class="yes boxSizing">确认</div></div></div></div>');$("body").append(t),$(".dia").css({top:"200px",left:($(window).width()-$(".dia").width())/2}),$(".yes").on("click",function(){delete_opportunity(),$(".delShadow").remove()}),$(".no").on("click",function(){$(".delShadow").remove()})}function delete_opportunity(){$.ajax({url:apppath+"/wx/opportunity/dodel.action",data:{opportunityId:GetQueryString("opportunityId")},dataType:"json",success:function(t){1==t.success&&0==t.entity.status?(myDialog("删除成功"),time_out_location(apppath+"/wx/opportunity/list.action?"+ddcommparams)):myAlert("删除失败")}})}function saleStagePush(){$("#opportunityInfo .salesStageSelect").on("click",function(){$(window).scrollTop(0),$(".shadow").fadeIn(),$("#saleStage").fadeIn(),$("#saleStage #exitSaleStage").on("click",function(){$("#saleStage").fadeOut(),$(".shadow").fadeOut()}),0==$("#saleStage .bottom li").length&&$.ajax({url:apppath+"/wx/opportunity/getSaleStage.action",dataType:"json",success:function(t){if(console.log(t),1==t.success){$("#saleStage .bottom").children().remove();for(var e=0,o=t.entity.length;o>e;e++){var a=$('<li><em></em><span class="label">'+t.entity[e].label+'</span><span class="percent">'+t.entity[e].percent+"%</span></li>");$("#saleStage .bottom").append(a),a.attr("value",t.entity[e].value),a.on("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active");var t=$(this).attr("value");change_stage(t)})}$("#saleStage .bottom li").eq(order-1).addClass("active")}}})})}function change_stage(t){var t=Number(t),e={};e.id=Number(GetQueryString("opportunityId")),e.saleStageId=t,$.ajax({url:apppath+"/wx/opportunity/doupdate.action",data:{opportunity:JSON.stringify(e)},beforeSend:function(){loader()},dataType:"json",success:function(t){$(".loaderArea").remove(),1==t.success?(myDialog("保存成功"),get_info($("")),setTimeout(function(){$("#saleStage").fadeOut(),$(".shadow").fadeOut()},2e3)):(myDialog("保存失败","without"),$("#saleStage").fadeOut(),$(".shadow").fadeOut())},error:function(){$(".loaderArea").remove(),myAlert("请检查网络")}})}function closeStage(){"block"==$("#saleStage").css("display")?($("#saleStage").fadeOut(),$(".shadow").fadeOut()):$(".ct").length>0?memberChange?myChoose("",ctRemove):ctRemove():"opp_info"==GetQueryString("from")?location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId"):"con_info"==GetQueryString("from")?location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId"):"acc_info"==GetQueryString("from")?location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId"):"index"==GetQueryString("from")?GetQueryString("page")?location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page"):location.href=apppath+"/wx/statics/index.action?"+ddcommparams:location.href=apppath+"/wx/opportunity/list.action?"+ddcommparams}function ctRemove(){$("body").css("height",""),$("body").css("overflow",""),ceilingJudge(),$(".ct").remove(),set_title("商机详情"),set_right("更多",more)}function drawCircle(t){var e=$("#picture").width()/2;$("#circle").attr({height:2*e,width:2*e});var o=document.getElementById("circle").getContext("2d");o.beginPath(),o.arc(e,e,e-14,0*Math.PI,2*Math.PI,!1),o.lineWidth=25,0==t?o.strokeStyle="#ff5747":o.strokeStyle="#e1e8ed",o.stroke(),o.closePath();var t=1.5+t/100*2;o.beginPath(),o.arc(e,e,e-14,1.5*Math.PI,Math.PI*t,!1),o.lineWidth=25,o.strokeStyle="#22d2a6",o.stroke(),o.closePath()}function top_nav(){$(window).on("scroll",function(){ceilingJudge()})}function ceilingJudge(){$("body").scrollTop()>=nav_top+120?($("#opportunityInfo").css("marginBottom",nav_height+20+"px"),$("#topNav").css({position:"fixed",top:0})):($("#opportunityInfo").css("marginBottom",0),$("#topNav").css({position:"static"}))}function nav(){$("#nav li").each(function(){$(this).on("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active"),tab($(this).attr("href"))})})}function tab(t){if($("html, body").animate({scrollTop:0},300),$("#opportunityInfo").css("marginBottom",0),$("#topNav").css({position:"static"}),$(".content").fadeOut(300),$("#opportunityInfo").css("marginBottom",0),$("#topNav").css({position:"static"}),$(".content").fadeOut(300),"联系人"==t){if(0==$("#contact_tab").length){$(".tab").length>0&&$(".tab").remove();var e=$('<ul id="contact_tab" class="tab contact contactArea"><div class="main boxSizing"></div></ul>');$("body").append(e),contactPageNo=0,get_contacts($("#contact_tab > .main"),20,"tab"),$("#contact_tab").fadeIn(300)}}else if("记录"==t){if(0==$("#record_tab").length){$(".tab").length>0&&$(".tab").remove();var e=$('<ul id="record_tab" class="tab record recordArea"><div class="main boxSizing"></div></ul>');$("body").append(e),recordPageNo=0,get_record($("#record_tab > .main"),20,"tab"),$("#record_tab").fadeIn(300)}}else if("详情"==t){if(0==$("#info_tab").length){$(".tab").length>0&&$(".tab").remove();var e=$('<ul id="info_tab" class="tab details infoArea"><div class="staff boxSizing"></div><div class="main boxSizing"></div></ul>');$("body").append(e),get_info($("#info_tab > .main")),$(".staff").append($('<div class="owner boxSizing"> <span class="label">负责人:</span> <span class="value"></span> </div> <div class="member boxSizing"> <span class="label">团队成员:</span> <span class="value"></span> </div> </div>')),xsyUser.id==ownerId&&(change_owner(),change_member()),$("#info_tab").fadeIn(300)}}else"全部"==t&&($(".tab").remove(),$(".content").fadeIn(300))}function get_record(t,e,o){t.children().remove(),$.ajax({url:apppath+"/wx/activityrecord/dolist.action?d="+ +new Date,data:{belongId:3,objectId:GetQueryString("opportunityId"),pagesize:e,pageNo:recordPageNo},dataType:"json",success:function(e){if(console.log("跟进记录："),console.log(e),1==e.success)if(0==e.entity.records.length)t.css("border",0),console.log("该对象暂无跟进记录"),t.append(reminderHtml);else{if(e.entity.totalSize>5){if(0==$("#recordList .more").length){var a=$('<a class="more"></a>');$("#recordList > .top").append(a)}$("#recordList .more").on("click",function(){$("#nav > .record").addClass("active"),$("#nav > .record").siblings().removeClass("active"),tab($("#nav > .record").attr("href"))})}var n=e.entity.totalSize;build_record_list(t,e),t.find("li").length<n&&"tab"==o?($("#loading").remove(),build_end(t,"加载更多","load_more"),recordPageNo++,scroll_load(t,get_record)):$("#loading").remove()}else e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("网络不给力，请重新加载")},error:function(){console.log("网络不给力，请重新加载")}})}function build_record_list(t,e){for(var o=e.entity.records,a=0,n=o.length;n>a;a++){var i=o[a].user.userName,r=o[a].typeName,c=o[a].objectName,s=o[a].belongId,d=o[a].objectId,l=o[a].startTime.substr(-5),p=o[a].startTime.substr(0,11),u=o[a].type;if(0==a||o[a].startTime.substr(0,11)!=o[a-1].startTime.substr(0,11)){var m=$('<div class="day"><em></em><p class="startDate">'+p+'</p><div class="ban"></div></div>');t.append(m)}var f=$('<li class="boxSizing"><div class="info"><span class="userName">'+i+'</span><span class="typeName">'+r+':</span><span class="objectName">'+c+'</span><span class="startTime">'+l+"</span></div></li>");if(f.find(".objectName").attr({belongId:s,objectId:d}),d!=GetQueryString("opportunityId")&&f.find(".objectName").on("click",function(){var t;1==$(this).attr("belongId")?t=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=con_info&ropportunityId="+GetQueryString("opportunityId"):2==$(this).attr("belongId")?t=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=con_info&ropportunityId="+GetQueryString("opportunityId"):3==$(this).attr("belongId")&&(t=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=con_info&ropportunityId="+GetQueryString("opportunityId")),location.href=t}),u==activeRecordTypeOje.DO_DING?f.addClass("ding_bg"):u==activeRecordTypeOje.TEL?f.addClass("phone_bg"):u==activeRecordTypeOje.SIGN_IN?f.addClass("sign_in_bg"):u==activeRecordTypeOje.RECORD&&f.addClass("record_bg"),o[a].content){var g=o[a].content,y=$('<span class="content_span">'+g+"</span>"),v=$('<div class="content"><em class="triangle"></em></div>');if(v.append(y),g.length>32){var h=g.substr(0,30)+"...",b=$('<span class="short_content_span">'+h+"</span>");v.append(b),y.css("display","none");var _=0,I=$('<em class="more"></em>');I.on("click",function(){_++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*_)+"deg)")}),v.append(I)}f.append(v)}if(o[a].location){var w=$('<div class="location">'+o[a].location+"</div>");f.append(w)}var x=$('<div class="bottom_border"></div>');f.append(x),t.append(f)}removeBorder()}function removeBorder(){$("#record_tab li").each(function(){$(this).next().hasClass("day")&&$(this).find("div:last-child").css("borderBottom",0)})}function get_contacts(t,e,o){contactIdArr=[],$.ajax({url:apppath+"/wx/opportunity/contacts.action?d="+ +new Date,data:{opportunityId:GetQueryString("opportunityId")},dataType:"json",success:function(a){if(console.log("联系人："),console.log(a),1==a.success){var n=a.entity.totalSize;if($("#contactList > .top > .title").text("联系人("+n+")"),$("#nav > .contact").text("联系人("+n+")"),0==n)t.css("border",0),t.append(reminderHtml),console.log("该对象暂无联系人信息");else{if(n>5){if(0==$("#contactList .more").length){var i=$('<a class="more"></a>');$("#contactList > .top").append(i)}$("#contactList .more").on("click",function(){$("#nav > .contact").addClass("active"),$("#nav > .contact").siblings().removeClass("active"),tab($("#nav > .contact").attr("href"))})}for(var r=0,c=n;c>r;r++)contactIdArr.push(a.entity.contacts[r].contactId);build_contact_list(t,a,e),t.find("li").length<n&&"tab"==o?($("#loading").remove(),build_end(t,"加载更多","load_more"),contactPageNo++,scroll_load(t,get_contacts)):$("#loading").remove()}}else a.entity&&a.entity.status&&"0000003"==a.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("网络不给力，请重新加载")},error:function(){myAlert("网络不给力，请重新加载")}})}function build_contact_list(t,e,o){var a=e.entity.contacts,n=a.length;5==o&&n>=5&&(n=5);for(var i=0;n>i;i++){var r=a[i].contactName,c=a[i].post,s=a[i].mobile,d=a[i].phone,l=a[i].contactId,p=$('<li class="boxSizing" ><div class="contact_info_list" mobile="'+s+'" phone="'+d+'"><span class="name">'+r+'</span><span class="post">'+c+'</span></div><a class="tel"></a></li>');p.find(".contact_info_list").attr("value",l),p.find(".contact_info_list").on("click",function(){location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("value")+"&from=opp_info&ropportunityId="+GetQueryString("opportunityId")}),t.append(p)}contacttelClick()}function contacttelClick(){$("#list li .con");$(".main li").each(function(t,e){$(e).find(".tel").on("click",function(t){var e=$(this).siblings(".contact_info_list"),o=e.attr("value"),a=e.attr("mobile"),n=e.attr("phone");if(""==a&&""==n){var i=$('<div class="no_contact">暂无联系方式，请填写联系方式</div>');$("body").append(i),setTimeout(function(){$(".no_contact").remove()},1e3)}else{$(window).scrollTop(0);var r=$('<div class="tel_bg"></div>');r.on("click",function(){$(".tel_bg").remove(),$("#tel_list").remove()}),$("body").append(r),$(".tel_bg").css("top",$(document).scrollTop()),$(".tel_bg").fadeIn(200);var c=$('<div id="tel_list"></div>');add_atom(c,a,"家庭电话",o),add_atom(c,n,"手机",o);var s=$('<div id="rtn_btn">取消</div>');s.on("click",function(){$("body").css({overflow:"",height:""}),$(".tel_bg").remove(),$("#tel_list").animate({bottom:-$("#tel_list").height()},300),setTimeout(function(){$("#tel_list").remove()},300)}),c.append(s),$("body").append(c),$("body").css({overflow:"hidden",height:"100%"}),$("#tel_list").on("touchmove",function(t){t.stopPropagation()}),$("#tel_list").css({bottom:-$("#tel_list").height()}),$("#tel_list").animate({bottom:"0"},300)}})})}function add_atom(t,e,o,a){if(e&&""!=e){var n=$('<a href="tel:'+e+'" class="tel_atom"><span class="label">'+o+'</span><span class="value">'+e+"</span></a>");n.on("click",function(){location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+a+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")}),t.append(n)}}function get_info(t){var e=GetQueryString("opportunityId");$.ajax({url:apppath+"/wx/opportunity/getDetail.action",data:{opportunityId:e,scene:"DETAIL"},dataType:"json",success:function(e){if($(".load-shadow").hide(),console.log("详情"+e),1==e.success){dataPermission=e.entity.expandPro.dataPermission,infoData=e.entity.data,build_info(t,e),opportunityName=e.entity.data.opportunityName,ownerName=e.entity.expandPro.ownerIdText,accountId=e.entity.data.accountId,$(".owner .value").text(ownerName),ownerId=e.entity.data.ownerId,dataPermission.transfer?change_owner():$(".owner").css("background","none"),dataPermission.update?change_member():$(".member").css("background","none"),dataPermission.transfer?change_owner():$(".staff>.owner").css("background","none"),dataPermission.update?(change_member(),saleStagePush()):($(".staff>.member").css("background","none"),$("#opportunityInfo .salesStageSelect").addClass("unable")),0==dataPermission["delete"]&&($("#set_opportunity").parent().hide(),$("#delete_opportunity").parent().hide());var o=e.entity.expandPro.saleStageIdText;money=e.entity.data.money;var a=e.entity.expandPro.saleStageIdPercentage;ownerName=e.entity.expandPro.ownerText,order=e.entity.expandPro.saleStageIdOrder;var n=["","一","二","三","四","五","六","七","八","九"];if($("#text .opportunityName").html(opportunityName),$("#text .saleStage").html("第"+n[order]+"阶段："+o),$("#text .money").html(money+"元"),$(".owner .value").text(ownerName),get_member(),drawCircle(a),$("#picture .percent").html(a+"%"),0==a){$("#progress .title").hide(),$("#progress .percent").hide();var i=$('<p class="looseProgress">输单</p>');if($("#progress").find(".looseProgress").length>0)return;$("#progress").append(i)}else $("#progress .title").show(),$("#progress .percent").show(),$("#progress .looseProgress").remove();build_info(t,e)}else"300032"==e.errorCode?"opp_info"==GetQueryString("from")?location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=opp_deleted":"con_info"==GetQueryString("from")?location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=opp_deleted":"acc_info"==GetQueryString("from")?location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=opp_deleted":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=opp_deleted":location.href=apppath+"/wx/statics/index.action?"+ddcommparams):e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:e.entity&&e.entity.status&&"0000004"==e.entity.status?"opp_info"==GetQueryString("from")?location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=opp_noright":"con_info"==GetQueryString("from")?location.href=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=opp_noright":"acc_info"==GetQueryString("from")?location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=opp_noright":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=opp_noright":location.href=apppath+"/wx/statics/index.action?"+ddcommparams+"&err=opp_noright"):myAlert("网络不给力，请重新加载")},error:function(){myAlert("网络不给力，请重新加载")}})}function build_info(t,e){console.log("详情"),console.log(e),t.children().remove();for(var o,a='<span style="color:#8fa1b2">未填写</span>',n=e.entity.structure.components,i=0,r=n.length;r>i;i++){o=set_infoSup(n[i].propertyName,e);var c,s;new Date;if("createdBy"==n[i].propertyName||"updatedBy"==n[i].propertyName)c=o.text,s=o.value,""==s?info_atom_build(t,n[i].label,a,n[i].propertyName,n[i].type):info_atom_build(t,n[i].label,c,n[i].propertyName,n[i].type);else{if("campaignId"==n[i].propertyName)return;"object"==typeof o?(c=o.text,s=o.value,""==s?info_atom_build(t,n[i].label,a,n[i].propertyName,n[i].type):info_atom_build(t,n[i].label,c,n[i].propertyName,n[i].type)):(c=s=o,""==s?info_atom_build(t,n[i].label,a,n[i].propertyName,n[i].type):info_atom_build(t,n[i].label,o,n[i].propertyName,n[i].type))}}}function info_atom_build(t,e,o,a,n){var i='<span style="color:#8fa1b2">未填写</span>';if(""!=o){if("accountId"==a){console.log(accountId);var r=$('<li class="atom boxSizing" id='+a+'><span class="label">'+e+'：</span><span class="value blue">'+o+"</span></li>");r.find(".value").on("click",function(){location.href=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+accountId+"&from=opp_info&ropportunityId="+GetQueryString("opportunityId")})}else if("ITEM_TYPE_LINE"==n)var r=$('<li class="atom boxSizing line-atom" id='+a+'><span class="line-title">'+e+"</span></a></li>");else{if("state"==a)return;if("city"==a)return;if("region"==a)var c="省市区",r=$('<li class="atom boxSizing" id='+a+'><span class="label">'+c+':</span><span class="value">'+o+"</span></li>");if("winRate"==a){var s=0;if(o==i)var r=$('<li class="atom boxSizing" id='+a+'><span class="label">'+e+':</span><span class="value">'+s+"%</span></li>");else var r=$('<li class="atom boxSizing" id='+a+'><span class="label">'+e+':</span><span class="value">'+o+"%</span></li>")}else var r=$('<li class="atom boxSizing" id='+a+'><span class="label">'+e+':</span><span class="value">'+o+"</span></li>")}t.append(r)}}function get_member(){$.ajax({type:"post",url:apppath+"/wx/group/relateowner.action",data:{businessId:GetQueryString("opportunityId"),belongs:3},dataType:"json",success:function(t){if($(".load-shadow").hide(),console.log("团队成员："+t),0==t.success)myAlert("网络不给力，请重新加载");else{for(var e=[],o=0,a=t.entity.users.length;a>o;o++)e.push(t.entity.users[o].name);$(".staff > .member > .value").text(e.join(" , "))}},error:function(){myAlert("网络不给力，请重新加载")}})}function change_owner(){$(".staff .owner").on("click",function(){$.ajax({type:"get",url:apppath+"/wx/xsyuser/pager.action",async:!0,dataType:"json",success:function(t){if($(".load-shadow").hide(),0==t.success)myAlert("网络不给力，请重新加载");else if(1==t.entity.records.length){var e=$('<div class="no_contact">您的公司下暂时没有其他员工</div>');$("body").append(e),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("转移给他人");var o=$('<div id="container" class="container ownerContainer"></div>');$(".ct").append(o),build_owner_list(o,t)}},error:function(){myAlert("网络不给力，请重新加载")}})})}function build_owner_list(t,e){for(var o=0,a=e.entity.records.length;a>o;o++){if(e.entity.records[o].name==$("#infoList .owner > .value").text())var n=$('<div class="item"><em class="radio active"><i></i></em><span id='+e.entity.records[o].id+">"+e.entity.records[o].name+"</span></div>");else var n=$('<div class="item"><em class="radio"><i></i></em><span id='+e.entity.records[o].id+">"+e.entity.records[o].name+"</span></div>");t.append(n)}radio_click(e)}function radio_click(t){$(".ct .item").each(function(e){$(this).on("click",function(){function e(){$.ajax({url:apppath+"/wx/opportunity/trans.action",data:{opportunityId:GetQueryString("opportunityId"),userId:o},beforeSend:function(){loader()},dataType:"json",success:function(t){$(".loaderArea").remove(),setTimeout(function(){$(".ct").remove(),set_title("商机详情"),$("body").css({overflow:"",height:""}),$(".common").css("paddingBottom","0px"),set_right("更多",more)},2e3),1==t.success?($(".owner > .value").text(a),get_record($("#recordList > .main"),5),myDialog("负责人更改成功")):myAlert("负责人更改失败")},error:function(){$(".loaderArea").remove(),myAlert("网络不给力，请重新加载")}})}$(this).find("em").hasClass("active")||($(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active"));var o=t.entity.records[$(this).index()].id,a=t.entity.records[$(this).index()].name;doChangeOwner(a,e)})})}function change_member(){$(".member").on("click",function(){$.ajax({type:"get",url:apppath+"/wx/xsyuser/pager.action",async:!0,dataType:"json",success:function(t){if($(".load-shadow").hide(),0==t.success)myAlert("网络不给力，请重新加载");else if(1==t.entity.records.length){var e=$('<div class="no_contact">您的公司下暂时没有其他员工</div>');$("body").append(e),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("修改团队成员");var o=$('<div id="container" class="container"></div>');$(".ct").addClass("staff-warp"),$(".ct").append(o),build_member_list(o,t,apppath+"/wx/group/setrelateowner.action")}},error:function(){myAlert("网络不给力，请重新加载")}})})}function build_member_list(t,e,o){for(var a=$("#infoList .member > .value").text().split(","),n=0,i=e.entity.records.length;i>n;n++){var r,c;if(o==apppath+"/wx/group/setrelateowner.action"?(r=e.entity.records[n].name,c=e.entity.records[n].id):o==apppath+"/wx/opportunity/setcontacts.action"&&(r=e.entity.records[n].contactName,c=e.entity.records[n].id),r!=ownerName){var s=$('<div class="item boxSizing"><em class="checkbox"></em><span>'+r+"</span></div>");s.attr("value",c),t.append(s)}}for(var n=0,i=contactIdArr.length;i>n;n++)for(var d=0;d<e.entity.records.length;d++)e.entity.records[d].id==contactIdArr[n]&&$(".ct .item").eq(d).find("em").addClass("active");for(var d=0;d<a.length;d++)for(var n=0,i=e.entity.records.length;i>n;n++){var r;o==apppath+"/wx/group/setrelateowner.action"?r=e.entity.records[n].label:o==apppath+"/wx/opportunity/setcontacts.action"&&(r=e.entity.records[n].contactName),console.log(a[d]+"+"+r),$.trim(a[d])==$(".ct .item").eq(n).find("span").text()&&$(".ct .item").eq(n).find("em").addClass("active")}checkbox_click(e),create_confirm(e,o)}function checkbox_click(t){$(".item").each(function(t){$(this).on("click",function(){memberChange=!0,$(this).find("em").hasClass("active")?$(this).find("em").removeClass("active"):$(this).find("em").addClass("active")})})}function create_confirm(t,e){var o=$('<button id="confirm" class="confirm">确定</button>');$(".ct").append(o),o.on("touchstart",function(){$(this).addClass("touching")}),o.on("touchend",function(){$(this).removeClass("touching")}),o.on("click",function(){var t=[];$(".item").each(function(){$(this).find("em").hasClass("active")&&t.push($(this).attr("value"))}),chooseData(e,t),console.log(relavanceContactData),$.ajax({type:"post",url:e,data:relavanceContactData,async:!0,beforeSend:function(){loader()},dataType:"json",success:function(t){$(".loaderArea").remove(),setTimeout(function(){$(".ct").remove(),$("body").css({height:"",overflow:""}),set_title("商机详情"),set_right("更多",more)},2e3),console.log("关联联系人返回："+t),1==t.success?(myDialog("更改成功"),window.location.reload(),e==apppath+"/wx/group/setrelateowner.action"?(get_record($("#recordList > .main"),5),get_member()):e==apppath+"/wx/opportunity/setcontacts.action"&&($("#contactList > .main").children().remove(),get_contacts($("#contactList > .main"),5))):myAlert("更改失败")},error:function(t){myAlert("网络不给力，请重新加载"),$(".loaderArea").remove()}})})}function chooseData(t,e){t==apppath+"/wx/group/setrelateowner.action"?relavanceContactData={businessId:Number(GetQueryString("opportunityId")),belongs:3,setOwnerIds:e.join(",")}:t==apppath+"/wx/opportunity/setcontacts.action"&&(relavanceContactData={opportunityId:Number(GetQueryString("opportunityId")),contactIds:e.join(",")})}function footer_phone(){$("footer .tel").on("click",function(){$(window).scrollTop(0),$.ajax({url:apppath+"/wx/opportunity/contacts.action",data:{opportunityId:GetQueryString("opportunityId")},dataType:"json",success:function(t){var e=t.entity.contacts,o=t.entity.totalSize;if(0==o){var a=$('<div class="no_contact">暂无联系人可用，请添加联系人</div>');$("body").append(a),setTimeout(function(){$(".no_contact").remove()},2e3)}else mobileList(o,e)}})})}function mobileList(t,e){var o=$('<div class="tel_bg"></div>');o.on("click",function(){$(".tel_bg").remove(),$("#mobile_list").remove()}),$("body").append(o),$(".tel_bg").css("top",$(document).scrollTop()),$(".tel_bg").fadeIn(200);for(var a=$('<div id="mobile_list"></div>'),n=0;n<e.length;n++){console.log(e[n]);var i=e[n].mobile,r=e[n].phone,c=e[n].contactName,s=e[n].contactId,d=(e[n].post,$('<div class="mobile_atom"><div class="left boxSizing"><span class="name">'+c+'</span></div><a href="tel:'+i+'"  class="mobile boxSizing">'+i+'</a><a  class="mobile boxSizing" href="tel:'+r+'">'+r+"</a></div>"));d.attr("id",s),d.find("a").on("click",function(){var t=$(this).parent().attr("id");location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+t+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")}),a.append(d)}var l=$('<li id="rtn_btn">取消</li>');l.on("click",function(){$("body").css({overflow:"",height:""}),$(".tel_bg").remove(),$("#mobile_list").animate({bottom:-$("#mobile_list").height()},300),setTimeout(function(){$("#mobile_list").remove()},300)}),a.append(l),$("body").append(a),$("body").css({overflow:"hidden",height:"100%"}),$("#mobile_list").on("touchmove",function(t){t.stopPropagation()}),$("#mobile_list").css({bottom:-$("#mobile_list").height()}),$("#mobile_list").animate({bottom:"0"},300)}function footer_signin(){$("footer > .signin").on("click",function(){location.href=apppath+"/wx/activityrecord/qiandao.action?"+ddcommparams+"&belongId=3&objectId="+GetQueryString("opportunityId")+"&activityTypeId="+activeRecordTypeOje.SIGN_IN+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")})}function footer_create_record(){$("footer > .record").on("click",function(){location.href=apppath+"/wx/activityrecord/create.action?"+ddcommparams+"&belongId=3&objectId="+GetQueryString("opportunityId")+"&activityTypeId="+activeRecordTypeOje.RECORD+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")})}function build_end(t,e,o){var a=$('<div id="'+o+'" class="end_info">'+e+"</div>");t.append(a)}function scroll_load(t,e){var o=document.body.clientHeight;$(window).on("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=o-$("#load_more").height()-50&&($("#load_more").remove(),build_end(t,"加载中…","loading"),e(t,20),$(this).unon("scroll"),top_nav())})}$(document).on("ready",function(){top_nav(),nav(),linkMore(),more(),get_record($("#recordList > .main"),5),get_contacts($("#contactList > .main"),5),get_info($("#infoList > .main"));var t=$('<ul id="record_tab" class="tab record recordArea"><div class="main boxSizing"></div></ul>');$("body").append(t),recordPageNo=0,get_record($("#record_tab > .main"),20,"tab"),$("#record_tab").fadeIn(300),$("body").on("click",function(){$("#area").length>0&&$("#area").remove()}),$("body").on("touchmove",function(){$("#area").length>0&&$("#area").remove()}),get_member(),footer_phone(),footer_signin(),footer_create_record(),stopScroll($(".shadow")),stopScroll($("#saleStage"))}),$(document).on("touchstart",function(t){$(t.target).closest(".link_more").size()||$(".options").hide()}),$(document).on("click",function(t){$(t.target).closest(".link_more").size()||$(".options").hide()});var accountId,opportunityName,opportunityType,closeDate,order,ownerId,money,dimDepart,nav_top=$("#topNav").offset().top,nav_height=$("#topNav").height(),reminderHtml='<div class="content-reminder"><div class="ico"><p>暂无数据</p></div></div>',recordPageNo=0,contactIdArr=[],contactPageNo=0,dataPermission,ownerName,infoData,memberChange=!1,relavanceContactData;