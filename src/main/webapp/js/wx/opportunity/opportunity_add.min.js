"use strict";function getOppList(t){$.ajax({url:apppath+"/wx/opportunity/getDetail.action",dataType:"json",data:{scene:t},type:"GET",beforeSend:function(){},success:function(t){if(0==t.success&&(myAlert("加载数据失败，请稍后再试"),$(".load-shadow").hide()),1==t.success){$(".load-shadow").hide();var e=JSON.stringify(t);console.log(e);var n=t.entity.structure.components;$.each(n,function(t,e){customizItem($("#basic_info"),e,selectitmeObj)});var a=$("#ownerId").find("button");a.html(userName),a.attr("value",ownerId),a.attr("readonly",!0);var o=$("#dimDepart").find("button");o.html(userDepartName),o.attr("value",userDepartId);var i=$('<div class="footer"></div>');i.append('<button id="confirm">保存</button>'),$("body").append(i),selectDate(),SelectItemPost(),DummyItemPost(),dimdepart_choose(),get_accountName(),confirm(),textarea_num(),input_adjust(),$("textarea").autoHeight(),"set"==GetQueryString("type")?set_info():(accountPost(),setPost=!0)}},complete:function(){},error:function(t){alert(t)}})}function get_accountName(){"acc_info"!=GetQueryString("from")&&"con_info"!=GetQueryString("from")||$.ajax({url:apppath+"/wx/account/getDetail.action",data:{accountId:GetQueryString("accountId"),scene:"DETAIL"},dataType:"json",success:function(t){$("#accountId button").html(t.entity.data.accountName),$("#accountId button").css({color:"#ccc",background:"none"}),$("#accountId button").attr({disabled:"disabled",value:GetQueryString("accountId")})}})}function owner_choose(){$("#ownerId").bind("click",function(){checkTable("选择客户所有人"),$.ajax({type:"get",url:apppath+"/wx/xsyuser/pager.action",async:!0,dataType:"json",success:function(t){console.log("客户所有人"+t),0==t.success?myAlert("网络不给力，请重新加载"):(ownerData=t,create_owner_list(t),ownerPost&&($("#parentAccountId").attr("value",accountData.entity.records[0].id),$("#parentAccountId  button").html(accountData.entity.records[0].name),getStartValue()))},error:function(){myAlert("网络不给力，请重新加载")}})})}function create_owner_list(t){for(var e=$('<div class="container"></div>'),n=0,a=t.entity.records.length;a>n;n++){var o=$('<div class="item boxSizing"><em class="radio"><i></i></em><span>'+t.entity.records[n].name+"</span></div>");o.attr("value",t.entity.records[n].id),e.append(o)}$(".ct").append(e);for(var n=0,a=$(".ct .item").length;a>n;n++)$("#ownerId button").html()==$(".ct .item").eq(n).find("span").text()&&$(".ct .item").eq(n).find("em").addClass("active");$(".ct .item").each(function(e){$(this).bind("click",function(){$(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active");var e=t.entity.records[$(this).index()].id,n=($(this).index(),t.entity.records[$(this).index()].name);$("#ownerId button").html(n),btn_color_adjust(),$("#ownerId button").attr("value",e),$(".ct").remove(),$("body").css({overflow:"scroll",height:"auto"})})})}function confirm(){function t(t){regingData()&&info_submit(t)}$("#confirm").bind("click",function(){t()})}function info_submit(t){var e="";if("set"==GetQueryString("type")){e=apppath+"/wx/opportunity/doupdate.action",console.log("更新接口");var n={id:GetQueryString("opportunityId")};$("#basic_info .item").each(function(){var t,e=$(this);if(e.find("input").size()){var a=e.attr("btype");if("ITEM_TYPE_INTEGER"==a&&""==e.find("input").val()||"ITEM_TYPE_REAL"==a&&""==e.find("input").val())return;t=e.find("input").val()}if(e.find("button").size()){var o=e.find("button");if(""==o.html()||"点击选择"==o.html())t=null;else if("ITEM_TYPE_CHECKBOX"==e.attr("btype")){var i=[];i=e.find("button").attr("value").split(","),t=(i.length=0)?[]:i,console.log(i)}else t=e.find("button").attr("value")}e.find("textarea").size()&&(t=e.find("textarea").val()),n[e.attr("id")]=t})}else{e=apppath+"/wx/opportunity/docreate.action",console.log("创建接口");var n={};$("#basic_info .item").each(function(){var t,e=$(this);if(e.find("input").size()){var a=e.attr("btype");if("ITEM_TYPE_INTEGER"==a&&""==e.find("input").val()||"ITEM_TYPE_REAL"==a&&""==e.find("input").val())return;t=e.find("input").val()}if(e.find("button").size()){var o=e.find("button");if(""==o.html()||"点击选择"==o.html())t=null;else if("ITEM_TYPE_CHECKBOX"==e.attr("btype")){var i=[];i=e.find("button").attr("value").split(","),t=(i.length=0)?[]:i,console.log(i)}else t=e.find("button").attr("value")}e.find("textarea").size()&&(t=e.find("textarea").val()),n[e.attr("id")]=t})}$.ajax({type:"post",url:e,data:{opportunity:JSON.stringify(n)},async:!0,beforeSend:function(){$(".confirm").attr("disabled","true"),loader()},dataType:"json",success:function(t){if($(".loaderArea").remove(),1==t.success){myDialog("保存成功");var e=t.entity.id;"set"==GetQueryString("type")&&(e=GetQueryString("opportunityId")),myDialog("保存成功");var n;"opp_list"==GetQueryString("from")?location.replace(apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+e+"&from=opp_list"):"opp_info"==GetQueryString("from")?location.replace(apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+e+"&from=opp_list"):"acc_info"==GetQueryString("from")?location.replace(apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+e+"&from=acc_info&accountId="+GetQueryString("accountId")):"con_info"==GetQueryString("from")&&location.replace(apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+e+"&from=con_info&contactId="+GetQueryString("contactId")),time_out_location(n)}else 0==t.success&&($(".confirm").removeAttr("disabled"),t.entity&&t.entity.status&&"0000001"==t.entity.status?myAlert("保存失败，公司名称已存在"):t.entity&&t.entity.status&&"0000002"==t.entity.status?myAlert("保存失败，不能包含表情符"):t.entity&&t.entity.status&&"0000003"==t.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("保存失败，请检查输入信息"))},error:function(){$(".loaderArea").remove(),$(".confirm").removeAttr("disabled"),myAlert("网络不给力，请重新加载")}})}function set_info(){$.ajax({url:apppath+"/wx/opportunity/getDetail.action",data:{opportunityId:GetQueryString("opportunityId"),scene:"UPDATE"},dataType:"json",success:function(t){console.log(t),$("#basic_info .item").each(function(){var e,n,a=$(this),o=set_infoSup(a.attr("id"),t);"object"==typeof o?(e=o.text,n=o.value):e=n=o,a.find("input").size()&&a.find("input").val(n),a.find("button").size()&&(a.find("button").attr("value",n),""===e?a.find("button").html("点击选择"):a.find("button").html(e)),a.find("textarea").size()&&a.find("textarea").val(n)}),btn_color_adjust(),$("textarea").autoHeight(),textarea_num()}})}$(document).bind("ready",function(){"add"==GetQueryString("type")&&getOppList("ADD"),"set"==GetQueryString("type")&&(document.title="修改商机",getOppList("UPDATE")),xsyUser||alert("获取当前用户失败")});var accountId,userName=xsyUser.name,userDepartId=xsyUser.departId,userDepartName=xsyUser.departmentName,ownerId=xsyUser.id,selectitmeObj={},url=apppath+"/wx/opportunity/docreate.action";"set"==GetQueryString("type")&&(url=apppath+"/wx/opportunity/doupdate.action");var reg_opportunityName=/^.{1,50}$/,reg_money=/^\d{1,10}$/,reg_accountName=/\S/,ownerData,ownerPost=!1;