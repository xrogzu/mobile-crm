function add_opportunity(){location.href=apppath+"/wx/opportunity/add.action?"+ddcommparams+"&from=opp_list&type=add"}function opp_list_back(){$("#screen_area").length>0&&"block"==$("#screen_area").css("display")?($("#screen_area").hide(),$(".screen").removeClass("active")):$("#search_ground").length>0?$("#search_ground").remove():location.href=apppath+"/wx/statics/index.action?"+ddcommparams}function sort(){$(".sort").bind("click",function(){$(this).find("span").addClass("active");var e=$("#screen_area .con").find(".active").length;0>=e&&$(".screen").removeClass("active"),$("#screen_area").hide(),$(this).siblings().find("span").removeClass("active"),0==$(this).index()?orderField="saleStageId":1==$(this).index()?orderField="money desc":2==$(this).index()&&(orderField="recentActivityRecordTime desc"),$("#list .main").children().remove(),pageNo=0,obj={pageNo:pageNo,pagesize:pageSize,saleStageId:saleStageId,closeType:closeType,money_down:min,money_up:max,desc:!1,orderField:orderField},$(".load-shadow").show(),build_common_list(apppath+"/wx/opportunity/dolist.action?d="+ +new Date,$("#list .main"),empty,build_list_unit,loaded)})}function screen(){$(".load-shadow").show(),$(".screen").bind("click",function(){if($(this).hasClass("active"))$("#screen_area").toggle();else if($(this).addClass("active"),$("#screen_area").length>0)$("#screen_area").show();else{var e=$('<div id="screen_area" class="boxSizing"></div>'),i=$('<div class="stage_screen"><div class="title boxSizing">按阶段</div><div class="con"></div></div>'),t=$('<div class="time_screen"><div class="title boxSizing">结单时段</div><div class="con"></div></div>'),a=$('<div class="money_screen"><div class="title boxSizing">按金额</div><div class="con"><span>金额范围（元）</span><input type="tel" maxlength="18" class="max fr"><span class="fr">-</span><input type="tel" maxlength="18" class="min fr"></div></div>'),o=$('<div class="reset boxSizing">重置</div>'),n=$('<div class="confirm">确定</div>');e.append(i),e.append(t),e.append(a),e.append(o),e.append(n),$("body").append(e),$.ajax({url:apppath+"/wx/opportunity/getSaleStage.action",dataType:"json",success:function(e){if($(".load-shadow").hide(),1==e.success)for(var i=0,t=e.entity.length;t>i;i++){var a=$('<div class="stage_item item boxSizing"><em></em><span>'+e.entity[i].label+"</span></div>");a.attr("id",e.entity[i].value),a.bind("click",function(){$(this).hasClass("active")?($(this).removeClass("active"),saleStageId=0):($(this).addClass("active"),$(this).siblings().removeClass("active"),saleStageId=Number($(this).attr("id")))}),$(".stage_screen .con").append(a)}}}),$.ajax({url:apppath+"/wx/opportunity/getCloseDateType.action",dataType:"json",success:function(e){if($(".load-shadow").hide(),1==e.success)for(var i=0,t=e.entity.length;t>i;i++){var a=$('<div class="time_item item"><span>'+e.entity[i].desc+"</span></div>");a.attr("id",e.entity[i].id),a.bind("click",function(){$(this).hasClass("active")?($(this).removeClass("active"),closeType=0):($(this).addClass("active"),closeType=Number($(this).attr("id")),$(this).siblings().removeClass("active"))}),$(".time_screen .con").append(a)}}}),$(".reset").bind("click",function(){saleStageId=0,closeType=0,min=0,max=0,$(".item").removeClass("active"),$(".money_screen input").val("")}),$(".confirm").bind("click",function(){if(screenFlag=!0,""!=$(".min").val()&&(min=Number($(".min").val())),""!=$(".max").val()&&(max=Number($(".max").val())),console.log(min+","+max),0>min||max>9999999999)myDialog("金额范围输入错误","without");else{$("#list .main").children().remove();var e=$("#screen_area .con").find(".active").length;0>=e&&$(".screen").removeClass("active"),pageNo=0,obj={pageNo:pageNo,pagesize:pageSize,desc:!1,saleStageId:saleStageId,closeType:closeType,money_down:min,money_up:max,orderField:orderField},build_common_list(apppath+"/wx/opportunity/dolist.action",$("#list .main"),empty,build_list_unit,loaded),$("#screen_area").hide()}})}})}function search_show(){$(".ipt_area").bind("click",function(){var e=$('<div id="search_ground" class="boxSizing"><div class="search_area"><div class="input_area"><input id="text" type="text" placeholder="搜索商机"/><div class="delete_icon"></div></div><span id="exit">取消</span></div><div id="search_content"></div></div>');$("body").append(e),$("#text").focus(),search(),search_exit()})}function search_exit(){$("#exit").bind("click",function(){$("#search_ground").remove()})}function search(){show_history(),$(".input_area #text").bind("input",function(){input_delete(),val=$(".input_area #text").val()," "==val.substr(0,1)&&(val=val.trim()),""==val?($(".list").remove(),$(".dialog").remove(),show_history()):show_word(val)})}function input_delete(){""==$(".input_area").find("input").val()?$(".input_area").find(".delete_icon").hide():$(".input_area").find(".delete_icon").show(),$(".input_area").find(".delete_icon").bind("click",function(){$(this).hide(),$(".input_area").find("input").val(""),$("#content>.list").remove(),$(".dialog").remove(),show_history()})}function show_history(){if($("#search_content").children().remove(),console.log(userId),"undefined"!=localStorage.getItem(userId)){var e=JSON.parse(localStorage.getItem(userId));console.log(e),e.opportunityHistory&&0!=e.opportunityHistory.length?create_history_list(e):create_history_null()}else create_history_null()}function create_history_list(e){if(e.opportunityHistory){if(e.opportunityHistory.length<=20)for(var i=e.opportunityHistory.length-1;i>=0;i--)build_history_list(e,i);else for(var i=e.opportunityHistory.length-1;i>=e.opportunityHistory.length-20;i--)build_history_list(e,i);create_delete()}else create_history_null()}function build_history_list(e,i){var t=document.createElement("div");t.className="boxSizing history_list";var a=e.opportunityHistory[i].name,o=e.opportunityHistory[i].id;$(t).append($('<span class="name">'+a+"</span>")),$(t).attr("id",o),$(t).attr("name",a);var n=document.createElement("div");n.innerHTML='<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NTc3MiwgMjAxNC8wMS8xMy0xOTo0NDowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTQgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDA5MDMwNDRCMkU5MTFFNUE4MDNFMkU5NkI5N0FEOEMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDA5MDMwNDVCMkU5MTFFNUE4MDNFMkU5NkI5N0FEOEMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpCMTRGRjgyMUIyRTUxMUU1QTgwM0UyRTk2Qjk3QUQ4QyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpCMTRGRjgyMkIyRTUxMUU1QTgwM0UyRTk2Qjk3QUQ4QyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Prom4REAAADHSURBVHjanNVNCoMwEAXgydAb9CJ21QvYVb2uK91rwUUPYs9gZ2ACIeTnJQNv48gHCQ91+3ZsROQkb8mP+uYumSUXG/aULLbowVYznIKT5Ct5dKAeG8yYFDwlrwBdQTTG1DjZliE6AGgS0wUHL6FoFotBBC1iKbCEVjGdW+aOPLoEKNWwEphCqYbljhzOBT6DwPjOoEpxQ8+gnnJDz6CecktpEZRbSoug3IhVUe7Aiijbl9ZjI4jl0Nkf+WNYzy/Ao2rQX4ABAORFZTtFQ9/RAAAAAElFTkSuQmCC"/>',n.className="exit",$(n).bind("click",function(){e.opportunityHistory.remove(i),localStorage.setItem(userId,JSON.stringify(e)),$(t).remove(),0==$("#search_content").find(".history_list").length&&($("#search_content > .clear").remove(),create_history_null())}),t.appendChild(n),$("#search_content").append(t),$(t).bind("click",function(){local_set($(this).attr("id"),$(this).attr("name"),3),location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("id")})}function create_delete(){var e=document.createElement("div");e.innerHTML="清除全部历史记录",e.className="clear",e.onclick=function(){var e=JSON.parse(localStorage.getItem(userId));e.opportunityHistory=[],localStorage.setItem(userId,JSON.stringify(e)),$("#search_content > .history_list").remove(),$("#search_content > .clear").remove(),create_history_null()},$("#search_content").append(e)}function create_history_null(){var e=document.createElement("div");e.innerHTML="暂无历史记录",e.className="null",$("#search_content").append(e)}function show_word(e){pageNo=0,obj={pageNo:pageNo,pagesize:pageSize,opportunityName:e},create_word_list()}function create_word_list(){$("#search_content").children().remove(),$("#search_content").append($('<div class="boxSizing main"></div>')),build_common_list(apppath+"/wx/opportunity/dolist.action",$("#search_content .main"),"无相关商机",build_word_unit,wordScrollFunc)}function build_word_unit(e,i,t){console.log("build_word_unit");var a=e.entity.records[t].id,o=e.entity.records[t].opportunityName,n=$('<div class="boxSizing opportunityList">'+o+"</div>");n.attr("value",a),n.bind("click",function(){local_set(a,o,3),location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+a}),i.append(n)}function wordScrollFunc(){$("#search_content").bind("scroll",function(){$("#load_more").length>0&&$("#search_content .main").offset().top<=$(window).height()-$("#search_content .main").height()+3&&($("#load_more.end_info").remove(),$("#search_content .main").append($('<div id="loading" class="end_info">加载中…</div>')),build_common_list(apppath+"/wx/opportunity/dolist.action",$("#search_content .main"),"无相关商机",build_word_unit,wordScrollFunc))})}function build_list_unit(e,i,t){var a=e.entity.records[t],o=a.saleStageText,n=a.opportunityName,s=a.money,r=a.accountName,c=a.id,l=a.saleStageOrder,d=a.saleStagePercentage,p=$('<li class="boxSizing"><em class="icon jieduan'+l+'"></em><div class="info"><div class="top"><span class="opportunityName">'+n+'</span><span class="Money">'+s+'元</span></div><div class="bot"><p class="accountName">'+r+'</p><p class="jieduan">阶段：'+o+'</p><span class="jieduan_p">'+d+"%</span></div></div></li>");p.attr("id",c),p.attr("name",n),p.bind("click",function(){local_set($(this).attr("id"),$(this).attr("name"),3),location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("id")+"&from=opp_list"}),i.append(p)}function local_set(e,i,t){if(1==t||2==t){var a={id:e,name:i,kindle:t};if(localStorage.getItem(userId)){var o=JSON.parse(localStorage.getItem(userId));if(o.accountHistory){for(var n=0;n<o.accountHistory.length;n++)o.accountHistory[n].id==e&&o.accountHistory.remove(n);o.accountHistory.push(a)}else var o={accountHistory:[a]}}else var o={accountHistory:[a]}}else if(3==t){var a={id:e,name:i};if("undefined"!=localStorage.getItem(userId)){var o=JSON.parse(localStorage.getItem(userId));if(o.opportunityHistory){for(var n=0;n<o.opportunityHistory.length;n++)o.opportunityHistory[n].id==e&&o.opportunityHistory.remove(n);o.opportunityHistory.push(a)}else var o={opportunityHistory:[a]}}else var o={opportunityHistory:[a]}}localStorage.setItem(userId,JSON.stringify(o))}function loaded(){myScroll=new IScroll("#content",{mouseWheel:!0,preventDefault:!1,scrollbars:!0,momentum:!0,useTransform:!1,click:!0,tap:!0,bounceTime:200,mouseWheelSpeed:200}),myScroll.on("scrollStart",function(){$("#load_more.end_info").length>0&&($("#load_more.end_info").remove(),$("#list .main").append($('<div id="loading" class="end_info">加载中…</div>')),build_common_list(apppath+"/wx/opportunity/dolist.action",$("#list .main"),empty,build_list_unit,loaded))}),myScroll.on("scrollEnd",function(){$("#loading").remove()})}function build_common_list(e,i,t,a,o){$(window).scrollTop(0),$.ajax({url:e,data:obj,dataType:"json",success:function(e){if($(".load-shadow").hide(),1==e.success){var n,s=e.entity.totalSize;if(0==s){i.children().remove();var r=$('<div class="list">'+t+"</div>");r.css({width:"100%",lineHeight:"90px",fontSize:"30px",textAlign:"center"}),i.append(r)}else{n=s-pageNo*pageSize>pageSize?pageSize:s-pageNo*pageSize;for(var c=0;n>c;c++)a(e,i,c);i.children().length<s&&(i.append($('<div id="load_more" class="end_info">加载中</div>')),obj.pageNo++,pageNo++,$("#loading").remove(),o())}}else e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("网络不给力，请重新加载")},error:function(){myAlert("网络不给力，请重新加载")}})}$(document).ready(function(){sort(),screen(),build_common_list(apppath+"/wx/opportunity/dolist.action?d="+ +new Date,$("#list .main"),empty,build_list_unit,loaded),$("#addOppootunity").bind("click",function(){add_opportunity()}),search_show(),search()});var empty='<div class="content-reminder"><div class="ico"><p>暂无数据</p></div></div>',saleStageId=0,closeType=0,min=0,max=0,pageNo=0,pageSize=20,orderField="saleStageId, updatedAt desc",obj={pageNo:pageNo,pagesize:pageSize,orderField:orderField},screenFlag=!1,val=null,userId=xsyUser.id,myScroll;