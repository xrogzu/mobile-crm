function selectors(){$(".selector").bind("click",function(t){"block"==$(this).find(".options").css("display")?$(this).find(".options").hide():($(".options").hide(),$(this).find(".options").show(),$(this).offset().top-$(window).scrollTop()-60>$(this).find(".options").height()?($(this).find(".options").addClass("upper"),$(this).find(".options").removeClass("lower")):($(this).find(".options").addClass("lower"),$(this).find(".options").removeClass("upper"))),t.stopPropagation()}),$(".options li").each(function(){$(this).bind("click",function(t){$(this).parent().parent().find("span").text($(this).text()),$(this).parent().hide(),t.stopPropagation()})}),$(document).on("touchstart",function(t){$(t.target).closest(".selector").size()||$(".options").hide()}),$(document).on("click",function(t){$(t.target).closest(".selector").size()||$(".options").hide()})}function recordSelect(){$(".load-shadow").show(),$("#recordList .selector .options li").each(function(){$(this).bind("click",function(){recordDateType=$(this).attr("value"),recordPageNo=0,$("#recordList > .main").children().remove(),get_record($("#recordList > .main"),20)})})}function get_record(t){$.ajax({url:apppath+"/wx/statics/activerecordlist.action",data:{pagesize:20,pageNo:recordPageNo,searchDateType:recordDateType},dataType:"json",success:function(e){$("#behaviorPage .load-shadow").hide(),console.log("跟进记录："+e),1==e.success?recordByData(e,t):($("#behaviorPage .load-shadow").hide(),e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:(myAlert("网络不给力，请重新加载"),console.log("跟进记录："+e)))},error:function(){myAlert("网络不给力，请重新加载")}})}function recordByData(t,e){var o=t.entity.totalSize;$("#recordList > .top > .title > span").text("跟进记录("+o+")"),0==t.entity.records.length?(e.append($('<div class="noInfo">该范围内没有跟进记录</div>')),console.log("该对象暂无跟进记录")):(build_record_list(e,t),e.find("li").length<o?($("#loading").remove(),build_end(e,"加载更多","load_more"),recordPageNo++,scroll_load()):$("#loading").remove())}function build_end(t,e,o){var a=$('<div id="'+o+'" class="end_info">'+e+"</div>");t.append(a)}function scroll_load(){var t=document.body.clientHeight;$(window).bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=t-$("#load_more").height()-50&&($("#load_more").remove(),build_end($("#recordList > .main"),"加载中…","loading"),get_record($("#recordList > .main"),20),$(this).unbind("scroll"))})}function build_record_list(t,e){for(var o=e.entity.records,a=0;a<o.length;a++){var s=o[a].user.userName,i=o[a].typeName,n=o[a].objectName,r=o[a].belongId,d=o[a].objectId,c=o[a].startTime.substr(-5),l=o[a].startTime.substr(0,11),p=o[a].recordType.type;if(0!=a&&o[a].startTime.substr(0,11)!=o[a-1].startTime.substr(0,11))if(0==a&&t.find(".day").last().text==o[a].startTime.substr(0,11));else{var h=$('<div class="day"><em></em><p class="startDate">'+l+'</p><div class="ban"></div></div>');t.append(h)}else if(0==a&&0==recordPageNo){var h=$('<div class="day"><em></em><p class="startDate">'+l+'</p><div class="ban"></div></div>');t.append(h)}var m=$('<li class="boxSizing"><div class="info"><span class="userName">'+s+'</span><span class="typeName">'+i+':</span><span class="objectName">'+n+'</span><span class="startTime">'+c+"</span></div></li>");if(m.find(".objectName").attr({belongId:r,objectId:d}),m.find(".objectName").bind("click",function(){var t;1==$(this).attr("belongId")?t=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=index&page=behavior":2==$(this).attr("belongId")?t=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=index&page=behavior":3==$(this).attr("belongId")&&(t=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=index&page=behavior"),location.href=t}),"TEL"==p?m.addClass("phone_bg"):"SIGN_IN"==p?m.addClass("sign_in_bg"):"RECORD"==p&&m.addClass("record_bg"),o[a].content){var f=o[a].content,u=$('<span class="content_span">'+f+"</span>"),b=$('<div class="content"><em class="triangle"></em></div>');if(b.append(u),f.length>32){var v=f.substr(0,30)+"...",g=$('<span class="short_content_span">'+v+"</span>");b.append(g),u.css("display","none");var _=0,y=$('<em class="more"></em>');y.bind("click",function(){_++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*_)+"deg)")}),b.append(y)}m.append(b)}if(o[a].location){var T=$('<div class="location">'+o[a].location+"</div>");m.append(T)}var w=$('<div class="bottom_border"></div>');m.append(w),t.append(m)}removeBorder()}function removeBorder(){$("#record_tab li").each(function(){$(this).next().hasClass("day")&&$(this).find(".bottom_border").remove()})}$(document).bind("ready",function(){selectors(),recordSelect(),get_record($("#recordList > .main"),20)});var recordDateType=1,recordPageNo=0;