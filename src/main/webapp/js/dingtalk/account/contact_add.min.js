function getStartValue(){setTimeout(function(){contactNameValue=$("#contactName input").val(),phoneValue=$("#phone input").val(),accountNameValue=$("#accountName button").html(),departmentValue=$("#department input").val(),postValue=$("#post input").val(),telValue=$("#tel input").val(),emailValue=$("#email input").val(),addressValue=$("#address input").val(),textareaValue=$("textarea").val(),ownerPostValue=$("#ownerPost  button").html()},800)}function backRemind(){var t=!1;contactNameValue==$("#contactName input").val()&&phoneValue==$("#phone input").val()&&accountNameValue==$("#accountName button").html()&&departmentValue==$("#department input").val()&&postValue==$("#post input").val()&&telValue==$("#tel input").val()&&emailValue==$("#email input").val()&&addressValue==$("#address input").val()&&textareaValue==$("textarea").val()&&ownerPostValue==$("#ownerPost  button").html()||(t=!0);var a;"acc_add"!=GetQueryString("from")&&"acc_info"!=GetQueryString("from")||(a=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("accountId")),"con_list"==GetQueryString("from")&&(a=apppath+"/dingtalk/contact/list.action?"+ddcommparams),"con_info"==GetQueryString("from")&&(a=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("contactId")),$(".ct").length>0?($("body").css("height",""),$(".ct").remove(),remove_rTop(),add_page_title(),$("body").css("overflow","")):t?0==$(".chooseShadow").length?myChoose(a):$(".chooseShadow").remove():location.href=a}function contactNameReg(){$("#contactName input").bind("blur",function(){for(var t=$("#contactName input").val();t.lastIndexOf(" ")>=0;)t=t.replace(" ","");$("#contactName input").val(t)})}function add_page_title(){null!=GetQueryString("type")&&"set"==GetQueryString("type")?set_title("编辑联系人"):set_title("新建联系人")}function account_choose(){$("#accountName button").bind("click",function(){checkTable("选择公司"),$.ajax({type:"get",url:apppath+"/dingtalk/account/dolist.action",async:!0,success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else if(0==oData.entity.records.length){var no_contact=$('<div class="no_contact">暂无公司，请新建公司</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else create_account_list(oData)}})})}function create_account_list(t){for(var a=$('<div class="container"></div>'),e=0;e<t.entity.records.length;e++){var n=$('<div class="item boxSizing" href="'+t.entity.records[e].id+'"><em class="radio"><i></i></em><span>'+t.entity.records[e].accountName+"</span></div>");a.append(n)}$(".ct").append(a);for(var e=0;e<$(".ct .item").length;e++)$("#accountName button").html()==$(".ct .item").eq(e).find("span").text()&&$(".ct .item").eq(e).find("em").addClass("active");$(".ct .item").each(function(a){$(this).bind("click",function(){$(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active");var a=t.entity.records[$(this).index()].id,e=($(this).index(),t.entity.records[$(this).index()].accountName);$("#accountName button").html(e),btn_color_adjust(),$("#accountName").attr("value",a),$(".ct").remove(),remove_rTop(),add_page_title(),$("body").css({overflow:"scroll",height:"auto"})})})}function confirm(){$("#confirm").bind("click",function(){rtn_reg($("#contactName input"),reg_contactName)&&rtn_reg($("#phone input"),reg_phone)&&rtn_reg($("#department input"),reg_department)&&rtn_reg($("#post input"),reg_post)&&rtn_reg($("#tel input"),reg_tel)&&rtn_reg($("#email input"),reg_email)&&rtn_reg($("#address input"),reg_address)&&$("#accountName").attr("value")?info_submit():($("#accountName").attr("value")||myAlert("请选择公司"),reging())}),$("#add_contact").bind("click",function(){rtn_reg($("#contactName input"),reg_contactName)&&rtn_reg($("#phone input"),reg_phone)&&rtn_reg($("#department input"),reg_department)&&rtn_reg($("#post input"),reg_post)&&rtn_reg($("#tel input"),reg_tel)&&rtn_reg($("#email input"),reg_email)&&rtn_reg($("#address input"),reg_address)&&$("#accountName").attr("value")?info_submit("add_contact"):($("#accountName").attr("value")||myDialog("请选择公司"),reging())})}function reging(){""==$("#contactName input").val()?confirm_reg($("#contactName input"),reg_contactName,"联系人名称不能为空"):confirm_reg($("#contactName input"),reg_contactName,"联系人名称格式错误"),""==$("#phone input").val()?confirm_reg($("#phone input"),reg_phone,"联系人手机不能为空"):confirm_reg($("#phone input"),reg_phone,"联系人手机格式错误"),confirm_reg($("#department input"),reg_department,"部门格式错误"),confirm_reg($("#post input"),reg_post,"职务格式错误"),confirm_reg($("#tel input"),reg_tel,"座机格式错误"),confirm_reg($("#email input"),reg_email,"邮箱格式错误"),confirm_reg($("#address input"),reg_address,"地址格式错误")}function get_post(){$.ajax({type:"get",url:apppath+"/dingtalk/department/mydepartment.action",async:!0,success:function(data){console.log("部门"+data);var oData=eval("("+data+")");0==oData.success?myAlert("暂时无法获取数据，请稍后再试"):(postData=oData,setPost&&($("#ownerPost").attr("value",postData.entity.departs[0].id),$("#ownerPost  button").html(postData.entity.departs[0].text),getStartValue()))},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function change_post(){$("#ownerPost button").bind("click",function(){checkTable("选择所属部门");var t=$('<div id="container" class="container"></div>');$(".ct").append(t),build_list(t,postData)})}function build_list(t,a){for(var e=0;e<a.entity.departs.length;e++){var n=$('<div class="item"><em class="radio"><i></i></em><span>'+a.entity.departs[e].text+"</span></div>");n.attr("value",a.entity.departs[e].id),t.append(n)}for(var e=0;e<$(".ct .item").length;e++)$("#ownerPost button").html()==$(".ct .item").eq(e).find("span").text()&&$(".ct .item").eq(e).find("em").addClass("active");radio_click(a)}function radio_click(t){$(".ct .item").each(function(t){$(this).bind("click",function(){$(this).find("em").hasClass("active")||($(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active"));var t=$(this).attr("value"),a=$(this).find("span").text();$("#ownerPost > button").html(a),btn_color_adjust(),$("#ownerPost").attr("value",t),$(".ct").remove(),remove_rTop(),add_page_title(),$("body").css({overflow:"scroll",height:"auto"})})})}function info_submit(action){var url="";if("set"==GetQueryString("type")){url=apppath+"/dingtalk/contact/doupdate.action";var contactTemp={contactName:$("#contactName input").val(),mobile:$("#phone input").val(),accountId:$("#accountName").attr("value"),depart:$("#department > input").val(),post:$("#post input").val(),phone:$("#tel input").val(),email:$("#email input").val(),address:$("#address input").val(),comment:$("#remark textarea").val(),dimDepart:$("#ownerPost").attr("value"),gender:1,ownerId:ownerId,id:GetQueryString("contactId")}}else{url=apppath+"/dingtalk/contact/docreate.action";var contactTemp={contactName:$("#contactName input").val(),mobile:$("#phone input").val(),accountId:$("#accountName").attr("value"),depart:$("#department input").val(),post:$("#post input").val(),phone:$("#tel input").val(),email:$("#email input").val(),address:$("#address input").val(),comment:$("#remark textarea").val(),dimDepart:$("#ownerPost").attr("value"),gender:1,ownerId:ownerId}}console.log(contactTemp),$.ajax({type:"post",url:url,data:{contact:JSON.stringify(contactTemp)},async:!0,beforeSend:function(){$(".confirm").attr("disabled",!0),loader()},success:function(data){$(".loaderArea").remove();var oData=eval("("+data+")");if(1==oData.success){if("set"==GetQueryString("type")){var buriedPointType="contactUpdate";buriedPoint(buriedPointType)}else{var buriedPointType="contactAdd";buriedPoint(buriedPointType)}myDialog("保存成功"),setTimeout(function(){"add_contact"==action?location.href=apppath+"/dingtalk/contact/add.action?"+ddcommparams+"&from=acc_add&accountId="+$("#accountName").attr("value")+"&accountName="+$("#accountName button").html():"acc_add"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+$("#accountName").attr("value"):"con_list"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+oData.entity.id:"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("contactId"):"acc_info"==GetQueryString("from")&&(location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+oData.entity.id+"&from=acc_info&accountId="+GetQueryString("accountId"))},2e3)}else 0==oData.success&&($(".confirm").removeAttr("disabled"),oData.entity&&oData.entity.key&&"mobile"==oData.entity.key?myAlert("保存失败，手机号码重复"):oData.entity&&oData.entity.status&&"0000002"==oData.entity.status?myAlert("保存失败，不能包含表情符"):oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("保存失败，请检查输入信息"))},error:function(){$(".loaderArea").remove(),myAlert("暂时无法获取数据，请检查您的网络")}})}function set_info(){$.ajax({type:"get",url:apppath+"/dingtalk/contact/get.action",data:{contactId:GetQueryString("contactId")},async:!0,success:function(data){var oData=eval("("+data+")");console.log(oData),ownerId=oData.entity.ownerId,$("#contactName input").val(oData.entity.contactName),$("#phone input").val(oData.entity.mobile),$("#accountName").attr("value",oData.entity.accountId),$("#accountName button").html(oData.entity.accountName),btn_color_adjust(),$("#post input").val(oData.entity.post),$("#tel input").val(oData.entity.phone),$("#email input").val(oData.entity.email),$("#address input").val(oData.entity.address),$("#remark textarea").val(oData.entity.comment),$("#ownerPost").attr("value",oData.entity.dimDepart),$("#ownerPost  button").html(oData.entity.dimDepartText),btn_color_adjust(),getStartValue(),$("textarea").autoHeight(),textarea_num()}})}$(document).bind("ready",function(){get_post(),input_adjust(),add_page_title(),input_color_adjust(),btn_touch_style(),change_post(),remove_rTop(),$("textarea").autoHeight(),textarea_num(),contactNameReg(),"acc_add"==GetQueryString("from")?($("#accountName button").html(GetQueryString("accountName")),$("#add_contact").html("保存并添加更多"),btn_color_adjust(),$("#accountName").attr("value",GetQueryString("accountId")),set_back(apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("accountId"))):"acc_info"==GetQueryString("from")?($("#accountName button").html(GetQueryString("accountName")),$("#add_contact").html("确定并添加联系人"),btn_color_adjust(),$("#accountName").attr("value",GetQueryString("accountId")),set_back(apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("accountId"))):account_choose(),"con_list"==GetQueryString("from")&&$("#add_contact").remove(),"con_info"==GetQueryString("from")&&set_back(apppath+"dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("contactId")),"set"==GetQueryString("type")?(set_info(),$("#add_contact").remove(),$("#confirm").html("保存")):(setPost=!0,btn_color_adjust()),confirm(),"from_acc_info"==GetQueryString("type")&&($("#add_contact").remove(),$("#confirm").html("保存"))}),dd.ready(function(){control_back(backRemind)});var contactNameValue,phoneValue,accountNameValue,departmentValue,postValue,telValue,emailValue,addressValue,textareaValue,ownerPostValue,reg_contactName=/^.{1,50}$/,reg_phone=/^\d+|[-#*]{1,30}$/,reg_department=/^.{0,20}$/,reg_post=/^.{0,50}$/,reg_tel=/^\d+|[-#*]{0,30}$/,reg_email=/^(([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})){0,100}$/,reg_address=/^.{0,250}$/,postData,setPost=!1,ownerId=xsyUser.id;