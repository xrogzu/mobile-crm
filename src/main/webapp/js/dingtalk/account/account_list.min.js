function add_account(){location.href=apppath+"/dingtalk/account/add.action?"+ddcommparams+"&from=acc_list"}function acc_list_back(){"block"==$("#filter_area").css("display")?($("#filter_area").hide(),$(".filter").removeClass("active"),$(".filter").addClass("normal")):location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams}function filter(){stopScroll($("#filter_area"));var t=0;$("#filter").bind("click",function(){$("#filter_area .content").find(".filter_btn").length<=1&&create_filter(),0==t?($("#filter").addClass("active"),$("#filter").removeClass("normal"),t=1):($("#filter").addClass("normal"),$("#filter").removeClass("active"),t=0),$("#filter_area").toggle()})}function create_filter(){$.ajax({type:"get",url:apppath+"/dingtalk/account/getLevelInfo.action",async:!0,success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else{for(var arrValue=[],i=0;i<oData.entity.length;i++){var fbtn=$('<div class="filter_btn boxSizing">'+oData.entity[i].label+"</div>");arrValue.push(oData.entity[i].value),$("#filter_area .content").append(fbtn)}$("#filter_area .filter_btn").each(function(t){$(this).bind("click",function(){if(pageNo=0,$(this).addClass("active"),$(this).siblings().removeClass("active"),$("#filter_area").hide(),$("#list").children().remove(),$(this).index()>0){var t=arrValue[$(this).index()-1];arr=[],create_account_list(t)}else arr=[],create_account_list(0)})})}},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function earlyLoad(){if(xsyUser&&localStorage.getItem(xsyUser.id)){var t=JSON.parse(localStorage.getItem(xsyUser.id));t.accountList&&t.accountList.accListData&&(accListByData(t.accountList.accListData),pageNo=0)}}function create_account_list(level){$.ajax({type:"get",url:apppath+"/dingtalk/account/dolist.action",data:{pageNo:pageNo,pagesize:pageSize,level:level},async:!0,success:function(data){var oData=eval("("+data+")");if(0==oData.success)oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试");else{if(0==level&&xsyUser){var ls;localStorage.getItem(xsyUser.id)?(ls=JSON.parse(localStorage.getItem(xsyUser.id)),ls.accountList={accListData:oData}):ls={accountList:{accListData:oData}},localStorage.setItem(xsyUser.id,JSON.stringify(ls))}0==level&&$("#list").children().remove(),accListByData(oData)}},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function accListByData(t){arr=[];for(var a=0;a<t.entity.records.length;a++)arr.push(t.entity.records[a]);if(0==t.entity.records.length){var e=$('<div class="empty">暂无相关数据</div>');$("#list").append(e)}else build_list(arr);$("#list").find(".con").length<t.entity.totalSize?($("#loading").remove(),build_end("加载更多","load_more"),pageNo+=1,scroll_load()):$("#loading").remove()}function scroll_load(){$("#content").bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top<=$(window).height()-$("#load_more").height()-55&&($("#load_more").remove(),build_end("加载中…","loading"),create_account_list())})}function build_list(t){for(var a,e=0;e<t.length;e++){if(a=/(?!^(\d+|[~!@#$%^&*?]+)$)^[\w~!@#$%\^&*?]+$/.test(t[e].accountName_py.substr(0,1))?t[e].accountName_py.substr(0,1):"#",0==e){var i=$("<li></li>"),o=$('<div class="top boxSizing" id="'+a.toUpperCase()+'">'+a.toUpperCase()+"</div>");i.append(o)}else if(a!=t[e-1].accountName_py.substr(0,1)&&!/^\d$/.test(t[e].accountName_py.substr(0,1))){var i=$("<li></li>"),o=$('<div class="top boxSizing" id="'+a.toUpperCase()+'">'+a.toUpperCase()+"</div>");i.append(o)}$("#list").append(i);var c=document.createElement("div");$(c).attr("value",t[e].id),c.className="con boxSizing",$(c).append($('<div class="info"> <span class="accountName">'+t[e].accountName+'</span><em class="sign_in"></em></div>')),$(c).find("em").bind("click",function(t){location.href=apppath+"/dingtalk/activityrecord/qiandao.action?"+ddcommparams+"&belongId=1&objectId="+$(this).parent().parent().attr("value")+"&activityTypeId="+activeRecordTypeOje.SIGN_IN+"&from=acc_info&accountId="+$(this).parent().parent().attr("value"),t.stopPropagation()}),$("#list > li:last").append(c)}con_click(t)}function con_click(t){$("#list .con").each(function(a){$(this).click(function(){console.log(this.href),local_set(t[a].id,t[a].accountName,1),location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("value")})})}function local_set(t,a,e){if(1==e||2==e){var i={id:t,name:a,kindle:e};if(localStorage.getItem(userId)){var o=JSON.parse(localStorage.getItem(userId));if(o.accountHistory){for(var c=0;c<o.accountHistory.length;c++)o.accountHistory[c].id==t&&o.accountHistory.remove(c);o.accountHistory.push(i)}else var o={accountHistory:[i]}}else var o={accountHistory:[i]}}else if(3==e){var i={id:t,name:a};if("undefined"!=localStorage.getItem(userId)){var o=JSON.parse(localStorage.getItem(userId));if(o.opportunityHistory){for(var c=0;c<o.opportunityHistory.length;c++)o.opportunityHistory[c].id==t&&o.opportunityHistory.remove(c);o.opportunityHistory.push(i)}else var o={opportunityHistory:[i]}}else var o={opportunityHistory:[i]}}localStorage.setItem(userId,JSON.stringify(o))}function build_end(t,a){var e=$('<div id="'+a+'" class="end_info">'+t+"</div>");$("#list").append(e)}$(document).bind("ready",function(){earlyLoad(),$("#txt").bind("click",function(){location.href=apppath+"/dingtalk/account/search.action?"+ddcommparams}),create_account_list(0),filter(),$("#linkman").bind("click",function(){location.href=apppath+"/dingtalk/contact/list.action?"+ddcommparams}),$("#search").bind("click",function(){location.href=apppath+"/dingtalk/account/search.action?"+ddcommparams}),set_right("新建",add_account)}),dd.ready(function(){var t="accountList";buriedPoint(t),control_back(acc_list_back)});var pageNo=0,pageSize=20,arr=[],userId=xsyUser.id;