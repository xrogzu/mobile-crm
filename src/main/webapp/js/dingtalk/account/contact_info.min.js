function toContactList(){$(".ct").length>0?memberChange?myChoose("",ctRemove):ctRemove():"opp_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId"):"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId"):"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId"):"index"==GetQueryString("from")?GetQueryString("page")?location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page"):location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams:location.href=apppath+"/dingtalk/contact/list.action?"+ddcommparams}function ctRemove(){$("body").css("height",""),$("body").css("overflow",""),top_nav(),$(".ct").remove(),set_title("公司信息"),set_right("更多",more)}function more(){if($("#area").length>0)$("#area").remove();else{var t=$('<ul id="area" class="boxSizing"><div class="triangle"></div><li id="new_business">新建销售机会</li></ul>'),a=$('<li id="set_contact">编辑联系人</li>'),o=$('<li id="delete_contact">删除联系人</li>');dataPermission.update&&t.append(a),dataPermission["delete"]&&t.append(o),$("body").append(t),$("#area > #new_business").bind("click",function(){console.log("跳转到新建销售机会页面"),location.href=apppath+"/dingtalk/opportunity/add.action?"+ddcommparams+"&from=con_info&accountId="+accountId+"&contactId="+GetQueryString("contactId")}),$("#area > #set_contact").bind("click",function(){location.href=apppath+"/dingtalk/contact/add.action?"+ddcommparams+"&type=set&from=con_info&contactId="+GetQueryString("contactId")}),$("#area > #delete_contact").bind("click",function(){delete_dialog()})}}function delete_dialog(){var t=$('<div class="shadow"><div class="dia"><p class="boxSizing">确定删除吗?</p><div class="confirm"><div class="no">取消</div><div class="yes boxSizing">确认</div></div></div></div>');$("body").append(t),$(".dia").css({top:"200px",left:($(window).width()-$(".dia").width())/2}),$(".yes").bind("click",function(){$(".shadow").remove(),delete_contact(),$(".shadow").remove()}),$(".no").bind("click",function(){$(".shadow").remove()})}function delete_contact(){$.ajax({url:apppath+"/dingtalk/contact/dodel.action",data:{contactId:GetQueryString("contactId")},async:!1,success:function(data){var oData=eval("("+data+")");oData.success?($(".shadow").remove(),myDialog("删除成功"),location.href=apppath+"/dingtalk/contact/list.action?"+ddcommparams):myAlert("删除失败")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function top_nav(){$(window).bind("scroll",function(){$("body").scrollTop()>=nav_top?($("#topNav").css({position:"fixed",top:0}),$(".common").css("paddingBottom","90px")):($("#topNav").css({position:"",top:"",bottom:""}),$(".common").css({paddingBottom:"",position:"relative"}))})}function nav(){$("#nav li").each(function(){$(this).bind("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active"),tab($(this).attr("href"))})})}function tab(t){if($("html, body").animate({scrollTop:0},300),$("#topNav").css({position:"",top:"",bottom:""}),$(".common").css({paddingBottom:"",position:"relative"}),$(".content").fadeOut(300),"记录"==t){if(0==$("#record_tab").length){$(".tab").length>0&&$(".tab").remove();var a=$('<ul id="record_tab" class="tab record"><div class="main boxSizing"></div></ul>');$("body").append(a),recordPageNo=0,get_record($("#record_tab > .main"),20,"tab"),$("#record_tab").fadeIn(300)}}else if("商机"==t){if(0==$("#opportunity_tab").length){$(".tab").length>0&&$(".tab").remove();var a=$('<ul id="opportunity_tab" class="tab opportunity"><div class="main boxSizing"></div></ul>');$("body").append(a),opportunityPageNo=0,get_opportunity($("#opportunity_tab > .main"),20,"tab"),$("#opportunity_tab").fadeIn(300)}}else if("详情"==t){if(0==$("#info_tab").length){$(".tab").length>0&&$(".tab").remove();var a=$('<ul id="info_tab" class="tab details"><div class="main boxSizing"></div></ul>');$("body").append(a),get_info($("#info_tab > .main")),$("#info_tab").append($('<div class="staff boxSizing"> <div class="owner boxSizing"> <span class="label">负责人:</span> <span class="value"></span> </div></div>')),$("#info_tab").fadeIn(300)}}else"全部"==t&&($(".tab").remove(),$(".content").fadeIn(300))}function get_record($parent_obj,pagesize,type){$.ajax({url:apppath+"/dingtalk/activityrecord/dolist.action",data:{belongId:2,objectId:GetQueryString("contactId"),pagesize:pagesize,pageNo:recordPageNo},success:function(data){var oData=eval("("+data+")");if(console.log("跟进记录："+data),1==oData.success)if(0==oData.entity.records.length)$parent_obj.css("border",0),console.log("该对象暂无跟进记录");else{if(oData.entity.totalSize>5){if(0==$("#recordList .more").length){var more=$('<a class="more"></a>');$("#recordList > .top").append(more)}$("#recordList .more").bind("click",function(){$("#nav > .record").addClass("active"),$("#nav > .record").siblings().removeClass("active"),tab($("#nav > .record").attr("href"))})}var totalSize=oData.entity.totalSize;build_record_list($parent_obj,oData),$parent_obj.find("li").length<totalSize&&"tab"==type?($("#loading").remove(),build_end($parent_obj,"加载更多","load_more"),recordPageNo++,scroll_load($parent_obj,get_record)):$("#loading").remove()}else oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function build_record_list(t,a){for(var o=a.entity.records,n=0;n<o.length;n++){var e=o[n].user.userName,i=o[n].typeName,c=o[n].objectName,r=o[n].belongId,d=o[n].objectId,s=o[n].startTime.substr(-5),l=o[n].startTime.substr(0,11),p=o[n].recordType.type;if(0==n||o[n].startTime.substr(0,11)!=o[n-1].startTime.substr(0,11)){var m=$('<div class="day"><em></em><p class="startDate">'+l+'</p><div class="ban"></div></div>');t.append(m)}var u=$('<li class="boxSizing"><div class="info"><span class="userName">'+e+'</span><span class="typeName">'+i+':</span><span class="objectName">'+c+'</span><span class="startTime">'+s+"</span></div></li>");if(u.find(".objectName").attr({belongId:r,objectId:d}),d!=GetQueryString("contactId")&&u.find(".objectName").bind("click",function(){var t;1==$(this).attr("belongId")?t=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=con_info&rcontactId="+GetQueryString("contactId"):2==$(this).attr("belongId")?t=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=con_info&rcontactId="+GetQueryString("contactId"):3==$(this).attr("belongId")&&(t=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=con_info&rcontactId="+GetQueryString("contactId")),location.href=t}),"TEL"==p?u.addClass("phone_bg"):"SIGN_IN"==p?u.addClass("sign_in_bg"):"RECORD"==p&&u.addClass("record_bg"),o[n].content){var f=o[n].content,g=$('<span class="content_span">'+f+"</span>"),v=$('<div class="content"></div>'),b=$('<em class="triangle"></em>');if(v.append(g),v.append(b),f.length>32){var y=f.substr(0,30)+"...",_=$('<span class="short_content_span">'+y+"</span>");v.append(_),g.css("display","none");var h=0,I=$('<em class="more"></em>');I.bind("click",function(){h++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*h)+"deg)")}),v.append(I)}u.append(v)}if(o[n].location){var S=$('<div class="location">'+o[n].location+"</div>");u.append(S)}var k=$('<div class="bottom_border"></div>');u.append(k),t.append(u)}}function get_opportunity($parent_obj,pagesize,type){var timer=setInterval(function(){null!=accountId&&($.ajax({url:apppath+"/dingtalk/opportunity/dolist.action",data:{accountId:accountId,pageNo:opportunityPageNo,pagesize:pagesize},success:function(data){var oData=eval("("+data+")");if(console.log("销售机会："+data),1==oData.success)if(0==oData.entity.records.length)$parent_obj.css("border",0),console.log("该对象暂无销售机会信息");else{if(oData.entity.totalSize>3){if(0==$("#opportunityList .more").length){var more=$('<a class="more"></a>');$("#opportunityList > .top").append(more)}$("#opportunityList .more").bind("click",function(){$("#nav > .chance").addClass("active"),$("#nav > .chance").siblings().removeClass("active"),tab($("#nav > .chance").attr("href"))})}var totalSize=oData.entity.totalSize;$("#opportunityList > .top > .title").text("销售机会("+totalSize+")"),$("#opportunity_tab > .top").length>0&&$("#opportunity_tab > .top").text("销售机会("+totalSize+")"),$("#nav > .chance").text("销售机会("+totalSize+")"),build_opportunity($parent_obj,oData),$parent_obj.find("li").length<totalSize&&"tab"==type?($("#loading").remove(),build_end($parent_obj,"加载更多","load_more"),opportunityPageNo++,scroll_load($parent_obj,get_opportunity)):$("#loading").remove()}else 0==oData.success&&(oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试"))},error:function(t,a){myAlert("暂时无法获取数据，请检查您的网络")}}),clearInterval(timer))},30)}function build_opportunity(t,a){for(var o=0;o<a.entity.records.length;o++){var n=a.entity.records[o],e=n.saleStageText,i=n.opportunityName,c=n.money,r=n.accountName,d=n.id,s=n.saleStageOrder,l=n.saleStagePercentage,p=$('<li class="boxSizing"><em class="icon jieduan'+s+'"></em><div class="info"><div class="top"><span class="opportunityName">'+i+'</span><span class="Money">'+c+'元</span></div><div class="bot"><p class="accountName">'+r+'</p><p class="jieduan">阶段：'+e+'</p><span class="jieduan_p">'+l+"%</span></div></div></li>");p.attr("value",d),p.bind("click",function(){location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("value")+"&from=con_info&rcontactId="+GetQueryString("contactId")}),t.append(p)}}function icon_word(t){return/^[\u4e00-\u9fa5]+$/.test(t.substr(0,1))?t.substr(-2):t.substr(0,2)}function get_info($parent_obj){$.ajax({url:apppath+"/dingtalk/contact/get.action",data:{contactId:GetQueryString("contactId")},success:function(data){var oData=eval("("+data+")");console.log("联系人详情："+data),1==oData.success?(dataPermission=oData.entity.dataPermission,build_info($parent_obj,oData),$(".common .head_pic").html(icon_word(oData.entity.contactName)),$(".common .contactName").html(oData.entity.contactName),$(".common .accountName").html(oData.entity.accountName),$(".common .post").text(oData.entity.post),accountId=oData.entity.accountId,ownerName=oData.entity.ownerName,$(".owner .value").html(ownerName),ownerId=oData.entity.ownerId,dataPermission.transfer?change_owner():$(".staff>.owner").css("background","none")):"300032"==oData.errorCode?"opp_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=con_deleted":"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=con_deleted":"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=con_deleted":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=con_deleted":location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams):oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:oData.entity&&oData.entity.status&&"0000004"==oData.entity.status?"opp_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=con_noright":"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=con_noright":"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=con_noright":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=con_noright":location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&err=con_noright"):myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function build_info(t,a){var o=a.entity.contactName;if(info_atom_build(t,"姓名",o),o=a.entity.accountName,info_atom_build(t,"公司",o),o=a.entity.depart,info_atom_build(t,"部门",o),o=a.entity.post,info_atom_build(t,"职务",o),o=a.entity.mobile,info_atom_build(t,"手机",o),o=a.entity.phone,info_atom_build(t,"电话",o),o=a.entity.email,info_atom_build(t,"邮箱",o),o=a.entity.address,info_atom_build(t,"地址",o),o=a.entity.dimDepartText,info_atom_build(t,"所属部门",o),o=a.entity.comment,""!=o){var n=$('<li class="atom commentAtom boxSizing"><span class="label">备注:</span><span class="value"></span></li>'),e=o,i=$('<span class="content_span">'+e+"</span>"),c=$('<div class="content boxSizing"></div>');if(c.append(i),e.length>32){var r=e.substr(0,30)+"...",d=$('<span class="short_content_span">'+r+"</span>");c.append(d),i.css("display","none");var s=0,l=$('<em class="more"></em>');l.bind("click",function(){s++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*s)+"deg)")}),c.append(l)}n.find(".value").append(c),$(".staff .commentAtom").remove(),$(".staff").append(n)}}function info_atom_build(t,a,o){if(""!=o){if("手机"==a||"电话"==a){var n=$('<li class="atom boxSizing"><span class="label">'+a+'：</span><span class="value"><a href="tel:'+o+'"> '+o+"</a></span></li>");n.bind("click",function(){location.href=apppath+"/dingtalk/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=con_info&contactId="+GetQueryString("contactId")})}else if("公司"==a){var n=$('<li class="atom boxSizing"><span class="label">'+a+'：</span><span class="value blue">'+o+"</span></li>");n.find(".value").bind("click",function(){location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+accountId+"&from=con_info&rcontactId="+GetQueryString("contactId")})}else var n=$('<li class="atom boxSizing"><span class="label">'+a+'：</span><span class="value">'+o+"</span></li>");t.append(n)}}function change_owner(){$(".staff .owner").bind("click",function(){get_owner_list()})}function get_owner_list(){$.ajax({type:"get",url:apppath+"/dingtalk/xsyuser/pager.action",async:!0,success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("数据加载出错");else if(1==oData.entity.records.length){var no_contact=$('<div class="no_contact">您的公司下暂时没有其他员工</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("转移给他人");var container=$('<ul id="container" class="container ownerContainer"></ul>');$(".ct").append(container),build_owner_list(container,oData)}}})}function build_owner_list(t,a){for(var o=0;o<a.entity.records.length;o++){if(a.entity.records[o].label==$("#infoList .owner > .value").text())var n=$('<div class="item"><em class="radio active"><i></i></em><span>'+a.entity.records[o].label+"</span></div>");else var n=$('<div class="item"><em class="radio"><i></i></em><span>'+a.entity.records[o].label+"</span></div>");t.append(n)}radio_click(a)}function radio_click(data){$(".ct .item").each(function(index){$(this).bind("click",function(){function sub(){$.ajax({url:apppath+"/dingtalk/contact/trans.action",data:{contactId:GetQueryString("contactId"),ownerid:value},beforeSend:function(){loader()},success:function(data){$(".loaderArea").remove();var oData=eval("("+data+")");setTimeout(function(){ctRemove()},2e3),1==oData.success?($(".owner > .value").text(label),myDialog("负责人更改成功"),ownerId=value):myAlert("负责人更改失败")},error:function(){$(".loaderArea").remove(),myAlert("请检查网络")}})}$(this).find("em").hasClass("active")||($(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active"));var value=data.entity.records[$(this).index()].value,label=data.entity.records[$(this).index()].label;doChangeOwner(label,sub)})})}function create_confirm(data){var confirm=$('<button id="confirm" class="confirm">确定</button>');$(".ct").append(confirm),confirm.bind("touchstart",function(){$(this).addClass("touching")}),confirm.bind("touchend",function(){$(this).removeClass("touching")}),confirm.bind("click",function(){var arr_value=[];$(".item").each(function(){$(this).find("em").hasClass("active")&&arr_value.push($(this).attr("value"))}),console.log("团队成员提交"+arr_value.join(",")),$.ajax({type:"post",url:apppath+"/dingtalk/group/setrelateowner.action",data:{businessId:GetQueryString("contactId"),belongs:2,setOwnerIds:arr_value.join(",")},async:!0,success:function(data){var oData=eval("("+data+")");setTimeout(function(){$(".ct").remove(),$("body").css({height:"",overflow:""}),set_title("公司信息")},2e3),1==oData.success?(console.log("团队成员提交成功："+data),myDialog("更改成功"),get_member()):myAlert("更改失败")},error:function(t){myAlert("暂时无法获取数据，请检查您的网络")}})})}function footer_phone(){$("footer > .tel").bind("click",function(){$(window).scrollTop(0);var shadow=$('<div class="tel_bg"></div>');shadow.bind("click",function(){$(".tel_bg").remove(),$("#tel_list").remove()}),$("body").append(shadow),$(".tel_bg").css("top",$(document).scrollTop()),$(".tel_bg").fadeIn(200);var ul=$('<div id="tel_list"></div>');$.ajax({url:apppath+"/dingtalk/contact/get.action",data:{contactId:GetQueryString("contactId")},success:function(data){var oData=eval("("+data+")");add_atom(ul,oData.entity.mobile,"手机"),add_atom(ul,oData.entity.accountTel,"公司座机"),add_atom(ul,oData.entity.phone,"家庭电话");var rtn_btn=$('<div id="rtn_btn">取消</div>');rtn_btn.bind("click",function(){$("body").css({overflow:"",height:""}),$(".tel_bg").remove(),$("#tel_list").animate({bottom:-$("#tel_list").height()},300),setTimeout(function(){$("#tel_list").remove()},300)}),ul.append(rtn_btn),$("body").append(ul),$("body").css({overflow:"hidden",height:"100%"}),$("#tel_list").bind("touchmove",function(t){t.stopPropagation()}),$("#tel_list").css({bottom:-$("#tel_list").height()}),$("#tel_list").animate({bottom:"0"},300)}})})}function add_atom(t,a,o){if(a&&""!=a){var n=$('<a href="tel:'+a+'" class="tel_atom"><span class="label">'+o+'</span><span class="value">'+a+"</span></a>");n.bind("click",function(){location.href=apppath+"/dingtalk/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=con_info&contactId="+GetQueryString("contactId")}),t.append(n)}}function footer_signin(){$("footer > .signin").bind("click",function(){location.href=apppath+"/dingtalk/activityrecord/qiandao.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.SIGN_IN+"&from=con_info&contactId="+GetQueryString("contactId")})}function footer_create_record(){$("footer > .record").bind("click",function(){location.href=apppath+"/dingtalk/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+GetQueryString("contactId")+"&activityTypeId="+activeRecordTypeOje.RECORD+"&from=con_info&contactId="+GetQueryString("contactId")})}function build_end(t,a,o){var n=$('<div id="'+o+'" class="end_info">'+a+"</div>");t.append(n)}function scroll_load(t,a){var o=document.body.clientHeight;$(window).bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=o-$("#load_more").height()-50&&($("#load_more").remove(),build_end(t,"加载中…","loading"),a(t,20),$(this).unbind("scroll"),top_nav())})}$(document).bind("ready",function(){$("body").bind("click",function(){$("#area").length>0&&$("#area").remove()}),$("body").bind("touchmove",function(){$("#area").length>0&&$("#area").remove()}),change_owner(),set_cir_color($("header .head_pic")),top_nav(),nav(),get_record($("#recordList > .main"),5),get_opportunity($("#opportunityList > .main"),3),get_info($("#infoList > .main")),footer_phone(),footer_signin(),footer_create_record()}),dd.ready(function(){set_right("更多",more),control_back(toContactList);var t="contactDetail";buriedPoint(t)});var nav_top=$("#topNav").offset().top,recordPageNo=0,accountId,opportunityPageNo=0,ownerId,dataPermission,ownerName,memberChange=!1;