function use_map(){$("#my_position").bind("click",function(){$("#container").show(),$("#panel").show()})}function closeMap(){$("#container").hide(),$("#panel").hide()}function back(){"block"==$("#panel").css("display")?closeMap():"acc_list"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/list.action?"+ddcommparams:"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("accountId"):"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("contactId"):history.back()}function poibox_fix(){$("#panel .poibox").bind("click",function(){closeMap(),$("#my_position .value").text($(this).find(".poi-addr").text().substr(3)),$(this).css("background","#eee"),$(this).siblings().css("background","#fff")})}function get_date(){var t=new Date,a=t.getFullYear(),e=t.getMonth()+1,o=t.getDate(),n=t.getHours(),c=t.getMinutes();10>e&&(e="0"+String(e)),10>o&&(o="0"+String(o)),10>n&&(n="0"+String(n)),10>c&&(c="0"+String(c)),$("#current_time > .value").text(a+"年"+e+"月"+o+"日  "+n+":"+c)}function getObjectName(){switch(belongId){case 1:$.ajax({url:apppath+"/dingtalk/account/get.action",data:{accountId:objectId},success:function(data){var oData=eval("("+data+")"),objectName=oData.entity.accountName;$("#account .value").text(objectName)}});break;case 2:$.ajax({url:apppath+"/dingtalk/contact/get.action",data:{contactId:objectId},success:function(data){console.log(data);var oData=eval("("+data+")"),objectName=oData.entity.contactName;$("#account .value").text(objectName)}});break;case 3:$.ajax({url:apppath+"/dingtalk/opportunity/get.action",data:{opportunityId:objectId},success:function(data){var oData=eval("("+data+")"),objectName=oData.entity.opportunityName;$("#account .value").text(objectName)}})}}function confirm(){$("#confirm").unbind("click"),$("#confirm").bind("click",function(){var t=$("#textarea").val();if(""==t)myAlert("请填写备注");else{var a={content:t,belongId:belongId,activityTypeId:activityTypeId,objectId:objectId};a.position={longitude:lon,latitude:lat,location:$("#my_position .value").text(),locationDetail:$("#my_position .value").text()},create_record({activityRecordDtoString:JSON.stringify(a)},$("#confirm"))}})}$(window).bind("load",function(){use_map(),$("textarea").autoHeight(),remove_rTop(),get_date(),getObjectName(),textarea_num(),btn_touch_style()});var lon,lat;dd.ready(function(){control_back(back);var t=$('<div class="waiting">定位中，请稍后...</div>');$("body").append(t),dd.device.geolocation.get({targetAccuracy:10,onSuccess:function(t){lon=t.longitude,lat=t.latitude,$(".waiting").remove();var a=new AMap.Map("container",{resizeEnable:!0});a.plugin(["AMap.ToolBar"],function(){a.addControl(new AMap.ToolBar)}),AMap.service(["AMap.PlaceSearch"],function(){var t=new AMap.PlaceSearch({pageSize:10,pageIndex:1,map:a,panel:"panel"}),e=[lon,lat];t.searchNearBy("",e,200,function(t,a){var e=a.poiList.pois[0].address;$(".poi-more").remove(),confirm(),$("#my_position .value").text(e),poibox_fix(),console.log(a)})})},onFail:function(t){switch(error.code){case error.PERMISSION_DENIED:myAlert("定位失败,用户拒绝请求地理定位");break;case error.POSITION_UNAVAILABLE:myAlert("定位失败,位置信息是不可用");break;case error.TIMEOUT:myAlert("定位失败,请求获取用户位置超时");break;case error.UNKNOWN_ERROR:myAlert("定位失败,定位系统失效")}}})});var belongId=Number(GetQueryString("belongId")),objectId=GetQueryString("objectId"),activityTypeId=GetQueryString("activityTypeId"),source=0,u=navigator.userAgent,isAndroid=u.indexOf("Android")>-1||u.indexOf("Adr")>-1,isiOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);isAndroid?source=1:isiOS&&(source=2);