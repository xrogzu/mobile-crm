function setLocalStorage(){localStorage.getItem(xsyUser.id)||localStorage.setItem(xsyUser.id,JSON.stringify({index:{funnelData:"",rankData:"",oppData:""},opportunityHistory:"",accountHistory:""}))}function back(){$(".ct").length>0?($(".ct").remove(),set_title("首页"),$("body").css({height:"",overflow:""})):dd.biz.navigation.back()}function sort(){if("behavior"==GetQueryString("page")){actLoad||(followSum(),get_record($("#recordList > .main"),20),actLoad=!0),$("#sort .behavior").addClass("active"),$("#sort .performance").removeClass("active"),$("#behaviorPage").show(),$("#performancePage").hide();var e="behaviorStatistics";buriedPoint(e)}$("#sort .behavior").bind("click",function(){if(!$(this).hasClass("active")){actLoad||(followSum(),get_record($("#recordList > .main"),20),actLoad=!0);var e="behaviorStatistics";buriedPoint(e),$(this).addClass("active"),$("#sort .performance").removeClass("active"),$("#behaviorPage").show(),$("#performancePage").hide()}}),$("#sort .performance").bind("click",function(){if(!$(this).hasClass("active")){var e="amountStatistics";buriedPoint(e),$(this).addClass("active"),$("#sort .behavior").removeClass("active"),$("#performancePage").show(),$("#behaviorPage").hide()}})}function selectors(){$(".selector").bind("click",function(e){"block"==$(this).find(".options").css("display")?$(this).find(".options").hide():($(".options").hide(),$(this).find(".options").show(),$(this).offset().top-$(window).scrollTop()-60>$(this).find(".options").height()?($(this).find(".options").addClass("upper"),$(this).find(".options").removeClass("lower")):($(this).find(".options").addClass("lower"),$(this).find(".options").removeClass("upper"))),e.stopPropagation()}),$(".options li").each(function(){$(this).bind("click",function(e){$(this).parent().parent().find("span").text($(this).text()),$(this).parent().hide(),e.stopPropagation()})}),$("body").bind("touchmove",function(){$(".options").hide()}),$("body").bind("click",function(){$(".options").hide()})}function get_funnel(){function set_funnel(){$.ajax({url:apppath+"/wx/char/salesfunnel.action",data:{searchDateType:funnelDateType},success:function(data){console.log("漏斗："+data);var oData=eval("("+data+")");if(1==oData.success){if(4==funnelDateType){var ls;localStorage.getItem(xsyUser.id)?(ls=JSON.parse(localStorage.getItem(xsyUser.id)),ls.index={funnelData:oData}):ls={index:{funnelData:oData}},localStorage.setItem(xsyUser.id,JSON.stringify(ls))}funnelByData(oData)}else oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}if(4==funnelDateType&&localStorage.getItem(xsyUser.id)){var ls=JSON.parse(localStorage.getItem(xsyUser.id));ls.index&&ls.index.funnelData&&1==ls.index.funnelData.success&&funnelByData(ls.index.funnelData)}$(".funnelTop .selector .options li").each(function(){$(this).bind("click",function(){funnelDateType=$(this).attr("value"),set_funnel()})}),set_funnel()}function funnelByData(e){var t=e.entity.total,a=e.entity.win,n=e.entity.estimateCompleted,i=999999,o="元",s="元",r="元";t>i&&(t/=1e4,t=Math.round(100*t)/100,o="万元"),a>i&&(a/=1e4,a=Math.round(100*a)/100,s="万元"),n>i&&(n/=1e4,n=Math.round(100*n)/100,r="万元"),$(".whole .value").text(t),$(".predict .value").text(n),$(".actual .value").text(a),$(".whole .label").text("漏斗总值("+o+")"),$(".predict .label").text("预计完成("+r+")"),$(".actual .label").text("实际完成("+s+")");var l=e.entity.series;if(0==l[0].count&&0==l[1].count&&0==l[2].count&&0==l[3].count)$(".noDataFunnel").show(),$(".funnelArea").hide(),$("#aim").hide(),$("#saleFunnel > .title").hide(),$("#saleFunnel").addClass("noData");else if($(".funnelArea").show(),$("#aim").show(),$("#saleFunnel > .title").show(),$(".noDataFunnel").hide(),$("#saleFunnel").removeClass("noData"),"金额"==$("#saleFunnel .btn").text()){var d=l[0].amount,c=l[1].amount,p=l[2].amount,u=l[3].amount,f="元";(d>i||c>i||p>i||u>i)&&(f="(万元)",d/=1e4,d=Math.round(100*d)/100,c/=1e4,c=Math.round(100*c)/100,p/=1e4,p=Math.round(100*p)/100,u/=1e4,u=Math.round(100*u)/100),$("#leftLine .line1 .info").text(l[0].name),$("#rightLine .line1 .info").text(d+f),$("#leftLine .line2 .info").text(l[1].name),$("#rightLine .line2 .info").text(c+f),$("#leftLine .line3 .info").text(l[2].name),$("#rightLine .line3 .info").text(p+f),$("#leftLine .line4 .info").text(l[3].name),$("#rightLine .line4 .info").text(u+f),funnel(l[0].amount,l[1].amount,l[2].amount,l[3].amount)}else"个数"==$("#saleFunnel .btn").text()&&($("#leftLine .line1 .info").text(l[0].name),$("#rightLine .line1 .info").text(l[0].count),$("#leftLine .line2 .info").text(l[1].name),$("#rightLine .line2 .info").text(l[1].count),$("#leftLine .line3 .info").text(l[2].name),$("#rightLine .line3 .info").text(l[2].count),$("#leftLine .line4 .info").text(l[3].name),$("#rightLine .line4 .info").text(l[3].count),funnel(l[0].count,l[1].count,l[2].count,l[3].count))}function change_funnel(){$("#saleFunnel .btn").bind("click",function(){"个数"==$(this).text()?($(this).text("金额"),$(this).parent().find("span").text("(元)")):"金额"==$(this).text()&&($(this).text("个数"),$(this).parent().find("span").text("(个)")),get_funnel()})}function funnel(e,t,a,n){var i=35,o=$("#funnel").height(),s=o/(e+t+a+n)*n,r=o/(e+t+a+n)*a,l=o/(e+t+a+n)*t,d=o/(e+t+a+n)*e;i>s&&(s=i),i>r&&(r=i),i>l&&(l=i),i>d&&(d=i);var c=r/8*4,p=l/8*4,u=d/8*4,f=$("#funnel .funnel4").width(),h=f,m=h+2*c,g=m+2*p;$("#funnel .funnel4").css({borderTopWidth:s}),$("#funnel .funnel3").css({borderTopWidth:r,width:h,borderLeftWidth:c,borderRightWidth:c}),$("#funnel .funnel2").css({borderTopWidth:l,width:m,borderLeftWidth:p,borderRightWidth:p}),$("#funnel .funnel1").css({borderTopWidth:d,width:g,borderLeftWidth:u,borderRightWidth:u});var y=$(".line").height(),v=$("#funnel .funnel1").position().top+parseInt($("#funnel .funnel1").css("borderTopWidth"))-y-2,b=$("#funnel .funnel2").position().top+.8*parseInt($("#funnel .funnel2").css("borderTopWidth"))-y-2,x=$("#funnel .funnel3").position().top+.8*parseInt($("#funnel .funnel3").css("borderTopWidth"))-y-2,D=$("#funnel .funnel4").position().top+parseInt($("#funnel .funnel4").css("borderTopWidth"))-y-2;y>D-x&&(x=D-y-2),y>x-b&&(b=x-y-2),y>b-v&&(v=b-y-2);var _=($("#saleFunnel").width()-$("#funnel .funnel1").width())/2-80,k=($("#saleFunnel").width()-$("#funnel .funnel2").width()-p)/2-70,S=($("#saleFunnel").width()-$("#funnel .funnel3").width()-c)/2-70,w=($("#saleFunnel").width()-$("#funnel .funnel4").width())/2-70;$("#leftLine .line1").css({top:v-15,width:_}),$("#leftLine .line2").css({top:b-5,width:k}),$("#leftLine .line3").css({top:x,width:S}),$("#leftLine .line4").css({top:D-2,width:w}),$("#rightLine .line1").css({top:v-15,width:_}),$("#rightLine .line2").css({top:b-5,width:k}),$("#rightLine .line3").css({top:x,width:S}),$("#rightLine .line4").css({top:D-2,width:w})}function actSumSelect(){$(".actSum .selector .options li").each(function(){$(this).bind("click",function(){actDateType=$(this).attr("value"),followSum()})})}function followSum(){$(".actSum .list").children().remove(),$.ajax({url:apppath+"/wx/statics/activerecords.action",data:{searchDateType:actDateType},success:function(data){console.log("跟进汇总："+data);var oData=eval("("+data+")");1==oData.success?actSumByData(oData):oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:console.log("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function actSumByData(e){function t(){var e=$('<li class="boxSizing"> <em class="'+i+'"></em> <div> <span class="name">'+s+'</span> <span class="num">'+r+o+'</span> </div> <span class="count">'+l+"</span> </li>");1*l>0?e.find(".count").addClass("more"):0>1*l&&e.find(".count").addClass("less"),$(".actSum > ul").append(e)}for(var a=e.entity,n=0;n<a.length;n++){var i,o,s=a[n].text,r=a[n].count,l=(a[n].compare,a[n].count);"新建商机"==s?(s="新增销售机会",o="个",i="shangji",t()):"新建客户"==s?(s="新增公司",o="个",i="gongsi",t()):"电话"==s?(o="个",i="dianhua",t()):"拜访签到"==s?(s="签到",o="次",i="qiandao",t()):"记录"==s&&(o="个",i="jilu",t())}}function get_rank(){if(localStorage.getItem(xsyUser.id)){var e=JSON.parse(localStorage.getItem(xsyUser.id));e.index&&e.index.rankData&&1==e.index.rankData.success&&ranking(e.index.rankData)}$(".ranking .options li").each(function(){$(this).bind("click",function(){1==$(this).index()&&(rankDateType=4,$(".ranking .selector > span").text("本月")),2==$(this).index()&&(rankDateType=3,$(".ranking .selector > span").text("上月")),3==$(this).index()&&(rankDateType=7,$(".ranking .selector > span").text("本季")),4==$(this).index()&&(rankDateType=6,$(".ranking .selector > span").text("上季")),5==$(this).index()&&(rankDateType=10,$(".ranking .selector > span").text("本年")),6==$(this).index()&&(rankDateType=9,$(".ranking .selector > span").text("上年")),$(".ranking .list").children().remove(),$(".ranking .searchMore").remove(),get_rank_data(rankDateType)})})}function get_rank_data(rankDateType){console.log("rankDateType:"+rankDateType),$.ajax({url:apppath+"/wx/char/salesRank.action",data:{searchDateType:rankDateType},success:function(data){var oData=eval("("+data+")");if(1==oData.success){if(4==rankDateType){var ls;localStorage.getItem(xsyUser.id)?(ls=JSON.parse(localStorage.getItem(xsyUser.id)),ls.index={rankData:oData}):ls={index:{rankData:oData}},localStorage.setItem(xsyUser.id,JSON.stringify(ls))}ranking(oData)}else oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function ranking(e){function t(t,a){t.children().remove();for(var n=0;a>n;n++){var i=Number(e.entity.series[n].ord)+1;10>i&&(i="0"+String(i));var o=e.entity.series[n].userName,s=e.entity.series[n].money,r=$('<li> <span class="label">'+i+'</span> <span class="name">'+o+'</span> <p class="pillowBlock"><span class="pillow"></span></p> <span class="value">'+s+"</span> </li>"),l=e.entity.series[n].userId;xsyUser?xsyUser.id==l&&r.addClass("myself"):myAlert("未获取到当前用户"),t.append(r)}var d=t.find("li").width()-t.find("li").eq(0).find(".value").width()-190;t.find("li").eq(0).find(".pillow").css("width",d),t.find(".pillowBlock").css("width",d);for(var n=1;a>n;n++){var c=d/e.entity.series[0].money*e.entity.series[n].money;3>=c&&(c=3),t.find("li").eq(n).find(".pillow").css("width",c)}}console.log(e),0==e.entity.series.length||0==e.entity.series[0].money?($("#ranking .list").hide(),$("#ranking .noDataRanking").show()):($("#ranking .list").show(),$("#ranking .noDataRanking").hide());var a=10;e.entity.series.length<=10&&(a=e.entity.series.length),t($("#ranking .list"),a),$(".ct").length>0&&t($(".ct .list"),e.entity.series.length),e.entity.series.length>10&&($("#ranking .searchMore").remove(),$("#ranking").append('<div class="searchMore">查看全部</div>'),$(".searchMore").bind("click",function(){checkTable("业绩排名"),$(".ct").addClass("ranking");var a=$('<div class="title boxSizing"><p class="label">业绩总值</p><p class="value">'+e.entity.totalCount+"元</p></div>"),n=$('<div class="selector"> <span>本月</span> <ul class="options lower boxSizing"> <div class="triangle"></div> <li class="boxSizing">本月</li> <li class="boxSizing">上月</li> <li class="boxSizing">本季</li> <li class="boxSizing">上季</li> <li class="boxSizing">本年</li> <li class="boxSizing">上年</li> </ul> </div>');n.find("span").eq(0).text($("#ranking .selector >span").text()),a.append(n),n.bind("click",function(){return"block"==$(this).find(".options").css("display")?$(this).find(".options").hide():$(this).find(".options").show(),!1});var i=$('<ul class="list boxSizing"></ul>');$(".ct").append(a),$(".ct").append(i),t($(".ct .list"),e.entity.series.length),get_rank()}))}function recordSelect(){$("#recordList .selector .options li").each(function(){$(this).bind("click",function(){recordDateType=$(this).attr("value"),recordPageNo=0,$("#recordList > .main").children().remove(),get_record($("#recordList > .main"),20)})})}function get_record($parent_obj){$.ajax({url:apppath+"/wx/statics/activerecordlist.action",data:{pagesize:20,pageNo:recordPageNo,searchDateType:recordDateType},success:function(data){var oData=eval("("+data+")");console.log("跟进记录："+data),1==oData.success?recordByData(oData,$parent_obj):oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:(myAlert("暂时无法获取数据，请稍后再试"),console.log("跟进记录："+data))},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function recordByData(e,t){var a=e.entity.totalSize;$("#recordList > .top > .title > span").text("跟进记录("+a+")"),0==e.entity.records.length?(t.append($('<div class="noInfo">该范围内没有跟进记录</div>')),console.log("该对象暂无跟进记录")):(build_record_list(t,e),t.find("li").length<a?($("#loading").remove(),build_end(t,"加载更多","load_more"),recordPageNo++,scroll_load()):$("#loading").remove())}function build_end(e,t,a){var n=$('<div id="'+a+'" class="end_info">'+t+"</div>");e.append(n)}function scroll_load(){var e=document.body.clientHeight;$(window).bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=e-$("#load_more").height()-50&&($("#load_more").remove(),build_end($("#recordList > .main"),"加载中…","loading"),get_record($("#recordList > .main"),20),$(this).unbind("scroll"))})}function build_record_list(e,t){for(var a=t.entity.records,n=0;n<a.length;n++){var i=a[n].user.userName,o=a[n].typeName,s=a[n].objectName,r=a[n].belongId,l=a[n].objectId,d=a[n].startTime.substr(-5),c=a[n].startTime.substr(0,11),p=a[n].recordType.type;if(0!=n&&a[n].startTime.substr(0,11)!=a[n-1].startTime.substr(0,11))if(0==n&&e.find(".day").last().text==a[n].startTime.substr(0,11));else{var u=$('<div class="day"><em></em><p class="startDate">'+c+'</p><div class="ban"></div></div>');e.append(u)}else if(0==n&&0==recordPageNo){var u=$('<div class="day"><em></em><p class="startDate">'+c+'</p><div class="ban"></div></div>');e.append(u)}var f=$('<li class="boxSizing"><div class="info"><span class="userName">'+i+'</span><span class="typeName">'+o+':</span><span class="objectName">'+s+'</span><span class="startTime">'+d+"</span></div></li>");if(f.find(".objectName").attr({belongId:r,objectId:l}),f.find(".objectName").bind("click",function(){var e;1==$(this).attr("belongId")?e=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=index&page=behavior":2==$(this).attr("belongId")?e=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=index&page=behavior":3==$(this).attr("belongId")&&(e=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=index&page=behavior"),location.href=e}),"TEL"==p?f.addClass("phone_bg"):"SIGN_IN"==p?f.addClass("sign_in_bg"):"RECORD"==p&&f.addClass("record_bg"),a[n].content){var h=a[n].content,m=$('<span class="content_span">'+h+"</span>"),g=$('<div class="content"><em class="triangle"></em></div>');if(g.append(m),h.length>32){var y=h.substr(0,30)+"...",v=$('<span class="short_content_span">'+y+"</span>");g.append(v),m.css("display","none");var b=0,x=$('<em class="more"></em>');x.bind("click",function(){b++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*b)+"deg)")}),g.append(x)}f.append(g)}if(a[n].location){var D=$('<div class="location">'+a[n].location+"</div>");f.append(D)}var _=$('<div class="bottom_border"></div>');f.append(_),e.append(f)}removeBorder()}function removeBorder(){$("#record_tab li").each(function(){$(this).next().hasClass("day")&&$(this).find(".bottom_border").remove()})}function build_list_unit(e,t,a){var n=e.entity.records[a],i=n.saleStageText,o=n.opportunityName,s=n.money,r=n.accountName,l=n.id,d=n.saleStageOrder,c=n.saleStagePercentage,p=$('<li class="boxSizing"><em class="icon"></em><div class="info"><div class="top"><span class="opportunityName">'+o+'</span><span class="Money boxSizing">'+s+'元</span></div><div class="bot"><p class="accountName">'+r+'</p><p class="jieduan">阶段：'+i+'</p><span class="jieduan_p">'+c+"%</span></div></div></li>");p.attr("id",l),p.attr("name",o),p.find(".icon").addClass("jieduan"+d),p.bind("click",function(){location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("id")+"&from=index"}),t.append(p)}function listScrollFunc(){$("#content").bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top<=$(window).height()-$("#load_more").height()-53&&($("#load_more.end_info").remove(),$("#list .main").append($('<div id="loading" class="end_info">加载中…</div>')),build_opp_list(apppath+"/wx/statics/topopportunity.action",$("#list .main"),build_list_unit,listScrollFunc,"scroll"))})}function opp_options(){$("#list .selector .options li").each(function(){$(this).bind("click",function(){oppDateType=$(this).attr("value"),pageNo=0,build_opp_list(apppath+"/wx/statics/topopportunity.action",$("#list .main"),build_list_unit,listScrollFunc)})})}function build_opp_list(url,$container,build_unit,scrollFunc,type){obj={pageNo:pageNo,pagesize:pageSize,searchDateType:oppDateType},$.ajax({url:url,data:obj,async:!1,success:function(data){console.log("商机:"+data);var oData=eval("("+data+")");if(1==oData.success){if(4==oppDateType){var ls;localStorage.getItem(xsyUser.id)?(ls=JSON.parse(localStorage.getItem(xsyUser.id)),ls.index={oppData:oData}):ls={index:{oppData:oData}},localStorage.setItem(xsyUser.id,JSON.stringify(ls))}oppListByData(oData,$container,build_unit,scrollFunc,type)}else oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function oppListByData(e,t,a,n,i){"scroll"!=i&&t.children().remove();var o,s=e.entity.records.length;if(0==s)t.append($('<div class="noInfo">该范围内没有重点销售机会</div>'));else{o=s-pageNo*pageSize>pageSize?pageSize:s-pageNo*pageSize;for(var r=0;o>r;r++)a(e,t,r);t.children().length<s&&t.append($('<div id="load_more" class="end_info">加载更多</div>')),obj.pageNo++,pageNo++,$("#loading").remove(),n()}}$(document).bind("ready",function(){selectors(),sort(),actSumSelect(),recordSelect(),get_funnel(),change_funnel(),get_rank(),get_rank_data(rankDateType),opp_options(),build_opp_list(apppath+"/wx/statics/topopportunity.action",$("#list .main"),build_list_unit,listScrollFunc)}),dd.ready(function(){control_back(back),remove_rTop();var e="amountStatistics";buriedPoint(e)});var pageNo=0,pageSize=10,oppDateType=4,obj={pageNo:pageNo,pagesize:pageSize,searchDateType:oppDateType},actLoad=!1,funnelDateType=4,actDateType=1,rankDateType=4,mydata={entity:{series:[{ord:0,userId:75918,userName:"天天他",money:1e7},{ord:1,userId:34234,userName:"rete",money:4122220},{ord:2,userId:56565,userName:"尔特让",money:3332320},{ord:3,userId:34345,userName:"儿儿",money:2262220},{ord:4,userId:94524,userName:"有人人",money:666660},{ord:5,userId:45336,userName:"一天",money:658650},{ord:6,userId:56425,userName:"人额",money:76780},{ord:7,userId:36354,userName:"而人额",money:76770},{ord:8,userId:24455,userName:"人员",money:8670},{ord:9,userId:22222,userName:"河野谈",money:6660},{ord:10,userId:34341,userName:"发送的",money:210},{ord:11,userId:12213,userName:"发毒素",money:0},{ord:12,userId:22222,userName:"河野谈",money:6660},{ord:13,userId:34341,userName:"发送的",money:210},{ord:14,userId:12213,userName:"发毒素",money:0},{ord:15,userId:22222,userName:"河野谈",money:6660},{ord:16,userId:34341,userName:"发送的",money:2112330},{ord:17,userId:12213,userName:"发毒素",money:0}]},success:!0},recordDateType=1,recordPageNo=0;