function getStartValue(){opportunityNameValue=$("#opportunityName input").val(),accountIdValue=$("#accountName .value").attr("id"),moneyValue=$("#money input").val(),dateValue=$("#date input").val(),textareaValue=$("textarea").val(),ownerPostValue=$("#ownerPost  button").html()}function backRemind(){var t=!1;opportunityNameValue==$("#opportunityName input").val()&&accountIdValue==$("#accountName .value").attr("id")&&moneyValue==$("#money input").val()&&dateValue==$("#date input").val()&&ownerPostValue==$("#ownerPost  button").html()&&textareaValue==$("textarea").val()||(t=!0);var a;"opp_list"==GetQueryString("from")?a=apppath+"/dingtalk/opportunity/list.action?"+ddcommparams:"opp_info"==GetQueryString("from")?a=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("opportunityId"):"acc_info"==GetQueryString("from")?a=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("accountId"):"con_info"==GetQueryString("from")&&(a=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("contactId")),$(".ct").length>0?($("body").css("height",""),$(".ct").remove(),remove_rTop(),add_page_title(),$("body").css("overflow","")):t?0==$(".chooseShadow").length?myChoose(a):$(".chooseShadow").remove():location.href=a}function add_page_title(){null!=GetQueryString("type")&&"set"==GetQueryString("type")?set_title("编辑销售机会"):set_title("新建销售机会")}function get_accountName(){"acc_info"!=GetQueryString("from")&&"con_info"!=GetQueryString("from")||$.ajax({url:apppath+"/dingtalk/account/get.action",data:{accountId:GetQueryString("accountId")},success:function(data){var oData=eval("("+data+")");$("#accountName .value").text(oData.entity.accountName),$("#accountName .value").css("color","#222"),$("#accountName").attr("value",GetQueryString("accountId")),getStartValue()}})}function select_date(){if("set"!=GetQueryString("type")){var t=new Date,a=t.getFullYear(),e=t.getMonth()+1,o=t.getDate();10>e&&(e="0"+String(e)),10>o&&(o="0"+String(o));var n=a+"-"+e+"-"+o;$("#date .value").text(n)}dd.ready(function(){$("#date .value").bind("click",function(){dd.biz.util.datepicker({format:"yyyy-MM-dd",value:n,onSuccess:function(t){$("#date .value").text(t.value)},onFail:function(){}})})})}function confirm(){$("#confirm").bind("touchstart",function(){$(this).addClass("touching")}),$("#confirm").bind("touchend",function(){$(this).removeClass("touching")}),$("#confirm").bind("click",function(){var t="";$("#accountName").attr("value")&&(t=$("#accountName").attr("value")),rtn_reg($("#opportunityName .value"),reg_opportunityName)&&""!=t&&rtn_reg($("#money .value"),reg_money)?submit(url):(confirm_reg($("#opportunityName .value"),reg_opportunityName,"销售机会名称格式错误"),""==t&&confirm_reg($("#accountName .value"),reg_accountName,"请选择公司"),confirm_reg($("#money .value"),reg_money,"预计金额格式错误"))})}function submit(url){var opportunityName=$("#opportunityName .value").val(),accountId=Number($("#accountName").attr("value")),closeDate=$("#date .value").text(),money=Number($("#money .value").val()),comment=$("#textarea").val(),subData={ownerId:ownerId,opportunityName:opportunityName,accountId:accountId,closeDate:closeDate,money:money,comment:comment,opportunityType:1,dimDepart:$("#ownerPost").attr("value")};"set"==GetQueryString("type")&&(subData.id=GetQueryString("opportunityId")),console.log(JSON.stringify(subData)),$.ajax({url:url,type:"post",data:{opportunity:JSON.stringify(subData)},beforeSend:function(){$("#confirm").attr("disabled",!0),loader()},success:function(data){$(".loaderArea").remove();var oData=eval("("+data+")");if(1==oData.success){if("set"==GetQueryString("type")){var buriedPointType="oppUpdate";buriedPoint(buriedPointType)}else{var buriedPointType="oppAdd";buriedPoint(buriedPointType)}var opportunityId=oData.entity.id;"set"==GetQueryString("type")&&(opportunityId=GetQueryString("opportunityId")),myDialog("保存成功");var url;"opp_list"==GetQueryString("from")?url=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+opportunityId+"&from=opp_list":"opp_info"==GetQueryString("from")?url=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+opportunityId+"&from=opp_list":"acc_info"==GetQueryString("from")?url=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+opportunityId+"&from=acc_info&accountId="+GetQueryString("accountId"):"con_info"==GetQueryString("from")&&(url=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&&opportunityId="+opportunityId+"&from=con_info&contactId="+GetQueryString("contactId")),time_out_location(url)}else 0==oData.success&&(console.log(oData),$("#confirm").removeAttr("disabled"),oData.entity&&oData.entity.key&&"opportunityName"==oData.entity.key?myAlert("保存失败，销售机会名称重复"):oData.entity&&oData.entity.status&&"0000002"==oData.entity.status?myAlert("保存失败，不能包含表情符"):oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("保存失败，请检查输入信息"))},error:function(){$(".loaderArea").remove(),myAlert("暂时无法获取数据，请检查您的网络")}})}function account_choose(){$("#accountName .value").bind("click",function(){checkTable("选择公司"),$.ajax({url:apppath+"/dingtalk/account/dolist.action",success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else if(0==oData.entity.records.length){var no_contact=$('<div class="no_contact">暂无公司，请新建公司</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else create_list(oData)}})})}function create_list(t){console.log(t);for(var a=$('<div class="container"></div>'),e=0;e<t.entity.records.length;e++){var o=$('<div class="item boxSizing" href="'+t.entity.records[e].id+'"><em class="radio"><i></i></em><span>'+t.entity.records[e].accountName+"</span></div>");a.append(o)}$(".ct").append(a);for(var e=0;e<$(".ct .item").length;e++)$("#accountName button").html()==$(".ct .item").eq(e).find("span").text()&&$(".ct .item").eq(e).find("em").addClass("active");$(".ct .item").each(function(a){$(this).bind("click",function(){$(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active");var a=t.entity.records[$(this).index()].id,e=($(this).index(),t.entity.records[$(this).index()].accountName);$("#accountName .value").html(e),$("#accountName .value").css("color","#222"),$("#accountName").attr("value",a),$(".ct").remove(),remove_rTop(),add_page_title(),$("body").css({overflow:"scroll",height:"auto"})})})}function get_post(){$.ajax({type:"get",url:apppath+"/dingtalk/department/mydepartment.action",async:!0,success:function(data){console.log("部门"+data);var oData=eval("("+data+")");0==oData.success?myAlert("暂时无法获取数据，请稍后再试"):(postData=oData,setPost&&($("#ownerPost").attr("value",postData.entity.departs[0].id),$("#ownerPost  button").html(postData.entity.departs[0].text),btn_color_adjust(),getStartValue()))},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function change_post(){$("#ownerPost button").bind("click",function(){checkTable("选择所属部门");var t=$('<div id="container" class="container"></div>');$(".ct").append(t),build_list(t,postData)})}function build_list(t,a){for(var e=0;e<a.entity.departs.length;e++){var o=$('<div class="item"><em class="radio"><i></i></em><span>'+a.entity.departs[e].text+"</span></div>");o.attr("value",a.entity.departs[e].id),t.append(o)}for(var e=0;e<$(".ct .item").length;e++)$("#ownerPost button").html()==$(".ct .item").eq(e).find("span").text()&&$(".ct .item").eq(e).find("em").addClass("active");radio_click(a)}function radio_click(t){$(".ct .item").each(function(t){$(this).bind("click",function(){$(this).find("em").hasClass("active")||($(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active"));var t=$(this).attr("value"),a=$(this).find("span").text();$("#ownerPost > button").html(a),btn_color_adjust(),$("#ownerPost").attr("value",t),$(".ct").remove(),remove_rTop(),add_page_title(),$("body").css({overflow:"scroll",height:"auto"})})})}function set_info(){$.ajax({url:apppath+"/dingtalk/opportunity/get.action",data:{opportunityId:GetQueryString("opportunityId")},success:function(data){console.log(data);var oData=eval("("+data+")");if(1==oData.success){ownerId=oData.entity.ownerId;var opportunityName=oData.entity.opportunityName,accountName=oData.entity.accountName,accountId=oData.entity.accountId,money=oData.entity.money,closeDate=oData.entity.closeDate.substr(0,10),comment=oData.entity.comment;$("#opportunityName .value").val(opportunityName),$("#accountName .value").text(accountName),$("#accountName").attr("value",accountId),$("#accountName .value").css("color","black"),$("#money .value").val(money),$("#date .value").text(closeDate),$("#ownerPost").attr("value",oData.entity.dimDepart),$("#ownerPost  button").html(oData.entity.dimDepartText),btn_color_adjust(),$("#textarea").val(comment),$("#num").text($("#textarea").val().length+"/1000"),$("textarea").autoHeight(),getStartValue()}}})}$(document).bind("ready",function(){input_adjust(),remove_rTop(),$("textarea").autoHeight(),textarea_num(),get_accountName(),change_post(),get_post(),confirm(),select_date(),"set"==GetQueryString("type")?(set_info(),$("#accountName .value").css("background","none")):(account_choose(),setPost=!0)}),dd.ready(function(){add_page_title(),control_back(backRemind)});var opportunityNameValue,accountIdValue,moneyValue,dateValue,textareaValue,ownerPostValue,url=apppath+"/dingtalk/opportunity/docreate.action";"set"==GetQueryString("type")&&(url=apppath+"/dingtalk/opportunity/doupdate.action");var reg_opportunityName=/^.{1,50}$/,reg_money=/^\d{1,10}$/,reg_accountName=/\S/,postData,setPost=!1,ownerId=xsyUser.id;