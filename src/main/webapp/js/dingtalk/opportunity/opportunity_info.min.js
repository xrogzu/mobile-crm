function more(){if($("#saleStage").hide(),$(".shadow").hide(),$("#area").length>0)$("#area").remove();else{var t=$('<ul id="area" class="boxSizing"><div class="triangle"></div> <li id="relevance_contact">关联联系人</li></ul>'),a=$('<li id="set_opportunity">编辑销售机会</li>'),e=$('<li id="delete_opportunity">删除销售机会</li>');dataPermission.update&&t.append(a),dataPermission["delete"]&&t.append(e),$("body").append(t),$("#area > #relevance_contact").bind("click",function(){$("#area").remove(),relevance_contact()}),$("#area > #set_opportunity").bind("click",function(){$("#area").remove(),location.href=apppath+"/dingtalk/opportunity/add.action?"+ddcommparams+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")+"&type=set"}),$("#area > #delete_opportunity").bind("click",function(){$("#area").remove(),delete_dialog()})}}function relevance_contact(){$.ajax({url:apppath+"/dingtalk/contact/dolist.action",data:{pageNo:0,pogesize:20,accountId:accountId},success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else if(console.log("关联联系人："+data),0==oData.entity.records.length){var no_contact=$('<div class="no_contact">暂无联系人可关联，请添加联系人</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("关联联系人");var container=$('<div id="container" class="container"></div>');$(".ct").append(container),build_member_list(container,oData,apppath+"/dingtalk/opportunity/setcontacts.action")}}})}function delete_dialog(){var t=$('<div class="delShadow"><div class="dia"><p class="boxSizing">确定删除吗?</p><div class="confirm"><div class="no">取消</div><div class="yes boxSizing">确认</div></div></div></div>');$("body").append(t),$(".dia").css({top:"200px",left:($(window).width()-$(".dia").width())/2}),$(".yes").bind("click",function(){delete_opportunity(),$(".delShadow").remove()}),$(".no").bind("click",function(){$(".delShadow").remove()})}function delete_opportunity(){$.ajax({url:apppath+"/dingtalk/opportunity/dodel.action",data:{opportunityId:GetQueryString("opportunityId")},success:function(data){var oData=eval("("+data+")");1==oData.success&&0==oData.entity.status?(myDialog("删除成功"),time_out_location(apppath+"/dingtalk/opportunity/list.action?"+ddcommparams)):myAlert("删除失败")}})}function saleStagePush(){$("#opportunityInfo .advance").bind("click",function(){$(window).scrollTop(0),$(".shadow").fadeIn(),$("#saleStage").fadeIn(),$("#saleStage #exitSaleStage").bind("click",function(){$("#saleStage").fadeOut(),$(".shadow").fadeOut()}),0==$("#saleStage .bottom li").length&&$.ajax({url:apppath+"/dingtalk/opportunity/getSaleStage.action",success:function(data){var oData=eval("("+data+")");if(1==oData.success){$("#saleStage .bottom").children().remove();for(var i=0;i<oData.entity.length;i++){var item=$('<li><em></em><span class="label">'+oData.entity[i].label+'</span><span class="percent">'+oData.entity[i].percent+"%</span></li>");$("#saleStage .bottom").append(item),item.attr("value",oData.entity[i].value),item.bind("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active");var t=$(this).attr("value");change_stage(t)})}$("#saleStage .bottom li").eq(order-1).addClass("active")}}})})}function change_stage(saleStageId){var saleStageId=Number(saleStageId),saveData={id:Number(GetQueryString("opportunityId")),opportunityName:opportunityName,opportunityType:opportunityType,closeDate:closeDate,accountId:accountId,dimDepart:dimDepart,ownerId:ownerId,money:money,saleStageId:saleStageId};$.ajax({url:apppath+"/dingtalk/opportunity/doupdate.action",data:{opportunity:JSON.stringify(saveData)},beforeSend:function(){loader()},success:function(data){$(".loaderArea").remove();var oData=eval("("+data+")");if(1==oData.success){var buriedPointType="oppForward";buriedPoint(buriedPointType),myDialog("保存成功"),get_info($("")),setTimeout(function(){$("#saleStage").fadeOut(),$(".shadow").fadeOut()},2e3)}else myDialog("保存失败","without"),$("#saleStage").fadeOut(),$(".shadow").fadeOut()},error:function(){$(".loaderArea").remove(),myAlert("请检查网络")}})}function closeStage(){"block"==$("#saleStage").css("display")?($("#saleStage").fadeOut(),$(".shadow").fadeOut()):$(".ct").length>0?memberChange?myChoose("",ctRemove):ctRemove():"opp_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId"):"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId"):"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId"):"index"==GetQueryString("from")?GetQueryString("page")?location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page"):location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams:location.href=apppath+"/dingtalk/opportunity/list.action?"+ddcommparams}function ctRemove(){$("body").css("height",""),$("body").css("overflow",""),ceilingJudge(),$(".ct").remove(),set_title("销售机会详情"),set_right("更多",more)}function drawCircle(t){var a=$("#picture").width()/2;$("#circle").attr({height:2*a,width:2*a});var e=document.getElementById("circle").getContext("2d");e.beginPath(),e.arc(a,a,a-14,0*Math.PI,2*Math.PI,!1),e.lineWidth=25,0==t?e.strokeStyle="#ff5747":e.strokeStyle="#e1e8ed",e.stroke(),e.closePath();var t=1.5+t/100*2;e.beginPath(),e.arc(a,a,a-14,1.5*Math.PI,Math.PI*t,!1),e.lineWidth=25,e.strokeStyle="#22d2a6",e.stroke(),e.closePath()}function top_nav(){$(window).bind("scroll",function(){ceilingJudge()})}function ceilingJudge(){$("body").scrollTop()>=nav_top+120?($("#opportunityInfo").css("marginBottom",nav_height+20+"px"),$("#topNav").css({position:"fixed",top:0})):($("#opportunityInfo").css("marginBottom",0),$("#topNav").css({position:"static"}))}function nav(){$("#nav li").each(function(){$(this).bind("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active"),tab($(this).attr("href"))})})}function tab(t){if($("html, body").animate({scrollTop:0},300),$("#opportunityInfo").css("marginBottom",0),$("#topNav").css({position:"static"}),$(".content").fadeOut(300),$("#opportunityInfo").css("marginBottom",0),$("#topNav").css({position:"static"}),$(".content").fadeOut(300),"联系人"==t){if(0==$("#contact_tab").length){$(".tab").length>0&&$(".tab").remove();var a=$('<ul id="contact_tab" class="tab contact contactArea"><div class="main boxSizing"></div></ul>');$("body").append(a),contactPageNo=0,get_contacts($("#contact_tab > .main"),20,"tab"),$("#contact_tab").fadeIn(300)}}else if("记录"==t){if(0==$("#record_tab").length){$(".tab").length>0&&$(".tab").remove();var a=$('<ul id="record_tab" class="tab record recordArea"><div class="main boxSizing"></div></ul>');$("body").append(a),recordPageNo=0,get_record($("#record_tab > .main"),20,"tab"),$("#record_tab").fadeIn(300)}}else if("详情"==t){if(0==$("#info_tab").length){$(".tab").length>0&&$(".tab").remove();var a=$('<ul id="info_tab" class="tab details infoArea"><div class="main boxSizing"></div></ul>');$("body").append(a),get_info($("#info_tab > .main")),$("#info_tab").append($('<div class="staff boxSizing"> <div class="owner boxSizing"> <span class="label">负责人:</span> <span class="value"></span> </div> <div class="member boxSizing"> <span class="label">团队成员:</span> <span class="value"></span> </div> </div>')),xsyUser.id==ownerId&&(change_owner(),change_member()),$("#info_tab").fadeIn(300)}}else"全部"==t&&($(".tab").remove(),$(".content").fadeIn(300))}function get_record($parent_obj,pagesize,type){$parent_obj.children().remove(),$.ajax({url:apppath+"/dingtalk/activityrecord/dolist.action",data:{belongId:3,objectId:GetQueryString("opportunityId"),pagesize:pagesize,pageNo:recordPageNo},success:function(data){var oData=eval("("+data+")");if(console.log("跟进记录："),console.log(data),1==oData.success)if(0==oData.entity.records.length)$parent_obj.css("border",0),console.log("该对象暂无跟进记录");else{if(oData.entity.totalSize>5){if(0==$("#recordList .more").length){var more=$('<a class="more"></a>');$("#recordList > .top").append(more)}$("#recordList .more").bind("click",function(){$("#nav > .record").addClass("active"),$("#nav > .record").siblings().removeClass("active"),tab($("#nav > .record").attr("href"))})}var totalSize=oData.entity.totalSize;build_record_list($parent_obj,oData),$parent_obj.find("li").length<totalSize&&"tab"==type?($("#loading").remove(),build_end($parent_obj,"加载更多","load_more"),recordPageNo++,scroll_load($parent_obj,get_record)):$("#loading").remove()}else oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){console.log("暂时无法获取数据，请检查您的网络")}})}function build_record_list(t,a){for(var e=a.entity.records,o=0;o<e.length;o++){var n=e[o].user.userName,i=e[o].typeName,r=e[o].objectName,c=e[o].belongId,s=e[o].objectId,d=e[o].startTime.substr(-5),l=e[o].startTime.substr(0,11),p=e[o].type;if(0==o||e[o].startTime.substr(0,11)!=e[o-1].startTime.substr(0,11)){var u=$('<div class="day"><em></em><p class="startDate">'+l+'</p><div class="ban"></div></div>');t.append(u)}var m=$('<li class="boxSizing"><div class="info"><span class="userName">'+n+'</span><span class="typeName">'+i+':</span><span class="objectName">'+r+'</span><span class="startTime">'+d+"</span></div></li>");if(m.find(".objectName").attr({belongId:c,objectId:s}),s!=GetQueryString("opportunityId")&&m.find(".objectName").bind("click",function(){var t;1==$(this).attr("belongId")?t=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=con_info&ropportunityId="+GetQueryString("opportunityId"):2==$(this).attr("belongId")?t=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=con_info&ropportunityId="+GetQueryString("opportunityId"):3==$(this).attr("belongId")&&(t=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=con_info&ropportunityId="+GetQueryString("opportunityId")),location.href=t}),p==activeRecordTypeOje.DO_DING?m.addClass("ding_bg"):p==activeRecordTypeOje.TEL?m.addClass("phone_bg"):p==activeRecordTypeOje.SIGN_IN?m.addClass("sign_in_bg"):p==activeRecordTypeOje.RECORD&&m.addClass("record_bg"),e[o].content){var g=e[o].content,f=$('<span class="content_span">'+g+"</span>"),v=$('<div class="content"><em class="triangle"></em></div>');if(v.append(f),g.length>32){var y=g.substr(0,30)+"...",b=$('<span class="short_content_span">'+y+"</span>");v.append(b),f.css("display","none");var h=0,_=$('<em class="more"></em>');_.bind("click",function(){h++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*h)+"deg)")}),v.append(_)}m.append(v)}if(e[o].location){var I=$('<div class="location">'+e[o].location+"</div>");m.append(I)}var S=$('<div class="bottom_border"></div>');m.append(S),t.append(m)}removeBorder()}function removeBorder(){$("#record_tab li").each(function(){$(this).next().hasClass("day")&&$(this).find("div:last-child").css("borderBottom",0)})}function get_contacts($parent_obj,pagesize,type){contactIdArr=[],$.ajax({url:apppath+"/dingtalk/opportunity/contacts.action",data:{opportunityId:GetQueryString("opportunityId")},success:function(data){var oData=eval("("+data+")");if(console.log("联系人："),console.log(data),1==oData.success){var totalSize=oData.entity.totalSize;if($("#contactList > .top > .title").text("联系人("+totalSize+")"),$("#nav > .contact").text("联系人("+totalSize+")"),0==totalSize)$parent_obj.css("border",0),console.log("该对象暂无联系人信息");else{if(totalSize>5){if(0==$("#contactList .more").length){var more=$('<a class="more"></a>');$("#contactList > .top").append(more)}$("#contactList .more").bind("click",function(){$("#nav > .contact").addClass("active"),$("#nav > .contact").siblings().removeClass("active"),tab($("#nav > .contact").attr("href"))})}for(var i=0;totalSize>i;i++)contactIdArr.push(oData.entity.contacts[i].contactId);build_contact_list($parent_obj,oData,pagesize),$parent_obj.find("li").length<totalSize&&"tab"==type?($("#loading").remove(),build_end($parent_obj,"加载更多","load_more"),contactPageNo++,scroll_load($parent_obj,get_contacts)):$("#loading").remove()}}else oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function build_contact_list(t,a,e){var o=a.entity.contacts,n=o.length;5==e&&n>=5&&(n=5);for(var i=0;n>i;i++){var r=o[i].contactName,c=o[i].post,s=o[i].phone,d=o[i].contactId,l=$('<li class="boxSizing"><span class="name">'+r+'</span><span class="post">'+c+'</span><a href="tel:'+s+'" class="tel"></a></li>');l.attr("value",d),l.bind("click",function(){location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("value")+"&from=opp_info&ropportunityId="+GetQueryString("opportunityId")}),l.find(".tel").bind("click",function(t){$(this).parent().attr("value");location.href=apppath+"/dingtalk/activityrecord/create.action?"+ddcommparams+"&belongId=2&objectId="+$(this).attr("value")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=opp_info&opportunityId="+GetQueryString("opportunityId"),t.stopPropagation()}),t.append(l)}}function get_info($parent_obj){var opportunityId=GetQueryString("opportunityId");$.ajax({url:apppath+"/dingtalk/opportunity/get.action",data:{opportunityId:opportunityId},success:function(data){var oData=eval("("+data+")");if(console.log("详情"+data),1==oData.success){dataPermission=oData.entity.dataPermission,accountId=oData.entity.accountId,opportunityType=oData.entity.opportunityType,closeDate=oData.entity.closeDate.substr(0,10),opportunityName=oData.entity.opportunityName,ownerId=oData.entity.ownerId,dimDepart=oData.entity.dimDepart,dataPermission.transfer?change_owner():$(".staff>.owner").css("background","none"),dataPermission.update?(change_member(),saleStagePush()):($(".staff>.member").css("background","none"),$("#opportunityInfo .advance").addClass("unable"));var saleStageText=oData.entity.saleStageText;money=oData.entity.money;var percent=oData.entity.saleStagePercentage;ownerName=oData.entity.ownerText,order=oData.entity.saleStageOrder;var orderArr=["","一","二","三","四","五","六","七","八","九"];$("#text .opportunityName").html(opportunityName),$("#text .saleStage").html("第"+orderArr[order]+"阶段："+saleStageText),$("#text .money").html(money+"元"),$(".owner .value").text(ownerName),get_member(),drawCircle(percent),$("#picture .percent").html(percent+"%"),0==percent?($("#progress .title").hide(),$("#progress .percent").hide(),$("#progress").append($('<p class="looseProgress">输单</p>'))):($("#progress .title").show(),$("#progress .percent").show(),$("#progress .looseProgress").remove()),build_info($parent_obj,oData)}else"300032"==oData.errorCode?"opp_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=opp_deleted":"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=opp_deleted":"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=opp_deleted":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=opp_deleted":location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams):oData.entity&&oData.entity.status&&"0000003"==oData.entity.status?location.href=apppath+"/dingtalk/authorized/no.action?"+ddcommparams:oData.entity&&oData.entity.status&&"0000004"==oData.entity.status?"opp_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+GetQueryString("ropportunityId")+"&err=opp_noright":"con_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/contact/info.action?"+ddcommparams+"&contactId="+GetQueryString("rcontactId")+"&err=opp_noright":"acc_info"==GetQueryString("from")?location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+GetQueryString("raccountId")+"&err=opp_noright":"index"==GetQueryString("from")&&(GetQueryString("page")?location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&page="+GetQueryString("page")+"&err=opp_noright":location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams+"&err=opp_noright"):myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function build_info(t,a){console.log("详情"),console.log(a);var e=a.entity.opportunityName;if(info_atom_build(t,"机会名称",e),e=a.entity.accountName,info_atom_build(t,"公司名称",e),e=a.entity.money,info_atom_build(t,"预计金额",e),e=a.entity.closeDate.substr(0,11),info_atom_build(t,"结单日期",e),e=a.entity.dimDepartText,info_atom_build(t,"所属部门",e),e=a.entity.comment,""!=e){var o=$('<li class="atom commentAtom boxSizing" style="border-top: 1px solid #e3e3e5"><span class="label">备注:</span><span class="value"></span></li>'),n=e,i=$('<span class="content_span">'+n+"</span>"),r=$('<div class="content"></div>');if(r.append(i),n.length>32){var c=n.substr(0,30)+"...",s=$('<span class="short_content_span">'+c+"</span>");r.append(s),i.css("display","none");var d=0,l=$('<em class="more"></em>');l.bind("click",function(){d++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*d)+"deg)")}),r.append(l)}o.find(".value").append(r),$(".staff .commentAtom").remove(),$(".staff").append(o)}}function info_atom_build(t,a,e){if(""!=e){if("公司名称"==a){var o=$('<li class="atom boxSizing"><span class="label">'+a+'：</span><span class="value blue">'+e+"</span></li>");o.find(".value").bind("click",function(){location.href=apppath+"/dingtalk/account/info.action?"+ddcommparams+"&accountId="+accountId+"&from=opp_info&ropportunityId="+GetQueryString("opportunityId")})}else var o=$('<li class="atom boxSizing"><span class="label">'+a+':</span><span class="value">'+e+"</span></li>");t.append(o)}}function get_member(){$.ajax({type:"post",url:apppath+"/dingtalk/group/relateowner.action",data:{businessId:GetQueryString("opportunityId"),belongs:3},success:function(data){var oData=eval("("+data+")");if(console.log("团队成员："+data),0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else{for(var arr=[],i=0;i<oData.entity.users.length;i++)arr.push(oData.entity.users[i].name);$(".staff > .member > .value").text(arr.join(" , "))}},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function change_owner(){$(".staff .owner").bind("click",function(){$.ajax({type:"get",url:apppath+"/dingtalk/xsyuser/pager.action",async:!0,success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else if(1==oData.entity.records.length){var no_contact=$('<div class="no_contact">您的公司下暂时没有其他员工</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("转移给他人");var container=$('<div id="container" class="container ownerContainer"></div>');$(".ct").append(container),build_owner_list(container,oData)}},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})})}function build_owner_list(t,a){for(var e=0;e<a.entity.records.length;e++){if(a.entity.records[e].label==$("#infoList .owner > .value").text())var o=$('<div class="item"><em class="radio active"><i></i></em><span>'+a.entity.records[e].label+"</span></div>");else var o=$('<div class="item"><em class="radio"><i></i></em><span>'+a.entity.records[e].label+"</span></div>");t.append(o)}radio_click(a)}function radio_click(data){$(".ct .item").each(function(index){$(this).bind("click",function(){function sub(){$.ajax({url:apppath+"/dingtalk/opportunity/trans.action",data:{opportunityId:GetQueryString("opportunityId"),userId:value},beforeSend:function(){loader()},success:function(data){$(".loaderArea").remove();var oData=eval("("+data+")");setTimeout(function(){$(".ct").remove(),set_title("销售机会详情"),$("body").css({overflow:"",height:""}),$(".common").css("paddingBottom","0px"),set_right("更多",more)},2e3),1==oData.success?($(".owner > .value").text(label),get_record($("#recordList > .main"),5),myDialog("负责人更改成功")):myAlert("负责人更改失败")},error:function(){$(".loaderArea").remove(),myAlert("暂时无法获取数据，请检查您的网络")}})}$(this).find("em").hasClass("active")||($(this).find("em").addClass("active"),$(this).siblings().find("em").removeClass("active"));var value=data.entity.records[$(this).index()].value,label=data.entity.records[$(this).index()].label;doChangeOwner(label,sub)})})}function change_member(){$(".member").bind("click",function(){$.ajax({type:"get",url:apppath+"/dingtalk/xsyuser/pager.action",async:!0,success:function(data){var oData=eval("("+data+")");if(0==oData.success)myAlert("暂时无法获取数据，请稍后再试");else if(1==oData.entity.records.length){var no_contact=$('<div class="no_contact">您的公司下暂时没有其他员工</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else{checkTable("修改团队成员");var container=$('<div id="container" class="container"></div>');$(".ct").append(container),build_member_list(container,oData,apppath+"/dingtalk/group/setrelateowner.action")}},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})})}function build_member_list(t,a,e){for(var o=$("#infoList .member > .value").text().split(","),n=0;n<a.entity.records.length;n++){var i,r;if(e==apppath+"/dingtalk/group/setrelateowner.action"?(i=a.entity.records[n].label,r=a.entity.records[n].value):e==apppath+"/dingtalk/opportunity/setcontacts.action"&&(i=a.entity.records[n].contactName,r=a.entity.records[n].id),i!=ownerName){var c=$('<div class="item boxSizing"><em class="checkbox"></em><span>'+i+"</span></div>");c.attr("value",r),t.append(c)}}for(var n=0;n<contactIdArr.length;n++)for(var s=0;s<a.entity.records.length;s++)a.entity.records[s].id==contactIdArr[n]&&$(".ct .item").eq(s).find("em").addClass("active");for(var s=0;s<o.length;s++)for(var n=0;n<a.entity.records.length;n++){var i;e==apppath+"/dingtalk/group/setrelateowner.action"?i=a.entity.records[n].label:e==apppath+"/dingtalk/opportunity/setcontacts.action"&&(i=a.entity.records[n].contactName),console.log(o[s]+"+"+i),$.trim(o[s])==$(".ct .item").eq(n).find("span").text()&&$(".ct .item").eq(n).find("em").addClass("active")}checkbox_click(a),create_confirm(a,e)}function checkbox_click(t){$(".item").each(function(t){$(this).bind("click",function(){memberChange=!0,$(this).find("em").hasClass("active")?$(this).find("em").removeClass("active"):$(this).find("em").addClass("active")})})}function create_confirm(data,url){var confirm=$('<button id="confirm" class="confirm">确定</button>');$(".ct").append(confirm),confirm.bind("touchstart",function(){$(this).addClass("touching")}),confirm.bind("touchend",function(){$(this).removeClass("touching")}),confirm.bind("click",function(){var arr_value=[];$(".item").each(function(){$(this).find("em").hasClass("active")&&arr_value.push($(this).attr("value"))}),chooseData(url,arr_value),console.log(relavanceContactData),$.ajax({type:"post",url:url,data:relavanceContactData,async:!0,beforeSend:function(){loader()},success:function(data){$(".loaderArea").remove();var oData=eval("("+data+")");setTimeout(function(){$(".ct").remove(),$("body").css({height:"",overflow:""}),set_title("销售机会详情"),set_right("更多",more)},2e3),console.log("关联联系人返回："+data),1==oData.success?(myDialog("更改成功"),url==apppath+"/dingtalk/group/setrelateowner.action"?(get_record($("#recordList > .main"),5),get_member()):url==apppath+"/dingtalk/opportunity/setcontacts.action"&&($("#contactList > .main").children().remove(),get_contacts($("#contactList > .main"),5))):myAlert("更改失败")},error:function(t){myAlert("暂时无法获取数据，请检查您的网络"),$(".loaderArea").remove()}})})}function chooseData(t,a){t==apppath+"/dingtalk/group/setrelateowner.action"?relavanceContactData={businessId:Number(GetQueryString("opportunityId")),belongs:3,setOwnerIds:a.join(",")}:t==apppath+"/dingtalk/opportunity/setcontacts.action"&&(relavanceContactData={opportunityId:Number(GetQueryString("opportunityId")),contactIds:a.join(",")})}function footer_phone(){$("footer .tel").bind("click",function(){$(window).scrollTop(0),$.ajax({url:apppath+"/dingtalk/contact/dolist.action",data:{accountId:accountId,pageNo:0,pagesize:30},success:function(data){var oData=eval("("+data+")"),item=oData.entity.records,totalSize=oData.entity.totalSize;if(0==totalSize){var no_contact=$('<div class="no_contact">暂无联系人可用，请添加联系人</div>');$("body").append(no_contact),setTimeout(function(){$(".no_contact").remove()},2e3)}else{var shadow=$('<div class="tel_bg"></div>');shadow.bind("click",function(){$(".tel_bg").remove(),$("#mobile_list").remove()}),$("body").append(shadow),$(".tel_bg").css("top",$(document).scrollTop()),$(".tel_bg").fadeIn(200);for(var ul=$('<div id="mobile_list"></div>'),i=0;totalSize>i;i++){console.log(item[i]);var mobile=item[i].mobile,contactName=item[i].contactName,contactId=item[i].id,post=item[i].post,li=$('<a href="tel:'+mobile+'" class="mobile_atom"><div class="left boxSizing"><span class="name">'+contactName+'</span><span class="post">'+post+'</span></div><span class="mobile boxSizing">'+mobile+"</span></a>");li.attr("id",contactId),li.bind("click",function(){$(".tel_bg").remove(),$("#mobile_list").remove(),location.href=apppath+"/dingtalk/activityrecord/create.action?"+ddcommparams+"&belongId=3&objectId="+GetQueryString("opportunityId")+"&activityTypeId="+activeRecordTypeOje.TEL+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")}),ul.append(li)}var return_button=$('<li id="rtn_btn">取消</li>');return_button.bind("click",function(){$("body").css({overflow:"",height:""}),$(".tel_bg").remove(),$("#mobile_list").animate({bottom:-$("#mobile_list").height()},300),setTimeout(function(){$("#mobile_list").remove()},300)}),ul.append(return_button),$("body").append(ul),$("body").css({overflow:"hidden",height:"100%"}),$("#mobile_list").bind("touchmove",function(t){t.stopPropagation()}),$("#mobile_list").css({bottom:-$("#mobile_list").height()}),$("#mobile_list").animate({bottom:"0"},300)}}})})}function footer_signin(){$("footer > .signin").bind("click",function(){location.href=apppath+"/dingtalk/activityrecord/qiandao.action?"+ddcommparams+"&belongId=3&objectId="+GetQueryString("opportunityId")+"&activityTypeId="+activeRecordTypeOje.SIGN_IN+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")})}function footer_create_record(){$("footer > .record").bind("click",function(){location.href=apppath+"/dingtalk/activityrecord/create.action?"+ddcommparams+"&belongId=3&objectId="+GetQueryString("opportunityId")+"&activityTypeId="+activeRecordTypeOje.RECORD+"&from=opp_info&opportunityId="+GetQueryString("opportunityId")})}function build_end(t,a,e){var o=$('<div id="'+e+'" class="end_info">'+a+"</div>");t.append(o)}function scroll_load(t,a){var e=document.body.clientHeight;$(window).bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=e-$("#load_more").height()-50&&($("#load_more").remove(),build_end(t,"加载中…","loading"),a(t,20),$(this).unbind("scroll"),top_nav())})}$(document).bind("ready",function(){get_info($("#infoList > .main")),top_nav(),nav(),get_record($("#recordList > .main"),5);var t=setInterval(function(){null!=accountId&&(get_contacts($("#contactList > .main"),5),clearInterval(t))},300);$("body").bind("click",function(){$("#area").length>0&&$("#area").remove()}),$("body").bind("touchmove",function(){$("#area").length>0&&$("#area").remove()}),get_member(),footer_phone(),footer_signin(),footer_create_record(),stopScroll($(".shadow")),stopScroll($("#saleStage"))}),dd.ready(function(){set_right("更多",more),control_back(closeStage);var t="oppDetail";buriedPoint(t)});var accountId=null,opportunityName,opportunityType,closeDate,order,ownerId,money,dimDepart,nav_top=$("#topNav").offset().top,nav_height=$("#topNav").height(),recordPageNo=0,contactIdArr=[],contactPageNo=0,dataPermission,ownerName,memberChange=!1,relavanceContactData;