function add_opportunity(){location.href=apppath+"/dingtalk/opportunity/add.action?"+ddcommparams+"&from=opp_list"}function opp_list_back(){$("#screen_area").length>0&&"block"==$("#screen_area").css("display")?($("#screen_area").hide(),$(".screen").removeClass("active")):$("#search_ground").length>0?$("#search_ground").remove():location.href=apppath+"/dingtalk/statics/index.action?"+ddcommparams}function sort(){$(".sort").bind("click",function(){$(this).find("span").addClass("active"),$(this).siblings().find("span").removeClass("active"),0==$(this).index()?orderField="saleStageId":1==$(this).index()?orderField="money desc":2==$(this).index()&&(orderField="recentActivityRecordTime desc"),$("#list .main").children().remove(),pageNo=0,obj={pageNo:pageNo,pagesize:pageSize,saleStageId:saleStageId,closeType:closeType,money_down:min,money_up:max,desc:!1,orderField:orderField},build_common_list(apppath+"/dingtalk/opportunity/dolist.action",$("#list .main"),"暂无销售机会",build_list_unit,listScrollFunc)})}function screen(){$(".screen").bind("click",function(){if($(this).hasClass("active"))$(this).removeClass("active"),$("#screen_area").hide();else if($(this).addClass("active"),$("#screen_area").length>0)$("#screen_area").show();else{var screen=$('<div id="screen_area" class="boxSizing"></div>'),stage_screen=$('<div class="stage_screen"><div class="title boxSizing">按阶段</div><div class="con"></div></div>'),time_screen=$('<div class="time_screen"><div class="title boxSizing">结单时段</div><div class="con"></div></div>'),money_screen=$('<div class="money_screen"><div class="title boxSizing">按金额</div><div class="con"><span>金额范围（元）</span><input type="tel" maxlength="18" class="max fr"><span class="fr">-</span><input type="tel" maxlength="18" class="min fr"></div></div>'),reset=$('<div class="reset boxSizing">重置</div>'),confirm=$('<div class="confirm">确定</div>');screen.append(stage_screen),screen.append(time_screen),screen.append(money_screen),screen.append(reset),screen.append(confirm),$("body").append(screen),$.ajax({url:apppath+"/dingtalk/opportunity/getSaleStage.action",success:function(data){var oData=eval("("+data+")");if(1==oData.success)for(var i=0;i<oData.entity.length;i++){var stage_item=$('<div class="stage_item item boxSizing"><em></em><span>'+oData.entity[i].label+"</span></div>");stage_item.attr("id",oData.entity[i].value),stage_item.bind("click",function(){$(this).hasClass("active")?($(this).removeClass("active"),saleStageId=0):($(this).addClass("active"),$(this).siblings().removeClass("active"),saleStageId=Number($(this).attr("id")))}),$(".stage_screen .con").append(stage_item)}}}),$.ajax({url:apppath+"/dingtalk/opportunity/getCloseDateType.action",success:function(data){var oData=eval("("+data+")");if(1==oData.success)for(var i=0;i<oData.entity.length;i++){var time_item=$('<div class="time_item item"><span>'+oData.entity[i].desc+"</span></div>");time_item.attr("id",oData.entity[i].id),time_item.bind("click",function(){$(this).hasClass("active")?($(this).removeClass("active"),closeType=0):($(this).addClass("active"),closeType=Number($(this).attr("id")),$(this).siblings().removeClass("active"))}),$(".time_screen .con").append(time_item)}}}),$(".reset").bind("click",function(){saleStageId=0,closeType=0,min=0,max=0,$(".item").removeClass("active"),$(".money_screen input").val("")}),$(".confirm").bind("click",function(){""!=$(".min").val()&&(min=Number($(".min").val())),""!=$(".max").val()&&(max=Number($(".max").val())),console.log(min+","+max),0>min||max>9999999999?myDialog("金额范围输入错误","without"):($(".screen").removeClass("active"),$("#list .main").children().remove(),pageNo=0,obj={pageNo:pageNo,pagesize:pageSize,saleStageId:saleStageId,closeType:closeType,money_down:min,money_up:max,orderField:orderField},build_common_list(apppath+"/dingtalk/opportunity/dolist.action",$("#list .main"),"暂无销售机会",build_list_unit,listScrollFunc),$("#screen_area").hide())})}})}function search_show(){$("#search").bind("click",function(){var e="oppSearch";buriedPoint(e);var t=$('<div id="search_ground" class="boxSizing"><div class="search_area"><div class="input_area"><input id="txt" type="text" placeholder="搜索销售机会"/><div class="delete_icon"></div></div><span id="exit">取消</span></div><div id="search_content"></div></div>');$("body").append(t),$("#txt").focus(),search(),search_exit()})}function search_exit(){$("#exit").bind("click",function(){$("#search_ground").remove()})}function search(){show_history(),$("#txt").bind("change",function(){input_delete(),val=$("#txt").val()," "==val.substr(0,1)&&(val=val.trim()),""==val?($(".list").remove(),$(".dialog").remove(),show_history()):show_word(val)})}function input_delete(){""==$("#txt").val()?$(".delete_icon").hide():$(".delete_icon").show(),$(".delete_icon").bind("click",function(){$(this).hide(),$("#txt").val(""),$("#content>.list").remove(),$(".dialog").remove(),show_history()})}function show_history(){if($("#search_content").children().remove(),console.log(userId),"undefined"!=localStorage.getItem(userId)){var e=JSON.parse(localStorage.getItem(userId));console.log(e),e.opportunityHistory&&0!=e.opportunityHistory.length?create_history_list(e):create_history_null()}else create_history_null()}function create_history_list(e){if(e.opportunityHistory){if(e.opportunityHistory.length<=20)for(var t=e.opportunityHistory.length-1;t>=0;t--)build_history_list(e,t);else for(var t=e.opportunityHistory.length-1;t>=e.opportunityHistory.length-20;t--)build_history_list(e,t);create_delete()}else create_history_null()}function build_history_list(e,t){var i=document.createElement("div");i.className="boxSizing history_list";var a=e.opportunityHistory[t].name,n=e.opportunityHistory[t].id;$(i).append($('<span class="name">'+a+"</span>")),$(i).attr("id",n),$(i).attr("name",a);var o=document.createElement("div");o.innerHTML='<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NTc3MiwgMjAxNC8wMS8xMy0xOTo0NDowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTQgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDA5MDMwNDRCMkU5MTFFNUE4MDNFMkU5NkI5N0FEOEMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDA5MDMwNDVCMkU5MTFFNUE4MDNFMkU5NkI5N0FEOEMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpCMTRGRjgyMUIyRTUxMUU1QTgwM0UyRTk2Qjk3QUQ4QyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpCMTRGRjgyMkIyRTUxMUU1QTgwM0UyRTk2Qjk3QUQ4QyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Prom4REAAADHSURBVHjanNVNCoMwEAXgydAb9CJ21QvYVb2uK91rwUUPYs9gZ2ACIeTnJQNv48gHCQ91+3ZsROQkb8mP+uYumSUXG/aULLbowVYznIKT5Ct5dKAeG8yYFDwlrwBdQTTG1DjZliE6AGgS0wUHL6FoFotBBC1iKbCEVjGdW+aOPLoEKNWwEphCqYbljhzOBT6DwPjOoEpxQ8+gnnJDz6CecktpEZRbSoug3IhVUe7Aiijbl9ZjI4jl0Nkf+WNYzy/Ao2rQX4ABAORFZTtFQ9/RAAAAAElFTkSuQmCC"/>',o.className="exit",$(o).bind("click",function(){e.opportunityHistory.remove(t),localStorage.setItem(userId,JSON.stringify(e)),$(i).remove(),0==$("#search_content").find(".history_list").length&&($("#search_content > .clear").remove(),create_history_null())}),i.appendChild(o),$("#search_content").append(i),$(i).bind("click",function(){local_set($(this).attr("id"),$(this).attr("name"),3),location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("id")})}function create_delete(){var e=document.createElement("div");e.innerHTML="清除全部历史记录",e.className="clear",e.onclick=function(){var e=JSON.parse(localStorage.getItem(userId));e.opportunityHistory=[],localStorage.setItem(userId,JSON.stringify(e)),$("#search_content > .history_list").remove(),$("#search_content > .clear").remove(),create_history_null()},$("#search_content").append(e)}function create_history_null(){var e=document.createElement("div");e.innerHTML="暂无历史记录",e.className="null",$("#search_content").append(e)}function show_word(e){pageNo=0,obj={pageNo:pageNo,pagesize:pageSize,opportunityName:e},create_word_list()}function create_word_list(){$("#search_content").children().remove(),$("#search_content").append($('<div class="boxSizing main"></div>')),build_common_list(apppath+"/dingtalk/opportunity/dolist.action",$("#search_content .main"),"无相关销售机会",build_word_unit,wordScrollFunc)}function build_word_unit(e,t,i){console.log("build_word_unit");var a=$('<div class="boxSizing opportunityList">'+e.entity.records[i].opportunityName+"</div>");a.attr("value",e.entity.records[i].id),a.bind("click",function(){local_set($(this).attr("value"),$(this).html(),3),location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("value")}),t.append(a)}function wordScrollFunc(){$("#search_content").bind("scroll",function(){$("#load_more").length>0&&$("#search_content .main").offset().top<=$(window).height()-$("#search_content .main").height()+3&&($("#load_more.end_info").remove(),$("#search_content .main").append($('<div id="loading" class="end_info">加载中…</div>')),build_common_list(apppath+"/dingtalk/opportunity/dolist.action",$("#search_content .main"),"无相关销售机会",build_word_unit,wordScrollFunc))})}function build_list_unit(e,t,i){var a=e.entity.records[i],n=a.saleStageText,o=a.opportunityName,s=a.money,r=a.accountName,c=a.id,l=a.saleStageOrder,d=a.saleStagePercentage,p=$('<li class="boxSizing"><em class="icon jieduan'+l+'"></em><div class="info"><div class="top"><span class="opportunityName">'+o+'</span><span class="Money">'+s+'元</span></div><div class="bot"><p class="accountName">'+r+'</p><p class="jieduan">阶段：'+n+'</p><span class="jieduan_p">'+d+"%</span></div></div></li>");p.attr("id",c),p.attr("name",o),p.bind("click",function(){local_set($(this).attr("id"),$(this).attr("name"),3),location.href=apppath+"/dingtalk/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("id")+"&from=opp_list"}),t.append(p)}function listScrollFunc(){$("#content").bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top<=$(window).height()-$("#load_more").height()-53&&($("#load_more.end_info").remove(),$("#list .main").append($('<div id="loading" class="end_info">加载中…</div>')),build_common_list(apppath+"/dingtalk/opportunity/dolist.action",$("#list .main"),"暂无销售机会",build_list_unit,listScrollFunc))})}function local_set(e,t,i){if(1==i||2==i){var a={id:e,name:t,kindle:i};if(localStorage.getItem(userId)){var n=JSON.parse(localStorage.getItem(userId));if(n.accountHistory){for(var o=0;o<n.accountHistory.length;o++)n.accountHistory[o].id==e&&n.accountHistory.remove(o);n.accountHistory.push(a)}else var n={accountHistory:[a]}}else var n={accountHistory:[a]}}else if(3==i){var a={id:e,name:t};if("undefined"!=localStorage.getItem(userId)){var n=JSON.parse(localStorage.getItem(userId));if(n.opportunityHistory){for(var o=0;o<n.opportunityHistory.length;o++)n.opportunityHistory[o].id==e&&n.opportunityHistory.remove(o);n.opportunityHistory.push(a)}else var n={opportunityHistory:[a]}}else var n={opportunityHistory:[a]}}localStorage.setItem(userId,JSON.stringify(n))}$(document).bind("ready",function(){sort(),screen(),build_common_list(apppath+"/dingtalk/opportunity/dolist.action",$("#list .main"),"暂无销售机会",build_list_unit,listScrollFunc),set_right("新建",add_opportunity),search_show()}),dd.ready(function(){control_back(opp_list_back);var e="oppList";buriedPoint(e)});var saleStageId=0,closeType=0,min=0,max=0,pageNo=0,pageSize=20,orderField="saleStageId, updatedAt desc",obj={pageNo:pageNo,pagesize:pageSize,orderField:orderField},val=null,userId=xsyUser.id;